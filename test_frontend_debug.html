<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Debug Frontend</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { background: #f5f5f5; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #e9ecef; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .log { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
    </style>
</head>
<body>
    <h1>üîç Test Debug Frontend - Bloques de Conocimiento</h1>
    
    <div class="test-section">
        <h2>üìã Test 1: Verificar Estado de Sesi√≥n</h2>
        <button onclick="testSession()">Verificar Sesi√≥n</button>
        <div id="sessionResult"></div>
    </div>
    
    <div class="test-section">
        <h2>üì¶ Test 2: Test Directo de Bloques (sin auth)</h2>
        <button onclick="testBloquesDirecto()">Test Bloques Directo</button>
        <div id="bloquesDirectoResult"></div>
    </div>
    
    <div class="test-section">
        <h2>üîí Test 3: Test de Bloques CON Autenticaci√≥n</h2>
        <button onclick="testBloquesAuth()">Test Bloques con Auth</button>
        <div id="bloquesAuthResult"></div>
    </div>
    
    <div class="test-section">
        <h2>üåê Test 4: Test de Headers y Cookies</h2>
        <button onclick="testRequest()">Test Request Debug</button>
        <div id="requestResult"></div>
    </div>
    
    <div class="test-section">
        <h2>üìù Log de Eventos</h2>
        <button onclick="clearLog()">Limpiar Log</button>
        <div id="eventLog" class="log"></div>
    </div>

    <script>
        function logEvent(message, type = 'info') {
            const log = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            log.innerHTML += `<div style="color: ${colors[type]}; margin: 5px 0;">
                [${timestamp}] ${message}
            </div>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('eventLog').innerHTML = '';
        }
        
        function showResult(elementId, content, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.className = `test-section ${isSuccess ? 'success' : 'error'}`;
            element.innerHTML = content;
        }
        
        async function testSession() {
            logEvent('üîç Iniciando test de sesi√≥n...', 'info');
            try {
                const response = await fetch('/debug/session');
                logEvent(`üì° Response status: ${response.status}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    logEvent('‚úÖ Sesi√≥n obtenida exitosamente', 'success');
                    
                    const hasEmail = data.session_contents && data.session_contents.email;
                    const hasNora = data.session_contents && data.session_contents.nombre_nora;
                    
                    showResult('sessionResult', `
                        <h3>‚úÖ Estado de Sesi√≥n:</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                        <p><strong>Email:</strong> ${hasEmail ? '‚úÖ ' + data.session_contents.email : '‚ùå No encontrado'}</p>
                        <p><strong>Nombre Nora:</strong> ${hasNora ? '‚úÖ ' + data.session_contents.nombre_nora : '‚ùå No encontrado'}</p>
                        <p><strong>Sesi√≥n v√°lida:</strong> ${hasEmail && hasNora ? '‚úÖ S√ç' : '‚ùå NO'}</p>
                    `, hasEmail && hasNora);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                logEvent(`‚ùå Error en test de sesi√≥n: ${error.message}`, 'error');
                showResult('sessionResult', `<h3>‚ùå Error:</h3><p>${error.message}</p>`, false);
            }
        }
        
        async function testBloquesDirecto() {
            logEvent('üì¶ Iniciando test directo de bloques...', 'info');
            try {
                const response = await fetch('/debug/bloques/aura');
                logEvent(`üì° Response status: ${response.status}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    logEvent(`‚úÖ Bloques obtenidos: ${data.count}`, 'success');
                    
                    showResult('bloquesDirectoResult', `
                        <h3>‚úÖ Bloques Directos (sin auth):</h3>
                        <p><strong>Total:</strong> ${data.count} bloques</p>
                        <p><strong>Success:</strong> ${data.success}</p>
                        <pre>${JSON.stringify(data.data.slice(0, 2), null, 2)}</pre>
                    `, true);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                logEvent(`‚ùå Error en test directo: ${error.message}`, 'error');
                showResult('bloquesDirectoResult', `<h3>‚ùå Error:</h3><p>${error.message}</p>`, false);
            }
        }
        
        async function testBloquesAuth() {
            logEvent('üîí Iniciando test de bloques con auth...', 'info');
            try {
                const response = await fetch('/panel_cliente/aura/entrenar/bloques');
                logEvent(`üì° Response status: ${response.status}`, 'info');
                logEvent(`üì° Content-Type: ${response.headers.get('Content-Type')}`, 'info');
                
                if (response.status === 302) {
                    logEvent('‚ùå Redirecci√≥n detectada - problema de sesi√≥n', 'error');
                    showResult('bloquesAuthResult', `
                        <h3>‚ùå Redirecci√≥n (302)</h3>
                        <p>El servidor est√° redirigiendo, probablemente porque la sesi√≥n no es v√°lida.</p>
                        <p><strong>Location:</strong> ${response.headers.get('Location') || 'No especificado'}</p>
                    `, false);
                    return;
                }
                
                const contentType = response.headers.get('Content-Type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    logEvent(`‚úÖ Bloques con auth obtenidos: ${data.data ? data.data.length : 0}`, 'success');
                    
                    showResult('bloquesAuthResult', `
                        <h3>‚úÖ Bloques CON Auth:</h3>
                        <p><strong>Success:</strong> ${data.success}</p>
                        <p><strong>Total:</strong> ${data.data ? data.data.length : 0} bloques</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `, data.success);
                } else {
                    const text = await response.text();
                    logEvent('‚ùå Respuesta no es JSON', 'error');
                    showResult('bloquesAuthResult', `
                        <h3>‚ùå Respuesta no es JSON</h3>
                        <p><strong>Content-Type:</strong> ${contentType}</p>
                        <p><strong>Contenido:</strong></p>
                        <pre>${text.substring(0, 500)}</pre>
                    `, false);
                }
            } catch (error) {
                logEvent(`‚ùå Error en test con auth: ${error.message}`, 'error');
                showResult('bloquesAuthResult', `<h3>‚ùå Error:</h3><p>${error.message}</p>`, false);
            }
        }
        
        async function testRequest() {
            logEvent('üåê Iniciando test de request debug...', 'info');
            try {
                const response = await fetch('/debug/request');
                logEvent(`üì° Response status: ${response.status}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    logEvent('‚úÖ Request debug obtenido', 'success');
                    
                    showResult('requestResult', `
                        <h3>‚úÖ Debug de Request:</h3>
                        <h4>Cookies:</h4>
                        <pre>${JSON.stringify(data.cookies, null, 2)}</pre>
                        <h4>Estado de Login:</h4>
                        <pre>${JSON.stringify(data.login_status, null, 2)}</pre>
                        <h4>Headers (seleccionados):</h4>
                        <pre>User-Agent: ${data.user_agent}
Cookie: ${data.headers.Cookie || 'No cookie header'}
Referer: ${data.headers.Referer || 'No referer'}</pre>
                    `, true);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                logEvent(`‚ùå Error en test de request: ${error.message}`, 'error');
                showResult('requestResult', `<h3>‚ùå Error:</h3><p>${error.message}</p>`, false);
            }
        }
        
        // Auto-ejecutar tests al cargar la p√°gina
        window.onload = function() {
            logEvent('üöÄ P√°gina de debug cargada', 'info');
            logEvent('üìã Ejecutar los tests en orden para diagnosticar el problema', 'info');
        };
    </script>
</body>
</html>
