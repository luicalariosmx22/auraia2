<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 Test de Funciones de Conocimiento</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">🔍 Test de Funciones de Conocimiento</h1>
            
            <div class="mb-6">
                <button id="test-functions" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    🧪 Test Funciones
                </button>
                <button id="test-format" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    📅 Test Formato
                </button>
                <button id="test-create-block" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                    📚 Test Crear Bloque
                </button>
            </div>
            
            <div id="test-container" class="space-y-4">
                <!-- Los resultados aparecerán aquí -->
            </div>
            
            <div id="block-container" class="mt-6">
                <!-- Los bloques de prueba aparecerán aquí -->
            </div>
        </div>
    </div>

    <!-- Cargar los scripts necesarios -->
    <script src="/static/js/ui-utils.js"></script>
    <script src="/static/js/conocimiento-manager.js"></script>

    <script>
        // Simular configuración
        window.PANEL_CONFIG = {
            nombreNora: 'aura',
            context: 'cliente',
            endpoints: {
                bloques: '/panel_cliente/aura/entrenar/bloques'
            }
        };

        function addTestResult(message, type = 'info') {
            const container = document.getElementById('test-container');
            const colors = {
                'info': 'bg-blue-100 text-blue-800',
                'success': 'bg-green-100 text-green-800',
                'error': 'bg-red-100 text-red-800'
            };
            
            container.innerHTML += `<div class="p-3 rounded ${colors[type] || colors.info}">${message}</div>`;
        }

        document.getElementById('test-functions').addEventListener('click', function() {
            document.getElementById('test-container').innerHTML = '';
            
            // Test funciones básicas
            addTestResult('🔍 Probando funciones básicas...');
            
            if (typeof window.escapeHtml === 'function') {
                const testHtml = '&lt;script&gt;alert("xss")&lt;/script&gt;';
                const escaped = window.escapeHtml('&lt;script&gt;alert("xss")&lt;/script&gt;');
                addTestResult(`✅ escapeHtml funciona correctamente`, 'success');
            } else {
                addTestResult('❌ escapeHtml no está disponible', 'error');
            }
            
            if (typeof window.formatDate === 'function') {
                const testDate = new Date().toISOString();
                const formatted = window.formatDate(testDate);
                addTestResult(`✅ formatDate: "${testDate}" → "${formatted}"`, 'success');
            } else {
                addTestResult('❌ formatDate no está disponible', 'error');
            }
            
            if (typeof window.crearElementoBloque === 'function') {
                addTestResult('✅ crearElementoBloque está disponible', 'success');
            } else {
                addTestResult('❌ crearElementoBloque no está disponible', 'error');
            }
            
            if (typeof window.mostrarConocimiento === 'function') {
                addTestResult('✅ mostrarConocimiento está disponible', 'success');
            } else {
                addTestResult('❌ mostrarConocimiento no está disponible', 'error');
            }
        });

        document.getElementById('test-format').addEventListener('click', function() {
            document.getElementById('test-container').innerHTML = '';
            
            addTestResult('📅 Probando formato de fechas...');
            
            const fechas = [
                new Date().toISOString(),
                '2025-06-28T10:30:00Z',
                '2025-06-28T10:30:00.000Z',
                null,
                undefined,
                'fecha-inválida'
            ];
            
            fechas.forEach(fecha => {
                try {
                    const resultado = window.formatDate ? window.formatDate(fecha) : 'formatDate no disponible';
                    addTestResult(`📅 "${fecha}" → "${resultado}"`, 'info');
                } catch (error) {
                    addTestResult(`❌ Error con "${fecha}": ${error.message}`, 'error');
                }
            });
        });

        document.getElementById('test-create-block').addEventListener('click', function() {
            document.getElementById('block-container').innerHTML = '';
            
            addTestResult('📚 Probando creación de bloques...');
            
            const bloquesPrueba = [
                {
                    id: 'test-1',
                    contenido: 'Este es un bloque de prueba con contenido normal.',
                    etiquetas: ['test', 'prueba'],
                    prioridad: false,
                    fecha_creacion: new Date().toISOString()
                },
                {
                    id: 'test-2',
                    contenido: 'Bloque prioritario con contenido de prueba especial.',
                    etiquetas: ['prioritario', 'test'],
                    prioridad: true,
                    fecha_creacion: '2025-06-28T10:30:00Z'
                }
            ];
            
            try {
                if (typeof window.crearElementoBloque === 'function') {
                    const html = bloquesPrueba.map(bloque => window.crearElementoBloque(bloque)).join('');
                    document.getElementById('block-container').innerHTML = html;
                    addTestResult('✅ Bloques creados exitosamente', 'success');
                } else {
                    addTestResult('❌ crearElementoBloque no está disponible', 'error');
                }
            } catch (error) {
                addTestResult(`❌ Error creando bloques: ${error.message}`, 'error');
                console.error('Error detallado:', error);
            }
        });

        // Placeholder functions
        window.editarBloque = function(id) {
            alert('Editar bloque: ' + id);
        };
        
        window.eliminarBloque = function(id) {
            alert('Eliminar bloque: ' + id);
        };

        // Auto-test al cargar
        setTimeout(() => {
            document.getElementById('test-functions').click();
        }, 1000);
    </script>
</body>
</html>
