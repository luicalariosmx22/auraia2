<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>üîç Diagn√≥stico Completo - Base de Conocimiento</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1000px; 
            margin: 0 auto; 
            background: #f5f5f5;
        }
        .card { 
            background: white; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #28a745; background: #d4edda; }
        .error { color: #dc3545; background: #f8d7da; }
        .warning { color: #856404; background: #fff3cd; }
        .info { color: #0c5460; background: #d1ecf1; }
        .result { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-family: monospace;
            white-space: pre-wrap;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .step { 
            border-left: 4px solid #007bff; 
            padding-left: 15px; 
            margin: 20px 0;
        }
        .step h3 { margin-top: 0; color: #007bff; }
        .bloque {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .etiqueta {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            margin: 2px;
            border-radius: 3px;
            font-size: 12px;
            display: inline-block;
        }
        #log { 
            max-height: 300px; 
            overflow-y: auto; 
            font-size: 12px;
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico Completo - Base de Conocimiento</h1>
    <p><strong>Objetivo:</strong> Identificar por qu√© la base de conocimiento muestra "Cargando..." permanentemente</p>

    <div class="card">
        <h2>üöÄ Control de Pruebas</h2>
        <button onclick="probarTodo()" class="btn-primary">üîç Ejecutar Diagn√≥stico Completo</button>
        <button onclick="probarServidor()" class="btn-success">üåê Probar Servidor</button>
        <button onclick="probarEndpoint()" class="btn-warning">üì° Probar Endpoint</button>
        <button onclick="simularFrontend()" class="btn-danger">üß™ Simular Frontend</button>
        <button onclick="limpiarLog()" class="btn-secondary" style="background: #6c757d; color: white;">üóëÔ∏è Limpiar</button>
    </div>

    <div class="card">
        <h2>üìã Log de Diagn√≥stico</h2>
        <div id="log"></div>
    </div>

    <div class="card">
        <h2>üìä Resultados</h2>
        <div id="resultados"></div>
    </div>

    <div class="card">
        <h2>üìö Bloques de Conocimiento</h2>
        <div id="bloques"></div>
    </div>

    <script>
        function log(mensaje, tipo = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const emoji = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è'
            };
            
            logDiv.innerHTML += `[${timestamp}] ${emoji[tipo]} ${mensaje}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function mostrarResultado(titulo, contenido, tipo = 'info') {
            const div = document.createElement('div');
            div.className = `result ${tipo}`;
            div.innerHTML = `<strong>${titulo}</strong>\n${contenido}`;
            document.getElementById('resultados').appendChild(div);
        }

        function limpiarLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('resultados').innerHTML = '';
            document.getElementById('bloques').innerHTML = '';
        }

        async function probarServidor() {
            log('üåê Probando si el servidor Flask est√° ejecut√°ndose...');
            
            try {
                const response = await fetch('/', { method: 'HEAD' });
                log(`Servidor responde: ${response.status}`, 'success');
                mostrarResultado('Estado del Servidor', `‚úÖ Servidor Flask ejecut√°ndose\nStatus: ${response.status}`, 'success');
                return true;
            } catch (error) {
                log(`Error conectando al servidor: ${error.message}`, 'error');
                mostrarResultado('Estado del Servidor', `‚ùå Servidor no responde\nError: ${error.message}`, 'error');
                return false;
            }
        }

        async function probarEndpoint() {
            log('üì° Probando endpoint de conocimiento...');
            
            const endpoints = [
                '/admin/nora/aura/entrenar/bloques',
                '/admin/nora/aura/test-db',
                '/api/debug/aura/bloques'
            ];

            for (const endpoint of endpoints) {
                try {
                    log(`Probando: ${endpoint}`);
                    const response = await fetch(endpoint);
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(`‚úÖ ${endpoint} responde correctamente`, 'success');
                        
                        if (data.success && data.data) {
                            log(`   üìä ${data.data.length} bloques encontrados`, 'success');
                            mostrarResultado(`Endpoint: ${endpoint}`, 
                                `‚úÖ Funcionando correctamente\nBloques: ${data.data.length}\nData: ${JSON.stringify(data, null, 2)}`, 'success');
                            return { endpoint, data };
                        } else {
                            log(`   ‚ö†Ô∏è Success=false: ${data.message}`, 'warning');
                            mostrarResultado(`Endpoint: ${endpoint}`, 
                                `‚ö†Ô∏è Responde pero success=false\nMensaje: ${data.message}`, 'warning');
                        }
                    } else {
                        log(`   ‚ùå Error ${response.status}: ${response.statusText}`, 'error');
                        const text = await response.text();
                        mostrarResultado(`Endpoint: ${endpoint}`, 
                            `‚ùå Error HTTP ${response.status}\nRespuesta: ${text.substring(0, 200)}...`, 'error');
                    }
                } catch (error) {
                    log(`   ‚ùå Error: ${error.message}`, 'error');
                    mostrarResultado(`Endpoint: ${endpoint}`, 
                        `‚ùå Error de conexi√≥n\nError: ${error.message}`, 'error');
                }
            }
            
            return null;
        }

        async function simularFrontend() {
            log('üß™ Simulando exactamente el c√≥digo del frontend...');
            
            try {
                // Exactamente como en el frontend
                const nombreNora = 'aura';
                const endpoint = `/admin/nora/${nombreNora}/entrenar/bloques`;
                
                log(`Frontend usar√≠a: ${endpoint}`);
                
                const response = await fetch(endpoint);
                log(`Response status: ${response.status}`);
                log(`Response ok: ${response.ok}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }
                
                const resultado = await response.json();
                log(`Resultado completo: ${JSON.stringify(resultado, null, 2)}`);
                
                if (resultado.success && resultado.data) {
                    log(`‚úÖ Frontend deber√≠a cargar ${resultado.data.length} bloques`, 'success');
                    mostrarBloques(resultado.data);
                    mostrarResultado('Simulaci√≥n Frontend', 
                        `‚úÖ El frontend DEBER√çA funcionar correctamente\nBloques: ${resultado.data.length}`, 'success');
                } else {
                    log(`‚ùå Frontend fallar√≠a: ${resultado.message}`, 'error');
                    mostrarResultado('Simulaci√≥n Frontend', 
                        `‚ùå Frontend fallar√≠a\nMotivo: ${resultado.message}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Frontend fallar√≠a con error: ${error.message}`, 'error');
                mostrarResultado('Simulaci√≥n Frontend', 
                    `‚ùå Frontend fallar√≠a\nError: ${error.message}\n\nEsto explicar√≠a el "Cargando..." permanente`, 'error');
            }
        }

        function mostrarBloques(bloques) {
            const container = document.getElementById('bloques');
            
            if (bloques.length === 0) {
                container.innerHTML = '<p>üìö No hay bloques de conocimiento</p>';
                return;
            }
            
            container.innerHTML = '<h3>üìö Bloques de Conocimiento Encontrados:</h3>';
            
            bloques.forEach((bloque, index) => {
                const div = document.createElement('div');
                div.className = 'bloque';
                
                div.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 10px;">
                        ${bloque.prioridad ? '‚≠ê ' : ''}${index + 1}. ID: ${bloque.id ? bloque.id.substring(0, 8) + '...' : 'N/A'}
                        <span style="float: right; font-size: 12px; color: #666;">
                            ${bloque.fecha_creacion ? new Date(bloque.fecha_creacion).toLocaleString() : 'N/A'}
                        </span>
                    </div>
                    <div style="margin-bottom: 10px;">${bloque.contenido || 'Sin contenido'}</div>
                    <div>
                        ${(bloque.etiquetas || []).map(tag => `<span class="etiqueta">${tag}</span>`).join('')}
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        async function probarTodo() {
            limpiarLog();
            log('üöÄ Iniciando diagn√≥stico completo...', 'info');
            
            // Paso 1: Servidor
            const servidorOk = await probarServidor();
            if (!servidorOk) {
                log('‚ùå DIAGN√ìSTICO DETENIDO: Servidor no responde', 'error');
                mostrarResultado('DIAGN√ìSTICO FINAL', 
                    '‚ùå PROBLEMA ENCONTRADO: El servidor Flask no est√° ejecut√°ndose\n\nSOLUCI√ìN: Ejecutar "python dev_start.py"', 'error');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000)); // Pausa
            
            // Paso 2: Endpoints
            const endpointData = await probarEndpoint();
            if (!endpointData) {
                log('‚ùå DIAGN√ìSTICO: Ning√∫n endpoint funciona correctamente', 'error');
                mostrarResultado('DIAGN√ìSTICO FINAL', 
                    '‚ùå PROBLEMA ENCONTRADO: Los endpoints no responden correctamente\n\nPOSIBLES CAUSAS:\n- Problema de autenticaci√≥n\n- Variables de entorno incorrectas\n- Error en el c√≥digo del backend', 'error');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000)); // Pausa
            
            // Paso 3: Simulaci√≥n frontend
            await simularFrontend();
            
            // Conclusi√≥n
            log('üéâ DIAGN√ìSTICO COMPLETADO', 'success');
            mostrarResultado('DIAGN√ìSTICO FINAL', 
                `‚úÖ DIAGN√ìSTICO COMPLETADO\n\nSi ves bloques aqu√≠ pero el frontend sigue en "Cargando...":\n\n1. Abrir consola del navegador (F12) en el panel de entrenamiento\n2. Buscar errores JavaScript\n3. Verificar que los logs de cargarConocimiento() aparecen\n4. Verificar que el template {{ nombre_nora }} se expande correctamente\n\nSi NO ves bloques aqu√≠: el problema est√° en el backend/base de datos.`, 'info');
        }

        // Ejecutar autom√°ticamente al cargar
        document.addEventListener('DOMContentLoaded', function() {
            log('üîß P√°gina de diagn√≥stico cargada', 'info');
            log('üëÜ Haz clic en "Ejecutar Diagn√≥stico Completo" para comenzar', 'info');
        });
    </script>
</body>
</html>
