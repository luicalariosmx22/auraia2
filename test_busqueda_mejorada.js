/**
 * Script de prueba para las mejoras del sistema de b√∫squeda de conocimiento
 * Carga este archivo en la consola del navegador en el panel de entrenamiento
 */

console.log('üß™ INICIANDO PRUEBA DE B√öSQUEDA MEJORADA');
console.log('=' * 50);

// Funci√≥n principal de prueba de b√∫squeda
async function probarBusquedaMejorada() {
    try {
        console.log('1Ô∏è‚É£ Verificando funciones de b√∫squeda...');
        
        const funcionesBusqueda = [
            'filtrarConocimiento',
            'limpiarBusqueda', 
            'busquedaAvanzada',
            'mostrarTodosLosBloques',
            'actualizarOpcionesDropdown',
            'actualizarEstadoFiltros',
            'filtrarPorEtiqueta'
        ];
        
        const funcionesDisponibles = [];
        const funcionesFaltantes = [];
        
        funcionesBusqueda.forEach(func => {
            if (typeof window[func] === 'function') {
                funcionesDisponibles.push(func);
            } else {
                funcionesFaltantes.push(func);
            }
        });
        
        console.log(`‚úÖ Funciones disponibles: ${funcionesDisponibles.join(', ')}`);
        if (funcionesFaltantes.length > 0) {
            console.log(`‚ùå Funciones faltantes: ${funcionesFaltantes.join(', ')}`);
        }
        
        // 2. Cargar datos si es necesario
        console.log('\n2Ô∏è‚É£ Verificando datos de conocimiento...');
        
        if (!window.conocimientoData || window.conocimientoData.length === 0) {
            console.log('üì• Cargando datos de conocimiento...');
            if (typeof window.cargarConocimiento === 'function') {
                await window.cargarConocimiento();
            }
        }
        
        if (window.conocimientoData && window.conocimientoData.length > 0) {
            console.log(`‚úÖ Datos disponibles: ${window.conocimientoData.length} bloques`);
            
            // Analizar etiquetas disponibles
            const etiquetas = new Set();
            window.conocimientoData.forEach(bloque => {
                (bloque.etiquetas || []).forEach(e => etiquetas.add(e));
            });
            
            console.log(`üè∑Ô∏è Etiquetas disponibles: ${Array.from(etiquetas).join(', ')}`);
            
        } else {
            console.log('‚ùå No hay datos de conocimiento disponibles');
            return;
        }
        
        // 3. Probar b√∫squeda de texto
        console.log('\n3Ô∏è‚É£ Probando b√∫squeda de texto...');
        await probarBusquedaTexto();
        
        // 4. Probar filtro por etiquetas
        console.log('\n4Ô∏è‚É£ Probando filtro por etiquetas...');
        await probarFiltroEtiquetas();
        
        // 5. Probar funciones de limpieza
        console.log('\n5Ô∏è‚É£ Probando funciones de limpieza...');
        await probarLimpieza();
        
        // 6. Probar b√∫squeda avanzada
        console.log('\n6Ô∏è‚É£ Probando b√∫squeda avanzada...');
        await probarBusquedaAvanzadaCompleta();
        
        console.log('\nüéâ PRUEBA DE B√öSQUEDA COMPLETADA');
        
    } catch (error) {
        console.error('‚ùå Error durante la prueba de b√∫squeda:', error);
    }
}

// Funci√≥n para probar b√∫squeda de texto
async function probarBusquedaTexto() {
    const terminos = [
        'curso',
        'inteligencia artificial', 
        'presencial',
        'duraci√≥n',
        'costo',
        'm√≥dulo',
        'julio',
        'AI' // t√©rmino que podr√≠a no encontrar resultados
    ];
    
    console.log('üîç Probando t√©rminos de b√∫squeda...');
    
    for (const termino of terminos) {
        console.log(`\n   Buscando: "${termino}"`);
        
        // Simular b√∫squeda
        if (typeof window.filtrarConocimiento === 'function') {
            window.filtrarConocimiento(termino);
            
            // Contar resultados visibles
            await new Promise(resolve => setTimeout(resolve, 100)); // Esperar renderizado
            
            const bloquesVisibles = document.querySelectorAll('.bloque-conocimiento:not([style*="display: none"])');
            console.log(`     Resultados: ${bloquesVisibles.length} bloques`);
            
        } else {
            console.log('     ‚ùå Funci√≥n filtrarConocimiento no disponible');
        }
    }
    
    // Limpiar b√∫squeda al final
    if (typeof window.limpiarBusqueda === 'function') {
        window.limpiarBusqueda();
        console.log('‚úÖ B√∫squeda limpiada');
    }
}

// Funci√≥n para probar filtro por etiquetas
async function probarFiltroEtiquetas() {
    // Obtener etiquetas disponibles
    const etiquetasDisponibles = new Set();
    if (window.conocimientoData) {
        window.conocimientoData.forEach(bloque => {
            (bloque.etiquetas || []).forEach(e => etiquetasDisponibles.add(e));
        });
    }
    
    const etiquetas = Array.from(etiquetasDisponibles);
    console.log(`üè∑Ô∏è Probando filtros con ${etiquetas.length} etiquetas...`);
    
    for (const etiqueta of etiquetas.slice(0, 3)) { // Probar solo las primeras 3
        console.log(`\n   Filtrando por: "${etiqueta}"`);
        
        if (typeof window.filtrarPorEtiqueta === 'function') {
            window.filtrarPorEtiqueta(etiqueta);
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const bloquesVisibles = document.querySelectorAll('.bloque-conocimiento:not([style*="display: none"])');
            console.log(`     Resultados: ${bloquesVisibles.length} bloques`);
            
        } else {
            console.log('     ‚ùå Funci√≥n filtrarPorEtiqueta no disponible');
        }
    }
    
    // Probar "mostrar todas"
    console.log('\n   Filtrando por: "todas"');
    if (typeof window.filtrarPorEtiqueta === 'function') {
        window.filtrarPorEtiqueta(null);
        console.log('     ‚úÖ Filtro "todas" aplicado');
    }
}

// Funci√≥n para probar limpieza
async function probarLimpieza() {
    console.log('üßπ Probando funciones de limpieza...');
    
    // Aplicar una b√∫squeda primero
    if (typeof window.filtrarConocimiento === 'function') {
        window.filtrarConocimiento('curso');
        console.log('   üìù B√∫squeda aplicada: "curso"');
        
        await new Promise(resolve => setTimeout(resolve, 200));
        
        // Limpiar
        if (typeof window.limpiarBusqueda === 'function') {
            window.limpiarBusqueda();
            console.log('   ‚úÖ B√∫squeda limpiada');
            
            // Verificar que el input est√° limpio
            const buscarInput = document.getElementById('buscar-conocimiento');
            if (buscarInput && buscarInput.value === '') {
                console.log('   ‚úÖ Input de b√∫squeda limpio');
            } else {
                console.log('   ‚ö†Ô∏è Input de b√∫squeda no est√° limpio');
            }
            
        } else {
            console.log('   ‚ùå Funci√≥n limpiarBusqueda no disponible');
        }
    }
    
    // Probar mostrar todos los bloques
    if (typeof window.mostrarTodosLosBloques === 'function') {
        window.mostrarTodosLosBloques();
        console.log('   ‚úÖ Funci√≥n mostrarTodosLosBloques ejecutada');
    }
}

// Funci√≥n para probar b√∫squeda avanzada
async function probarBusquedaAvanzadaCompleta() {
    console.log('üî¨ Probando b√∫squeda avanzada...');
    
    const terminosAvanzados = [
        'inteligencia artificial',
        'curso presencial',
        'duraci√≥n costo'
    ];
    
    for (const termino of terminosAvanzados) {
        console.log(`\n   B√∫squeda avanzada: "${termino}"`);
        
        if (typeof window.busquedaAvanzada === 'function') {
            const resultados = window.busquedaAvanzada(termino);
            console.log(`     Resultados: ${resultados.length} bloques`);
            
            if (resultados.length > 0) {
                console.log(`     Primer resultado relevancia: ${resultados[0].relevancia || 'N/A'}`);
            }
            
        } else {
            console.log('     ‚ùå Funci√≥n busquedaAvanzada no disponible');
        }
    }
}

// Funci√≥n para probar interacciones con elementos del DOM
function probarInteraccionesDOM() {
    console.log('\n7Ô∏è‚É£ Probando interacciones con DOM...');
    
    // Probar input de b√∫squeda
    const buscarInput = document.getElementById('buscar-conocimiento');
    if (buscarInput) {
        console.log('   ‚úÖ Input de b√∫squeda encontrado');
        
        // Simular escritura
        buscarInput.value = 'inteligencia artificial';
        buscarInput.dispatchEvent(new Event('input'));
        console.log('   ‚úÖ Evento input simulado');
        
        // Simular Enter
        buscarInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
        console.log('   ‚úÖ Evento Enter simulado');
        
        // Simular Escape
        setTimeout(() => {
            buscarInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Escape' }));
            console.log('   ‚úÖ Evento Escape simulado');
        }, 1000);
        
    } else {
        console.log('   ‚ùå Input de b√∫squeda no encontrado');
    }
    
    // Probar dropdown de filtros
    const filtroEtiqueta = document.getElementById('filtro-etiqueta');
    if (filtroEtiqueta) {
        console.log('   ‚úÖ Dropdown de filtros encontrado');
        console.log(`   üìä Opciones disponibles: ${filtroEtiqueta.options.length}`);
        
        // Mostrar algunas opciones
        for (let i = 0; i < Math.min(3, filtroEtiqueta.options.length); i++) {
            console.log(`     - ${filtroEtiqueta.options[i].text}`);
        }
        
    } else {
        console.log('   ‚ùå Dropdown de filtros no encontrado');
    }
}

// Funci√≥n para generar reporte de prueba
function generarReportePrueba() {
    console.log('\nüìä REPORTE DE PRUEBA DE B√öSQUEDA');
    console.log('=' * 40);
    
    const reporte = {
        timestamp: new Date().toISOString(),
        funcionesDisponibles: [],
        elementosDOM: {},
        datosConocimiento: {
            total: window.conocimientoData ? window.conocimientoData.length : 0,
            etiquetas: 0,
            bloquesIA: 0
        }
    };
    
    // Verificar funciones
    const funciones = ['filtrarConocimiento', 'limpiarBusqueda', 'busquedaAvanzada', 'filtrarPorEtiqueta'];
    funciones.forEach(func => {
        if (typeof window[func] === 'function') {
            reporte.funcionesDisponibles.push(func);
        }
    });
    
    // Verificar elementos DOM
    const elementos = ['buscar-conocimiento', 'filtro-etiqueta', 'conocimiento-list'];
    elementos.forEach(id => {
        reporte.elementosDOM[id] = document.getElementById(id) !== null;
    });
    
    // Analizar datos
    if (window.conocimientoData) {
        const etiquetas = new Set();
        let bloquesIA = 0;
        
        window.conocimientoData.forEach(bloque => {
            (bloque.etiquetas || []).forEach(e => etiquetas.add(e));
            if (bloque.etiquetas && bloque.etiquetas.some(e => 
                e.toLowerCase().includes('inteligencia') || e.toLowerCase().includes('artificial')
            )) {
                bloquesIA++;
            }
        });
        
        reporte.datosConocimiento.etiquetas = etiquetas.size;
        reporte.datosConocimiento.bloquesIA = bloquesIA;
    }
    
    console.log('üìã Funciones disponibles:', reporte.funcionesDisponibles.join(', '));
    console.log('üñ•Ô∏è Elementos DOM:', Object.entries(reporte.elementosDOM).map(([k,v]) => `${k}: ${v ? '‚úÖ' : '‚ùå'}`).join(', '));
    console.log('üìä Datos:', `${reporte.datosConocimiento.total} bloques, ${reporte.datosConocimiento.etiquetas} etiquetas, ${reporte.datosConocimiento.bloquesIA} bloques IA`);
    
    return reporte;
}

// Exportar funciones
window.probarBusquedaMejorada = probarBusquedaMejorada;
window.probarBusquedaTexto = probarBusquedaTexto;
window.probarFiltroEtiquetas = probarFiltroEtiquetas;
window.probarInteraccionesDOM = probarInteraccionesDOM;
window.generarReportePrueba = generarReportePrueba;

// Ejecutar autom√°ticamente si estamos en el panel
if (document.getElementById('buscar-conocimiento')) {
    console.log('üéØ Panel de b√∫squeda detectado - ejecutando prueba autom√°tica');
    setTimeout(() => {
        probarBusquedaMejorada().then(() => {
            probarInteraccionesDOM();
            const reporte = generarReportePrueba();
            console.log('\nüéâ PRUEBA COMPLETA FINALIZADA');
        });
    }, 2000);
} else {
    console.log('üìù Para ejecutar la prueba manualmente, usa: probarBusquedaMejorada()');
    console.log('üìù Para probar interacciones DOM, usa: probarInteraccionesDOM()');
    console.log('üìù Para generar reporte, usa: generarReportePrueba()');
}
