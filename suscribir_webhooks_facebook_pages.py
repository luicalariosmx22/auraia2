#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Script para suscribir webhooks en todas las p√°ginas de Facebook
Similar al sistema de Meta Ads pero para Facebook Pages
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

import requests
from datetime import datetime
from dotenv import load_dotenv
from clientes.aura.utils.supabase_client import supabase

# üóÑÔ∏è CONTEXTO BD PARA GITHUB COPILOT
from clientes.aura.utils.supabase_schemas import SUPABASE_SCHEMAS
from clientes.aura.utils.quick_schemas import existe, columnas

# Cargar variables de entorno
load_dotenv()

def obtener_access_token():
    """Obtiene el access token desde variables de entorno"""
    access_token = os.getenv('META_ACCESS_TOKEN')
    
    if not access_token:
        print("‚ùå No se encontr√≥ META_ACCESS_TOKEN en las variables de entorno")
        print("üí° Configura tu token con:")
        print("   export META_ACCESS_TOKEN='tu_token_aqui'")
        return None
    
    return access_token

def obtener_webhook_url():
    """Obtiene la URL del webhook desde variables de entorno"""
    webhook_url = os.getenv('META_WEBHOOK_URL')
    
    if not webhook_url:
        print("‚ùå No se encontr√≥ META_WEBHOOK_URL en las variables de entorno")
        print("üí° Ejemplo: META_WEBHOOK_URL='https://tu-dominio.com/meta/webhook'")
        return None
    
    return webhook_url

def obtener_verify_token():
    """Obtiene el verify token desde variables de entorno"""
    verify_token = os.getenv('META_WEBHOOK_VERIFY_TOKEN')
    
    if not verify_token:
        print("‚ùå No se encontr√≥ META_WEBHOOK_VERIFY_TOKEN en las variables de entorno")
        print("üí° Ejemplo: META_WEBHOOK_VERIFY_TOKEN='tu_verify_token_secreto'")
        return None
    
    return verify_token

def obtener_page_access_token(page_id, user_access_token):
    """
    Obtiene el Page Access Token para una p√°gina espec√≠fica
    
    Args:
        page_id (str): ID de la p√°gina de Facebook
        user_access_token (str): User Access Token
        
    Returns:
        str: Page Access Token o None si hay error
    """
    try:
        url = f"https://graph.facebook.com/v19.0/me/accounts"
        params = {
            'access_token': user_access_token,
            'fields': 'id,name,access_token'
        }
        
        response = requests.get(url, params=params, timeout=15)
        
        if response.status_code == 200:
            data = response.json()
            pages = data.get('data', [])
            
            # Buscar la p√°gina espec√≠fica
            for page in pages:
                if page.get('id') == page_id:
                    return page.get('access_token')
            
            print(f"‚ö†Ô∏è No se encontr√≥ Page Access Token para p√°gina {page_id}")
            return None
        else:
            print(f"‚ùå Error obteniendo Page Access Token: {response.status_code}")
            return None
            
    except Exception as e:
        print(f"‚ùå Error obteniendo Page Access Token para {page_id}: {e}")
        return None

def suscribir_webhook_pagina(page_id, user_access_token, webhook_url, verify_token):
    """
    Suscribe webhook para una p√°gina espec√≠fica de Facebook
    
    Args:
        page_id (str): ID de la p√°gina de Facebook
        user_access_token (str): User Access Token de Meta
        webhook_url (str): URL del webhook endpoint
        verify_token (str): Token de verificaci√≥n
        
    Returns:
        dict: Resultado de la suscripci√≥n
    """
    try:
        print(f"üì° Suscribiendo webhook para p√°gina: {page_id}")
        
        # Primero obtener el Page Access Token
        page_access_token = obtener_page_access_token(page_id, user_access_token)
        
        if not page_access_token:
            return {
                'success': False,
                'page_id': page_id,
                'error': 'No se pudo obtener Page Access Token'
            }
        
        print(f"‚úÖ Page Access Token obtenido para p√°gina {page_id}")
        
        # URL para suscribir webhook en la p√°gina
        url = f"https://graph.facebook.com/v19.0/{page_id}/subscribed_apps"
        
        # Datos de la suscripci√≥n - usando campos b√°sicos que no requieren permisos especiales
        # Empezamos con campos b√°sicos que deber√≠an funcionar con los permisos actuales
        data = {
            'access_token': page_access_token,
            'subscribed_fields': 'feed'  # Empezar solo con feed que es el m√°s b√°sico
        }
        
        # Realizar la suscripci√≥n
        response = requests.post(url, data=data, timeout=30)
        
        if response.status_code == 200:
            result = response.json()
            if result.get('success', False):
                print(f"‚úÖ Webhook suscrito exitosamente para p√°gina {page_id}")
                return {
                    'success': True,
                    'page_id': page_id,
                    'message': 'Webhook suscrito correctamente'
                }
            else:
                print(f"‚ö†Ô∏è Respuesta inesperada para p√°gina {page_id}: {result}")
                return {
                    'success': False,
                    'page_id': page_id,
                    'error': 'Respuesta inesperada de la API'
                }
        else:
            try:
                error_data = response.json() if response.headers.get('content-type', '').startswith('application/json') else {'message': response.text}
                if isinstance(error_data, dict) and 'error' in error_data:
                    if isinstance(error_data['error'], dict):
                        error_msg = error_data['error'].get('message', response.text)
                    else:
                        error_msg = str(error_data['error'])
                else:
                    error_msg = response.text
            except:
                error_msg = response.text
            
            print(f"‚ùå Error suscribiendo webhook para p√°gina {page_id}: {response.status_code}")
            print(f"   Detalles: {error_data}")
            return {
                'success': False,
                'page_id': page_id,
                'error': f"HTTP {response.status_code}: {error_msg}"
            }
            
    except requests.exceptions.Timeout:
        error_msg = f"Timeout suscribiendo webhook para p√°gina {page_id}"
        print(f"‚è∞ {error_msg}")
        return {
            'success': False,
            'page_id': page_id,
            'error': 'Timeout en la solicitud'
        }
    except Exception as e:
        error_msg = f"Error inesperado suscribiendo webhook para p√°gina {page_id}: {e}"
        print(f"‚ùå {error_msg}")
        return {
            'success': False,
            'page_id': page_id,
            'error': str(e)
        }

def verificar_webhook_pagina(page_id, user_access_token):
    """
    Verifica si una p√°gina tiene webhooks suscritos
    
    Args:
        page_id (str): ID de la p√°gina de Facebook
        user_access_token (str): User Access Token de Meta
        
    Returns:
        bool: True si tiene webhooks suscritos
    """
    try:
        # Obtener Page Access Token
        page_access_token = obtener_page_access_token(page_id, user_access_token)
        
        if not page_access_token:
            print(f"‚ö†Ô∏è No se pudo obtener Page Access Token para verificar p√°gina {page_id}")
            return False
        
        url = f"https://graph.facebook.com/v19.0/{page_id}/subscribed_apps"
        
        params = {
            'access_token': page_access_token  # Usar Page Access Token
        }
        
        response = requests.get(url, params=params, timeout=15)
        
        if response.status_code == 200:
            data = response.json()
            apps = data.get('data', [])
            
            # Verificar si nuestra app est√° en la lista
            app_id = os.getenv('META_APP_ID')
            if app_id:
                for app in apps:
                    if app.get('id') == app_id:
                        return True
            
            # Si no hay APP_ID configurado, asumir que est√° suscrito si hay apps
            return len(apps) > 0
        else:
            print(f"‚ö†Ô∏è Error verificando webhook para p√°gina {page_id}: {response.status_code}")
            return False
            
    except Exception as e:
        print(f"‚ùå Error verificando webhook para p√°gina {page_id}: {e}")
        return False

def obtener_paginas_facebook():
    """
    Obtiene todas las p√°ginas de Facebook desde la base de datos
    
    Returns:
        list: Lista de p√°ginas de Facebook
    """
    try:
        print("üîç Obteniendo p√°ginas de Facebook desde base de datos...")
        
        # Obtener todas las p√°ginas activas
        resultado = supabase.table('facebook_paginas').select('page_id, nombre_pagina, estado_webhook, activa').eq('activa', True).execute()
        
        if not resultado.data:
            print("‚ùå No se encontraron p√°ginas de Facebook en la base de datos")
            return []
        
        paginas = resultado.data
        print(f"‚úÖ Se encontraron {len(paginas)} p√°ginas activas")
        
        return paginas
        
    except Exception as e:
        print(f"‚ùå Error obteniendo p√°ginas de Facebook: {e}")
        return []

def actualizar_estado_webhook_pagina(page_id, webhook_suscrito):
    """
    Actualiza el estado del webhook de una p√°gina en la base de datos
    
    Args:
        page_id (str): ID de la p√°gina
        webhook_suscrito (bool): Si el webhook est√° suscrito
    """
    try:
        estado = 'activa' if webhook_suscrito else 'pausada'
        
        resultado = supabase.table('facebook_paginas').update({
            'estado_webhook': estado,
            'actualizado_en': datetime.utcnow().isoformat()
        }).eq('page_id', page_id).execute()
        
        if resultado.data:
            print(f"‚úÖ Estado actualizado para p√°gina {page_id}: {estado}")
        else:
            print(f"‚ö†Ô∏è No se pudo actualizar estado para p√°gina {page_id}")
            
    except Exception as e:
        print(f"‚ùå Error actualizando estado para p√°gina {page_id}: {e}")

def suscribir_webhooks_masivo():
    """
    Suscribe webhooks en todas las p√°ginas de Facebook activas
    
    Returns:
        dict: Estad√≠sticas del proceso
    """
    print("üöÄ SUSCRIPCI√ìN MASIVA DE WEBHOOKS PARA FACEBOOK PAGES")
    print("=" * 60)
    
    # Verificar tokens y configuraci√≥n
    access_token = obtener_access_token()
    if not access_token:
        return {'error': 'Access token no configurado'}
    
    webhook_url = obtener_webhook_url()
    if not webhook_url:
        return {'error': 'Webhook URL no configurada'}
    
    verify_token = obtener_verify_token()
    if not verify_token:
        return {'error': 'Verify token no configurado'}
    
    print(f"‚úÖ Access token configurado")
    print(f"‚úÖ Webhook URL: {webhook_url}")
    print(f"‚úÖ Verify token configurado")
    
    # Obtener p√°ginas
    paginas = obtener_paginas_facebook()
    if not paginas:
        return {'error': 'No se encontraron p√°ginas para procesar'}
    
    # Filtrar p√°ginas que no requieren suscripci√≥n
    paginas_a_suscribir = [p for p in paginas if p.get('estado_webhook') != 'excluida']
    
    print(f"\nüìä P√°ginas a procesar: {len(paginas_a_suscribir)}")
    print(f"üìä P√°ginas excluidas: {len(paginas) - len(paginas_a_suscribir)}")
    
    # Estad√≠sticas
    exitosos = 0
    fallidos = 0
    ya_suscritos = 0
    resultados = []
    
    print(f"\nüîÑ Procesando p√°ginas...")
    
    for i, pagina in enumerate(paginas_a_suscribir, 1):
        page_id = pagina['page_id']
        nombre_pagina = pagina['nombre_pagina']
        
        print(f"\n[{i}/{len(paginas_a_suscribir)}] Procesando: {nombre_pagina}")
        print(f"   üìã Page ID: {page_id}")
        
        # Verificar si ya est√° suscrito
        ya_suscrito = verificar_webhook_pagina(page_id, access_token)
        
        if ya_suscrito:
            print(f"   ‚úÖ Ya tiene webhook suscrito")
            ya_suscritos += 1
            actualizar_estado_webhook_pagina(page_id, True)
            continue
        
        # Suscribir webhook
        resultado = suscribir_webhook_pagina(page_id, access_token, webhook_url, verify_token)
        resultados.append(resultado)
        
        if resultado['success']:
            exitosos += 1
            actualizar_estado_webhook_pagina(page_id, True)
            print(f"   ‚úÖ Suscripci√≥n exitosa")
        else:
            fallidos += 1
            actualizar_estado_webhook_pagina(page_id, False)
            print(f"   ‚ùå Error: {resultado['error']}")
    
    # Resumen final
    print(f"\n" + "=" * 60)
    print(f"üìä RESUMEN DE SUSCRIPCI√ìN MASIVA")
    print(f"=" * 60)
    print(f"‚úÖ Exitosos: {exitosos}")
    print(f"üîÑ Ya suscritos: {ya_suscritos}")
    print(f"‚ùå Fallidos: {fallidos}")
    print(f"üìã Total procesadas: {len(paginas_a_suscribir)}")
    print(f"‚è±Ô∏è Completado: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    return {
        'exitosos': exitosos,
        'ya_suscritos': ya_suscritos,
        'fallidos': fallidos,
        'total': len(paginas_a_suscribir),
        'resultados': resultados
    }

def verificar_estado_todas_paginas():
    """
    Verifica el estado de webhooks en todas las p√°ginas
    
    Returns:
        dict: Estado de todas las p√°ginas
    """
    print("üîç VERIFICACI√ìN DE ESTADO DE WEBHOOKS")
    print("=" * 50)
    
    access_token = obtener_access_token()
    if not access_token:
        return {'error': 'Access token no configurado'}
    
    paginas = obtener_paginas_facebook()
    if not paginas:
        return {'error': 'No se encontraron p√°ginas'}
    
    print(f"üìã Verificando {len(paginas)} p√°ginas...")
    
    suscritas = 0
    no_suscritas = 0
    errores = 0
    
    for pagina in paginas:
        page_id = pagina['page_id']
        nombre_pagina = pagina['nombre_pagina']
        
        print(f"\nüîç {nombre_pagina} ({page_id})")
        
        try:
            suscrito = verificar_webhook_pagina(page_id, access_token)
            
            if suscrito:
                print(f"   ‚úÖ Webhook suscrito")
                suscritas += 1
                actualizar_estado_webhook_pagina(page_id, True)
            else:
                print(f"   ‚ùå Webhook NO suscrito")
                no_suscritas += 1
                actualizar_estado_webhook_pagina(page_id, False)
                
        except Exception as e:
            print(f"   ‚ö†Ô∏è Error verificando: {e}")
            errores += 1
    
    print(f"\n" + "=" * 50)
    print(f"üìä RESUMEN DE VERIFICACI√ìN")
    print(f"=" * 50)
    print(f"‚úÖ Suscritas: {suscritas}")
    print(f"‚ùå No suscritas: {no_suscritas}")
    print(f"‚ö†Ô∏è Errores: {errores}")
    print(f"üìã Total: {len(paginas)}")
    
    return {
        'suscritas': suscritas,
        'no_suscritas': no_suscritas,
        'errores': errores,
        'total': len(paginas)
    }

def suscribir_pagina_especifica():
    """
    Suscribe webhook en una p√°gina espec√≠fica (modo interactivo)
    """
    print("üì° SUSCRIPCI√ìN DE WEBHOOK EN P√ÅGINA ESPEC√çFICA")
    print("=" * 50)
    
    access_token = obtener_access_token()
    if not access_token:
        return
    
    webhook_url = obtener_webhook_url()
    if not webhook_url:
        return
    
    verify_token = obtener_verify_token()
    if not verify_token:
        return
    
    # Mostrar p√°ginas disponibles
    paginas = obtener_paginas_facebook()
    if not paginas:
        return
    
    print(f"\nüìã P√°ginas disponibles:")
    for i, pagina in enumerate(paginas, 1):
        estado = "üü¢" if pagina.get('estado_webhook') == 'activa' else "üî¥" if pagina.get('estado_webhook') == 'pausada' else "üü°"
        print(f"{i:2d}. {estado} {pagina['nombre_pagina']} (ID: {pagina['page_id']})")
    
    try:
        seleccion = input(f"\nSelecciona una p√°gina (1-{len(paginas)}) o 'q' para salir: ").strip()
        
        if seleccion.lower() == 'q':
            return
        
        indice = int(seleccion) - 1
        if 0 <= indice < len(paginas):
            pagina = paginas[indice]
            page_id = pagina['page_id']
            nombre_pagina = pagina['nombre_pagina']
            
            print(f"\nüéØ Suscribiendo webhook para: {nombre_pagina}")
            
            resultado = suscribir_webhook_pagina(page_id, access_token, webhook_url, verify_token)
            
            if resultado['success']:
                print(f"‚úÖ ¬°Webhook suscrito exitosamente!")
                actualizar_estado_webhook_pagina(page_id, True)
            else:
                print(f"‚ùå Error: {resultado['error']}")
                actualizar_estado_webhook_pagina(page_id, False)
        else:
            print("‚ùå Selecci√≥n inv√°lida")
            
    except ValueError:
        print("‚ùå Por favor ingresa un n√∫mero v√°lido")
    except KeyboardInterrupt:
        print("\nüëã Operaci√≥n cancelada")

def menu_principal():
    """Muestra el men√∫ principal de opciones"""
    print("\n" + "="*60)
    print("üì° GESTI√ìN DE WEBHOOKS PARA FACEBOOK PAGES")
    print("="*60)
    print("1. üöÄ Suscribir webhooks en TODAS las p√°ginas")
    print("2. üîç Verificar estado de todas las p√°ginas")
    print("3. üì° Suscribir webhook en p√°gina espec√≠fica")
    print("4. üìä Ver estad√≠sticas de p√°ginas")
    print("5. ‚ùå Salir")
    print("="*60)

def mostrar_estadisticas():
    """Muestra estad√≠sticas de las p√°ginas"""
    print("üìä ESTAD√çSTICAS DE FACEBOOK PAGES")
    print("=" * 40)
    
    try:
        # Estad√≠sticas generales
        total = supabase.table('facebook_paginas').select('*').execute()
        activas = supabase.table('facebook_paginas').select('*').eq('activa', True).execute()
        webhook_activo = supabase.table('facebook_paginas').select('*').eq('estado_webhook', 'activa').execute()
        webhook_pausado = supabase.table('facebook_paginas').select('*').eq('estado_webhook', 'pausada').execute()
        webhook_excluido = supabase.table('facebook_paginas').select('*').eq('estado_webhook', 'excluida').execute()
        
        print(f"üìã Total p√°ginas: {len(total.data)}")
        print(f"‚úÖ P√°ginas activas: {len(activas.data)}")
        print(f"üü¢ Webhooks activos: {len(webhook_activo.data)}")
        print(f"üî¥ Webhooks pausados: {len(webhook_pausado.data)}")
        print(f"‚ö´ Webhooks excluidos: {len(webhook_excluido.data)}")
        
        # Top p√°ginas por seguidores
        print(f"\nüèÜ TOP 10 P√ÅGINAS POR SEGUIDORES:")
        top_paginas = supabase.table('facebook_paginas').select('nombre_pagina, seguidores').order('seguidores', desc=True).limit(10).execute()
        
        for i, pagina in enumerate(top_paginas.data, 1):
            seguidores = pagina.get('seguidores', 0)
            nombre = pagina.get('nombre_pagina', 'Sin nombre')
            print(f"{i:2d}. {nombre:<40} {seguidores:>10,} seguidores")
        
    except Exception as e:
        print(f"‚ùå Error obteniendo estad√≠sticas: {e}")

def main():
    """Funci√≥n principal"""
    print("üöÄ Iniciando gestor de webhooks para Facebook Pages...")
    
    while True:
        menu_principal()
        
        try:
            opcion = input("Selecciona una opci√≥n (1-5): ").strip()
            
            if opcion == '1':
                print("\nüöÄ Iniciando suscripci√≥n masiva...")
                resultado = suscribir_webhooks_masivo()
                
                if 'error' in resultado:
                    print(f"‚ùå Error: {resultado['error']}")
                else:
                    print(f"\n‚úÖ Proceso completado exitosamente!")
                
                input("\nPresiona Enter para continuar...")
                
            elif opcion == '2':
                print("\nüîç Verificando estado de p√°ginas...")
                resultado = verificar_estado_todas_paginas()
                
                if 'error' in resultado:
                    print(f"‚ùå Error: {resultado['error']}")
                    
                input("\nPresiona Enter para continuar...")
                
            elif opcion == '3':
                suscribir_pagina_especifica()
                input("\nPresiona Enter para continuar...")
                
            elif opcion == '4':
                mostrar_estadisticas()
                input("\nPresiona Enter para continuar...")
                
            elif opcion == '5':
                print("\nüëã ¬°Hasta luego!")
                break
                
            else:
                print("\n‚ùå Opci√≥n no v√°lida. Por favor selecciona 1-5.")
                input("Presiona Enter para continuar...")
                
        except KeyboardInterrupt:
            print("\n\nüëã ¬°Hasta luego!")
            break
        except Exception as e:
            print(f"\n‚ùå Error inesperado: {e}")
            input("Presiona Enter para continuar...")

if __name__ == "__main__":
    main()
