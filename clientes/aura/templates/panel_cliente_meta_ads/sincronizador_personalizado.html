{% extends "base_cliente.html" %}
{% block contenido %}

{# Variables globales para JavaScript #}
<script>
window.appConfig = {
    nombreNora: "{{ nombre_nora }}",
    baseUrl: "/panel_cliente/{{ nombre_nora }}/meta_ads"
};
</script>

<div class="w-full px-6 py-10">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-extrabold text-center text-blue-900 mb-8">
            <i class="fas fa-sync-alt mr-3"></i>Sincronizador Personalizado
        </h1>
        
        <!-- Configuración de fechas -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-calendar-alt text-purple-500 mr-2"></i>Rango de Fechas
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="fecha-inicio" class="block text-sm font-medium text-gray-700 mb-2">Fecha de Inicio</label>
                    <input type="date" id="fecha-inicio" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           value="2025-07-28">
                </div>
                <div>
                    <label for="fecha-fin" class="block text-sm font-medium text-gray-700 mb-2">Fecha de Fin</label>
                    <input type="date" id="fecha-fin" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           value="2025-08-04">
                </div>
                <div class="flex items-end">
                    <button id="btn-semana-actual" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium px-4 py-2 rounded-md transition">
                        <i class="fas fa-calendar-week mr-2"></i>Usar Semana Actual
                    </button>
                </div>
            </div>
        </div>

        <!-- Selección de cuentas -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-ad text-green-500 mr-2"></i>Cuentas Publicitarias
                </h2>
                <div class="space-x-2">
                    <button id="btn-seleccionar-todas" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm transition">
                        <i class="fas fa-check-square mr-1"></i>Seleccionar Todas
                    </button>
                    <button id="btn-deseleccionar-todas" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm transition">
                        <i class="fas fa-square mr-1"></i>Deseleccionar Todas
                    </button>
                </div>
            </div>

            {% if cuentas %}
                <!-- Debug temporal: mostrar información de las cuentas -->
                <div class="mb-4 p-3 bg-gray-100 rounded text-xs text-gray-600">
                    <strong>Debug:</strong> Se encontraron {{ cuentas|length }} cuentas para {{ nombre_nora }}
                    {% if cuentas|length > 0 %}
                        <br>Primera cuenta: {{ cuentas[0].nombre_cliente }} (ID: {{ cuentas[0].id_cuenta_publicitaria }})
                        {% if cuentas[0].empresa_nombre %}
                            - Empresa: {{ cuentas[0].empresa_nombre }}
                        {% endif %}
                    {% endif %}
                </div>
                
                <div class="mb-4">
                    <input type="text" id="filtro-cuentas" placeholder="Buscar cuenta por nombre o ID..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto" id="lista-cuentas">
                    {% for cuenta in cuentas %}
                    <div class="cuenta-item border rounded-lg p-4 hover:bg-gray-50 transition" 
                         data-nombre="{{ cuenta.nombre_cliente|lower }}" 
                         data-id="{{ cuenta.id_cuenta_publicitaria }}">
                        <label class="flex items-start space-x-3 cursor-pointer">
                            <input type="checkbox" class="cuenta-checkbox mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                                   value="{{ cuenta.id_cuenta_publicitaria }}">
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-gray-900 truncate">
                                    {{ cuenta.nombre_cliente or "Sin nombre" }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    ID: {{ cuenta.id_cuenta_publicitaria }}
                                </div>
                                {% if cuenta.empresa_nombre %}
                                <div class="text-xs text-blue-600 font-medium">
                                    <i class="fas fa-building text-xs mr-1"></i>{{ cuenta.empresa_nombre }}
                                </div>
                                {% endif %}
                                <div class="flex items-center space-x-4 mt-2">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                        {% if cuenta.estado_actual == 'activa' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                        <i class="fas fa-circle text-xs mr-1"></i>{{ cuenta.estado_actual|title or "Desconocido" }}
                                    </span>
                                    {% if cuenta.conectada %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i class="fas fa-link text-xs mr-1"></i>Conectada
                                    </span>
                                    {% endif %}
                                    {% if cuenta.ads_activos and cuenta.ads_activos > 0 %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <i class="fas fa-bullhorn text-xs mr-1"></i>{{ cuenta.ads_activos }} ads
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                </div>

                <div class="mt-4 text-sm text-gray-600">
                    <span id="contador-seleccionadas">0</span> de {{ cuentas|length }} cuentas seleccionadas
                </div>
            {% else %}
                <div class="text-center py-12">
                    <i class="fas fa-inbox text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-500">No se encontraron cuentas publicitarias para este cliente.</p>
                </div>
            {% endif %}
        </div>

        <!-- Botones de sincronización -->
        {% if cuentas %}
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-play-circle mr-2"></i>Acciones de Sincronización
            </h3>
            
            <!-- Botón para sincronizar desde API primero -->
            <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h4 class="font-semibold text-blue-800 mb-2">
                    <i class="fas fa-cloud-download-alt mr-2"></i>1. Sincronizar desde Meta Ads API
                </h4>
                <p class="text-sm text-blue-600 mb-3">
                    Si es la primera vez o no hay datos recientes, ejecuta primero esta sincronización para traer los datos desde Meta Ads.
                </p>
                <div class="flex items-center space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-blue-700 mb-1">Días atrás:</label>
                        <select id="dias-atras" class="px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="7">7 días</option>
                            <option value="14">14 días</option>
                            <option value="30" selected>30 días</option>
                            <option value="60">60 días</option>
                            <option value="90">90 días</option>
                        </select>
                    </div>
                    <button 
                        id="btn-sincronizar-api"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                    >
                        <i class="fas fa-cloud-download-alt mr-2"></i>Sincronizar desde API
                    </button>
                </div>
            </div>

            <!-- Botón para sincronizar cuentas seleccionadas -->
            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                <h4 class="font-semibold text-green-800 mb-2">
                    <i class="fas fa-filter mr-2"></i>2. Sincronizar Cuentas Seleccionadas
                </h4>
                <p class="text-sm text-green-600 mb-3">
                    Después de tener datos de la API, selecciona cuentas específicas y un rango de fechas para generar reportes personalizados.
                </p>
                <div class="flex justify-center">
                    <button id="btn-sincronizar" 
                            class="bg-green-600 hover:bg-green-700 text-white font-semibold px-8 py-3 rounded-lg shadow-lg transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        <i class="fas fa-sync-alt mr-2"></i>Sincronizar Cuentas Seleccionadas
                    </button>
                </div>
                <p class="text-center text-sm text-gray-500 mt-2">
                    Solo se procesarán las cuentas seleccionadas en el rango de fechas especificado
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de progreso -->
<div id="modal-progreso" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Sincronizando...</h3>
            <p class="text-gray-600">Procesando las cuentas seleccionadas. Por favor espere.</p>
        </div>
    </div>
</div>

<!-- Modal de resultados -->
<div id="modal-resultados" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="text-center">
            <div id="icono-resultado" class="mx-auto mb-4 text-4xl"></div>
            <h3 id="titulo-resultado" class="text-lg font-semibold mb-2"></h3>
            <p id="mensaje-resultado" class="text-gray-600 mb-4"></p>
            <button id="btn-cerrar-modal" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition">
                Cerrar
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fechaInicio = document.getElementById('fecha-inicio');
    const fechaFin = document.getElementById('fecha-fin');
    const btnSemanaActual = document.getElementById('btn-semana-actual');
    const btnSeleccionarTodas = document.getElementById('btn-seleccionar-todas');
    const btnDeseleccionarTodas = document.getElementById('btn-deseleccionar-todas');
    const filtro = document.getElementById('filtro-cuentas');
    const btnSincronizar = document.getElementById('btn-sincronizar');
    const btnSincronizarAPI = document.getElementById('btn-sincronizar-api');
    const diasAtras = document.getElementById('dias-atras');
    const contadorSeleccionadas = document.getElementById('contador-seleccionadas');
    const modalProgreso = document.getElementById('modal-progreso');
    const modalResultados = document.getElementById('modal-resultados');

    // Función para obtener fechas de la semana actual
    function obtenerSemanaActual() {
        const hoy = new Date();
        const diaSemana = hoy.getDay();
        const lunes = new Date(hoy);
        lunes.setDate(hoy.getDate() - diaSemana + 1);
        const domingo = new Date(lunes);
        domingo.setDate(lunes.getDate() + 6);
        
        return {
            inicio: lunes.toISOString().split('T')[0],
            fin: domingo.toISOString().split('T')[0]
        };
    }

    // Botón semana actual
    btnSemanaActual.addEventListener('click', function() {
        const semana = obtenerSemanaActual();
        fechaInicio.value = semana.inicio;
        fechaFin.value = semana.fin;
    });

    // Seleccionar/deseleccionar todas
    btnSeleccionarTodas.addEventListener('click', function() {
        document.querySelectorAll('.cuenta-checkbox:not([style*="display: none"])').forEach(cb => {
            cb.checked = true;
        });
        actualizarContador();
    });

    btnDeseleccionarTodas.addEventListener('click', function() {
        document.querySelectorAll('.cuenta-checkbox').forEach(cb => {
            cb.checked = false;
        });
        actualizarContador();
    });

    // Filtro de búsqueda
    if (filtro) {
        filtro.addEventListener('input', function() {
            const filtroTexto = this.value.toLowerCase();
            document.querySelectorAll('.cuenta-item').forEach(item => {
                const nombre = item.dataset.nombre;
                const id = item.dataset.id;
                const coincide = nombre.includes(filtroTexto) || id.includes(filtroTexto);
                item.style.display = coincide ? 'block' : 'none';
            });
            actualizarContador();
        });
    }

    // Actualizar contador
    function actualizarContador() {
        const checkboxes = document.querySelectorAll('.cuenta-checkbox');
        const seleccionadas = Array.from(checkboxes).filter(cb => cb.checked && cb.closest('.cuenta-item').style.display !== 'none').length;
        contadorSeleccionadas.textContent = seleccionadas;
        
        // Habilitar/deshabilitar botón de sincronizar
        btnSincronizar.disabled = seleccionadas === 0;
    }

    // Event listeners para checkboxes
    document.querySelectorAll('.cuenta-checkbox').forEach(cb => {
        cb.addEventListener('change', actualizarContador);
    });

    // Sincronización desde API
    btnSincronizarAPI.addEventListener('click', async function() {
        const dias = parseInt(diasAtras.value);
        
        // Mostrar modal de progreso
        modalProgreso.classList.remove('hidden');
        
        // Actualizar texto del modal
        const tituloProgreso = modalProgreso.querySelector('h3');
        const mensajeProgreso = modalProgreso.querySelector('p');
        tituloProgreso.textContent = 'Sincronizando desde Meta Ads API...';
        mensajeProgreso.textContent = `Obteniendo datos de los últimos ${dias} días. Esto puede tomar varios minutos.`;

        try {
            const response = await fetch(`${window.appConfig.baseUrl}/sincronizar-desde-api`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dias: dias
                })
            });

            const result = await response.json();
            
            // Ocultar modal de progreso
            modalProgreso.classList.add('hidden');
            
            // Mostrar resultados
            const iconoResultado = document.getElementById('icono-resultado');
            const tituloResultado = document.getElementById('titulo-resultado');
            const mensajeResultado = document.getElementById('mensaje-resultado');
            
            if (result.success) {
                iconoResultado.innerHTML = '<i class="fas fa-cloud-download-alt text-blue-500"></i>';
                tituloResultado.textContent = 'Sincronización desde API Exitosa';
                tituloResultado.className = 'text-lg font-semibold mb-2 text-blue-700';
                
                const resultado = result.resultado;
                mensajeResultado.innerHTML = `
                    <div class="space-y-2 text-sm">
                        <div><strong>Cuentas procesadas:</strong> ${resultado.cuentas_procesadas || 0}</div>
                        <div><strong>Cuentas exitosas:</strong> ${resultado.cuentas_exitosas || 0}</div>
                        <div><strong>Cuentas con errores:</strong> ${resultado.cuentas_con_errores?.length || 0}</div>
                        <div class="text-green-600 mt-2">
                            ✅ Los datos ya están disponibles. Ahora puedes usar el sincronizador personalizado.
                        </div>
                    </div>
                `;
            } else {
                iconoResultado.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i>';
                tituloResultado.textContent = 'Error en Sincronización desde API';
                tituloResultado.className = 'text-lg font-semibold mb-2 text-red-700';
                mensajeResultado.textContent = result.message;
            }
            
            modalResultados.classList.remove('hidden');
            
        } catch (error) {
            modalProgreso.classList.add('hidden');
            
            const iconoResultado = document.getElementById('icono-resultado');
            const tituloResultado = document.getElementById('titulo-resultado');
            const mensajeResultado = document.getElementById('mensaje-resultado');
            
            iconoResultado.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
            tituloResultado.textContent = 'Error de Conexión';
            tituloResultado.className = 'text-lg font-semibold mb-2 text-red-700';
            mensajeResultado.textContent = 'No se pudo conectar con el servidor. Por favor, intenta nuevamente.';
            
            modalResultados.classList.remove('hidden');
        }
    });

    // Sincronización
    btnSincronizar.addEventListener('click', async function() {
        const cuentasSeleccionadas = Array.from(document.querySelectorAll('.cuenta-checkbox:checked')).map(cb => cb.value);
        
        if (cuentasSeleccionadas.length === 0) {
            alert('Por favor selecciona al menos una cuenta para sincronizar.');
            return;
        }

        if (!fechaInicio.value || !fechaFin.value) {
            alert('Por favor selecciona un rango de fechas válido.');
            return;
        }

        // Mostrar modal de progreso
        modalProgreso.classList.remove('hidden');
        
        // Restaurar texto del modal para sincronización normal
        const tituloProgreso = modalProgreso.querySelector('h3');
        const mensajeProgreso = modalProgreso.querySelector('p');
        tituloProgreso.textContent = 'Sincronizando...';
        mensajeProgreso.textContent = 'Procesando las cuentas seleccionadas. Por favor espere.';

        try {
            const response = await fetch(`${window.appConfig.baseUrl}/sincronizar-cuentas-seleccionadas`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cuentas_ids: cuentasSeleccionadas,
                    fecha_inicio: fechaInicio.value,
                    fecha_fin: fechaFin.value
                })
            });

            const result = await response.json();
            
            // Ocultar modal de progreso
            modalProgreso.classList.add('hidden');
            
            // Mostrar resultados
            const iconoResultado = document.getElementById('icono-resultado');
            const tituloResultado = document.getElementById('titulo-resultado');
            const mensajeResultado = document.getElementById('mensaje-resultado');
            
            if (result.success) {
                iconoResultado.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                tituloResultado.textContent = 'Sincronización Exitosa';
                tituloResultado.className = 'text-lg font-semibold mb-2 text-green-700';
                mensajeResultado.innerHTML = `
                    <div class="space-y-1">
                        <div><strong>Reportes insertados:</strong> ${result.reportes_insertados}</div>
                        <div><strong>Cuentas procesadas:</strong> ${result.cuentas_procesadas}</div>
                        <div class="text-sm text-gray-500 mt-2">${result.message}</div>
                    </div>
                `;
            } else {
                iconoResultado.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i>';
                tituloResultado.textContent = 'Error en Sincronización';
                tituloResultado.className = 'text-lg font-semibold mb-2 text-red-700';
                mensajeResultado.textContent = result.message;
            }
            
            modalResultados.classList.remove('hidden');
            
        } catch (error) {
            modalProgreso.classList.add('hidden');
            
            const iconoResultado = document.getElementById('icono-resultado');
            const tituloResultado = document.getElementById('titulo-resultado');
            const mensajeResultado = document.getElementById('mensaje-resultado');
            
            iconoResultado.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
            tituloResultado.textContent = 'Error de Conexión';
            tituloResultado.className = 'text-lg font-semibold mb-2 text-red-700';
            mensajeResultado.textContent = 'No se pudo conectar con el servidor. Por favor, intenta nuevamente.';
            
            modalResultados.classList.remove('hidden');
        }
    });

    // Cerrar modal de resultados
    document.getElementById('btn-cerrar-modal').addEventListener('click', function() {
        modalResultados.classList.add('hidden');
    });

    // Inicializar contador
    actualizarContador();
});
</script>

{% endblock %}
