{% extends "base_cliente.html" %}
{% block contenido %}
<a href="/panel_cliente/{{ nombre_nora }}/meta_ads/" class="inline-block mb-6 text-blue-700 hover:underline font-semibold">← Regresar a reportes</a>
<div class="max-w-7xl mx-auto py-10">
  <h1 class="text-4xl font-extrabold text-center text-green-900 mb-8">Generar Reporte Meta Ads</h1>
  <div class="bg-white rounded-xl shadow p-8 border border-green-100 mb-8">
    <!-- Formulario de selección -->
    <div class="grid grid-cols-1 gap-6 max-w-2xl mx-auto">
      <!-- Selector de cuenta -->
      <div>
        <label class="block text-sm font-semibold mb-2">Seleccionar Cuenta:</label>
        <select id="cuenta-id" class="w-full border rounded-lg px-3 py-2">
          <option value="">-- Seleccionar cuenta --</option>
          {% for cuenta in cuentas_ads %}
          <option value="{{ cuenta.id_cuenta_publicitaria }}" 
                  data-nombre="{{ cuenta.nombre_cliente }}"
                  data-plataforma="{{ cuenta.tipo_plataforma }}">
            {{ cuenta.nombre_cliente }} ({{ cuenta.tipo_plataforma|capitalize }})
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Selector de fechas -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-2">Fecha desde:</label>
          <input type="date" id="fecha-desde" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2">Fecha hasta:</label>
          <input type="date" id="fecha-hasta" class="w-full border rounded-lg px-3 py-2">
        </div>
      </div>

      <!-- Botón de generar -->
      <div class="flex justify-center mt-4">
        <button id="btn-generar-reporte" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold">
          Generar Reporte
        </button>
      </div>
    </div>

    <div id="reporte-status" class="mt-8 text-center text-lg"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('btn-generar-reporte');
  const status = document.getElementById('reporte-status');
  
  // Configurar fechas por defecto (último mes)
  const hoy = new Date();
  const hace30Dias = new Date(hoy);
  hace30Dias.setDate(hoy.getDate() - 30);
  
  document.getElementById('fecha-desde').value = hace30Dias.toISOString().split('T')[0];
  document.getElementById('fecha-hasta').value = hoy.toISOString().split('T')[0];
  
  btn.onclick = async function() {
    // Validar selección
    const cuentaSelect = document.getElementById('cuenta-id');
    const fechaDesde = document.getElementById('fecha-desde').value;
    const fechaHasta = document.getElementById('fecha-hasta').value;
    
    if (!cuentaSelect.value) {
      alert('Por favor selecciona una cuenta');
      return;
    }
    if (!fechaDesde || !fechaHasta) {
      alert('Por favor selecciona ambas fechas');
      return;
    }
    
    // Obtener datos de la cuenta seleccionada
    const nombreCliente = cuentaSelect.options[cuentaSelect.selectedIndex].dataset.nombre;
    const plataforma = cuentaSelect.options[cuentaSelect.selectedIndex].dataset.plataforma;
    
    // Deshabilitar botón y mostrar estado
    btn.disabled = true;
    btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2 inline" viewBox="0 0 24 24">...</svg> Generando...';
    status.textContent = 'Generando reporte...';
    status.className = 'mt-8 text-center text-lg text-blue-600';
    
    try {
      const resp = await fetch('/panel_cliente/{{ nombre_nora }}/meta_ads/generar_especifico', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          cuenta_id: cuentaSelect.value,
          nombre_cliente: nombreCliente,
          plataforma: plataforma,
          fecha_desde: fechaDesde,
          fecha_hasta: fechaHasta,
          tipo_reporte: 'normal'
        })
      });
      
      const data = await resp.json();
      
      if (data.success) {
        status.textContent = '✅ Reporte generado correctamente';
        status.className = 'mt-8 text-center text-lg text-green-600';
        if (data.download_url) {
          window.location.href = data.download_url;
        }
        // Redirigir a la página principal después de 2 segundos
        setTimeout(() => {
          window.location.href = '/panel_cliente/{{ nombre_nora }}/meta_ads/';
        }, 2000);
      } else {
        throw new Error(data.error || 'Error desconocido');
      }
    } catch (error) {
      status.textContent = '❌ Error: ' + error.message;
      status.className = 'mt-8 text-center text-lg text-red-600';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Generar Reporte';
    }
  };
});
</script>
{% endblock %}
