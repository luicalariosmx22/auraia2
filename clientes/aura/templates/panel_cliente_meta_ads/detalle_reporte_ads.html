{% extends "base_cliente.html" %}
{% block contenido %}

<script>
const nombreNora = "{{ nombre_nora }}";
const metaAdsBaseUrl = `/panel_cliente/${nombreNora}/meta_ads`;
</script>

<style>
/* Evita cortes inc√≥modos entre tarjetas o tablas */
.avoid-break {
  break-inside: avoid;
  page-break-inside: avoid;
}

/* Opcional: fuerza saltos suaves donde lo prefieras */
.page-break {
  page-break-before: always;
  break-before: always;
}
</style>

<a href="{{ url_for('panel_cliente_meta_ads_bp.vista_reportes_meta_ads', nombre_nora=nombre_nora) }}" class="inline-block mb-8 text-blue-500 hover:underline text-sm font-medium"><i class="fa fa-arrow-left mr-1"></i> Volver a reportes</a>

<div id="detalle-reporte-pdf" class="mx-auto py-8 px-6 max-w-4xl bg-white">
  <!-- Botones de acciones -->
  <div class="flex justify-end mb-4 gap-2">
    <button type="button" onclick="compartirReporte()" class="px-3 py-1 bg-green-600 text-white rounded text-xs font-semibold shadow-sm hover:bg-green-700 transition flex items-center gap-1">
      <span>üîó</span> Compartir
    </button>
    <button type="button" onclick="exportarDetalleReportePDF()" class="px-3 py-1 bg-indigo-600 text-white rounded text-xs font-semibold shadow-sm hover:bg-indigo-700 transition flex items-center gap-1">
      <span>üìÑ</span> Exportar PDF
    </button>
  </div>
  <!-- ENCABEZADO -->
  <div class="flex items-center justify-between mb-8 avoid-break">
    <div class="flex items-center gap-4">
      {% if empresa and empresa.logo_url %}
        <img src="{{ empresa.logo_url }}" alt="Logo" class="h-14 w-14 rounded-full border object-cover">
      {% else %}
        <div class="h-14 w-14 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl font-bold">üè¢</div>
      {% endif %}
      <div>
        <h1 class="text-2xl font-extrabold text-gray-800">{{ empresa.nombre_empresa if empresa else (reporte.empresa_nombre or 'Empresa desconocida') }}</h1>
        <p class="text-sm text-gray-500">Cuenta publicitaria: <span class="font-mono text-blue-600">{{ reporte.id_cuenta_publicitaria }}</span></p>
      </div>
    </div>
    <div class="text-right text-sm text-gray-500">
      Periodo: {{ reporte.fecha_inicio }} ‚Üí {{ reporte.fecha_fin }}
    </div>
  </div>

  <!-- CARDS DE KPIS -->
  <div class="grid grid-cols-2 md:grid-cols-3 gap-6 mb-10">

    {% if reporte.importe_gastado_campa√±as %}
    <div class="bg-white p-4 rounded-xl border shadow text-center avoid-break">
      <div class="text-xs uppercase text-gray-500 mb-1">Gasto Total</div>
      <div class="text-2xl font-bold text-green-600">${{ "{:,.2f}".format(reporte.importe_gastado_campa√±as|float) }}</div>
    </div>
    {% endif %}

    {% if reporte.mensajes %}
    <div class="bg-white p-4 rounded-xl border shadow text-center avoid-break">
      <div class="text-xs uppercase text-gray-500 mb-1">Mensajes</div>
      <div class="text-2xl font-bold text-indigo-600">{{ "{:,}".format(reporte.mensajes|int) }}</div>
    </div>
    {% endif %}

    {% if reporte.clicks %}
    <div class="bg-white p-4 rounded-xl border shadow text-center avoid-break">
      <div class="text-xs uppercase text-gray-500 mb-1">Clicks</div>
      <div class="text-2xl font-bold text-indigo-600">{{ "{:,}".format(reporte.clicks|int) }}</div>
    </div>
    {% endif %}

    {% if reporte.impresiones %}
    <div class="bg-white p-4 rounded-xl border shadow text-center avoid-break">
      <div class="text-xs uppercase text-gray-500 mb-1">Impresiones</div>
      <div class="text-2xl font-bold text-indigo-600">{{ "{:,}".format(reporte.impresiones|int) }}</div>
    </div>
    {% endif %}

    {% if reporte.alcance %}
    <div class="bg-white p-4 rounded-xl border shadow text-center avoid-break">
      <div class="text-xs uppercase text-gray-500 mb-1">Alcance</div>
      <div class="text-2xl font-bold text-indigo-600">{{ "{:,}".format(reporte.alcance|int) }}</div>
    </div>
    {% endif %}

    {% if reporte.interacciones %}
    <div class="bg-white p-4 rounded-xl border shadow text-center avoid-break">
      <div class="text-xs uppercase text-gray-500 mb-1">Interacciones</div>
      <div class="text-2xl font-bold text-purple-600">{{ "{:,}".format(reporte.interacciones|int) }}</div>
    </div>
    {% endif %}

    {% if reporte.mensajes %}
    <div class="bg-white p-4 rounded-xl border shadow text-center avoid-break">
      <div class="text-xs uppercase text-gray-500 mb-1">Costo por Mensaje</div>
      <div class="text-2xl font-bold text-orange-600">
        ${{ "{:,.2f}".format((reporte.importe_gastado_campa√±as / reporte.mensajes) if reporte.mensajes else 0) }}
      </div>
    </div>
    {% endif %}

  </div>

  <!-- DESEMPE√ëO POR PLATAFORMA -->
  <div class="mb-10">
    <h2 class="text-lg font-bold text-gray-800 mb-3">Desempe√±o por Plataforma</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-blue-50 rounded-xl p-6 shadow border border-blue-100 avoid-break">
        <div class="text-lg font-bold text-blue-800 mb-2">üìò Facebook</div>
        <table class="min-w-full text-sm avoid-break">
          <tbody>
            <tr><td class="font-semibold text-gray-700 py-1">Gasto</td><td>${{ "{:,.2f}".format(reporte.facebook_importe_gastado|float) }}</td></tr>
            <tr><td class="font-semibold text-gray-700 py-1">Impresiones</td><td>{{ "{:,}".format(reporte.facebook_impresiones|int) }}</td></tr>
            <tr><td class="font-semibold text-gray-700 py-1">Alcance</td><td>{{ "{:,}".format(reporte.facebook_alcance|int) }}</td></tr>
            <tr><td class="font-semibold text-gray-700 py-1">Clicks</td><td>{{ "{:,}".format(reporte.facebook_clicks|int) }}</td></tr>
            <tr><td class="font-semibold text-gray-700 py-1">Mensajes</td><td>{{ "{:,}".format(reporte.facebook_mensajes|int) }}</td></tr>
          </tbody>
        </table>
      </div>

      <div class="bg-pink-50 rounded-xl p-6 shadow border border-pink-100 avoid-break">
        <div class="text-lg font-bold text-pink-800 mb-2">üì∑ Instagram</div>
        <table class="min-w-full text-sm avoid-break">
          <tbody>
            <tr><td class="font-semibold text-gray-700 py-1">Gasto</td><td>${{ "{:,.2f}".format(reporte.instagram_importe_gastado|float) }}</td></tr>
            <tr><td class="font-semibold text-gray-700 py-1">Impresiones</td><td>{{ "{:,}".format(reporte.instagram_impresiones|int) }}</td></tr>
            <tr><td class="font-semibold text-gray-700 py-1">Alcance</td><td>{{ "{:,}".format(reporte.instagram_alcance|int) }}</td></tr>
            <tr><td class="font-semibold text-gray-700 py-1">Clicks</td><td>{{ "{:,}".format(reporte.instagram_clicks|int) }}</td></tr>
            <tr><td class="font-semibold text-gray-700 py-1">Mensajes</td><td>{{ "{:,}".format(reporte.instagram_mensajes|int) }}</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TABS DE PLATAFORMA -->
  <div class="mb-6">
    <div class="flex gap-2">
      <button id="tab-facebook" class="tab-btn px-4 py-2 rounded-t-lg font-semibold text-blue-800 bg-blue-100 border-b-2 border-blue-500 focus:outline-none">Facebook</button>
      <button id="tab-instagram" class="tab-btn px-4 py-2 rounded-t-lg font-semibold text-pink-800 bg-pink-100 border-b-2 border-pink-500 focus:outline-none">Instagram</button>
    </div>
  </div>
  <!-- TABLA DE ANUNCIOS POR PLATAFORMA -->
  <div id="tabla-facebook">
    <h3 class="text-lg font-bold text-blue-800 mb-3">Detalle de Anuncios en Facebook</h3>
    <div class="overflow-x-auto border rounded-xl shadow avoid-break">
      <table class="min-w-full text-sm text-gray-700 avoid-break">
        <thead class="bg-blue-50">
          <tr>
            <th class="px-4 py-2 text-left">Anuncio</th>
            <th class="px-4 py-2 text-right">Impresiones</th>
            <th class="px-4 py-2 text-right">Clicks</th>
            <th class="px-4 py-2 text-right">Link Clicks</th>
            <th class="px-4 py-2 text-right">Interacciones</th>
            <th class="px-4 py-2 text-right">Mensajes</th>
            <th class="px-4 py-2 text-right">Gasto</th>
          </tr>
        </thead>
        <tbody>
          {% set facebook_anuncios = anuncios | selectattr('publisher_platform', 'equalto', 'facebook') | list %}
          {% if facebook_anuncios %}
            {% for anuncio in facebook_anuncios %}
            <tr class="border-b hover:bg-blue-50">
              <td class="px-4 py-2">
                <div class="font-semibold text-gray-800">{{ (anuncio.nombre_anuncio or anuncio.ad_id or 'Sin nombre')[:50] }}</div>
                <div class="text-xs text-gray-500 mt-1">
                  <span class="inline-block bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">
                    Campa√±a: {{ anuncio.nombre_campana or 'N/D' }}
                  </span>
                </div>
              </td>
              <td class="px-4 py-2 text-right">{{ "{:,}".format(anuncio.impresiones|int) if anuncio.impresiones else 0 }}</td>
              <td class="px-4 py-2 text-right">{{ "{:,}".format(anuncio.clicks|int) if anuncio.clicks else 0 }}</td>
              <td class="px-4 py-2 text-right">{{ "{:,}".format(anuncio.link_clicks|int) if anuncio.link_clicks else 0 }}</td>
              <td class="px-4 py-2 text-right">{{ "{:,}".format(anuncio.interacciones|int) if anuncio.interacciones else 0 }}</td>
              <td class="px-4 py-2 text-right">{{ "{:,}".format(anuncio.messaging_conversations_started|int) if anuncio.messaging_conversations_started else 0 }}</td>
              <td class="px-4 py-2 text-right font-bold text-green-700">${{ "{:,.2f}".format(anuncio.importe_gastado|float) if anuncio.importe_gastado else 0 }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                No hay anuncios de Facebook para este per√≠odo
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  <div id="tabla-instagram" style="display:none;">
    <h3 class="text-lg font-bold text-pink-700 mb-3">Detalle de Anuncios en Instagram</h3>
    <div class="overflow-x-auto border rounded-xl shadow avoid-break">
      <table class="min-w-full text-sm text-gray-700 avoid-break">
        <thead class="bg-pink-50">
          <tr>
            <th class="px-4 py-2 text-left">Anuncio</th>
            <th class="px-4 py-2 text-right">Impresiones</th>
            <th class="px-4 py-2 text-right">Clicks</th>
            <th class="px-4 py-2 text-right">Link Clicks</th>
            <th class="px-4 py-2 text-right">Interacciones</th>
            <th class="px-4 py-2 text-right">Mensajes</th>
            <th class="px-4 py-2 text-right">Gasto</th>
          </tr>
        </thead>
        <tbody>
          {% set instagram_anuncios = anuncios | selectattr('publisher_platform', 'equalto', 'instagram') | list %}
          {% if instagram_anuncios %}
            {% for anuncio in instagram_anuncios %}
            <tr class="border-b hover:bg-pink-50">
              <td class="px-4 py-2">
                <div class="font-semibold text-gray-800">{{ (anuncio.nombre_anuncio or anuncio.ad_id or 'Sin nombre')[:50] }}</div>
                <div class="text-xs text-gray-500 mt-1">
                  <span class="inline-block bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">
                    Campa√±a: {{ anuncio.nombre_campana or 'N/D' }}
                  </span>
                </div>
              </td>
              <td class="px-4 py-2 text-right">{{ "{:,}".format(anuncio.impresiones|int) if anuncio.impresiones else 0 }}</td>
              <td class="px-4 py-2 text-right">{{ "{:,}".format(anuncio.clicks|int) if anuncio.clicks else 0 }}</td>
              <td class="px-4 py-2 text-right">{{ "{:,}".format(anuncio.link_clicks|int) if anuncio.link_clicks else 0 }}</td>
              <td class="px-4 py-2 text-right">{{ "{:,}".format(anuncio.interacciones|int) if anuncio.interacciones else 0 }}</td>
              <td class="px-4 py-2 text-right">{{ "{:,}".format(anuncio.messaging_conversations_started|int) if anuncio.messaging_conversations_started else 0 }}</td>
              <td class="px-4 py-2 text-right font-bold text-green-700">${{ "{:,.2f}".format(anuncio.importe_gastado|float) if anuncio.importe_gastado else 0 }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                No hay anuncios de Instagram para este per√≠odo
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  <script>
    // Script para tabs
    document.addEventListener('DOMContentLoaded', function() {
      const tabFacebook = document.getElementById('tab-facebook');
      const tabInstagram = document.getElementById('tab-instagram');
      const tablaFacebook = document.getElementById('tabla-facebook');
      const tablaInstagram = document.getElementById('tabla-instagram');
      tabFacebook.addEventListener('click', function() {
        tabFacebook.classList.add('bg-blue-100', 'text-blue-800', 'border-b-2', 'border-blue-500');
        tabInstagram.classList.remove('bg-pink-100', 'text-pink-800', 'border-b-2', 'border-pink-500');
        tablaFacebook.style.display = '';
        tablaInstagram.style.display = 'none';
      });
      tabInstagram.addEventListener('click', function() {
        tabInstagram.classList.add('bg-pink-100', 'text-pink-800', 'border-b-2', 'border-pink-500');
        tabFacebook.classList.remove('bg-blue-100', 'text-blue-800', 'border-b-2', 'border-blue-500');
        tablaInstagram.style.display = '';
        tablaFacebook.style.display = 'none';
      });
    });
  </script>

  <!-- TOP 3 FINAL -->
  <div class="page-break mb-12">
    <h3 class="text-lg font-semibold text-indigo-800 mb-3">Top 3 Anuncios por Gasto</h3>
    {% set top_anuncios = anuncios | sort(attribute='importe_gastado', reverse=True) %}
    {% set top_anuncios = top_anuncios[:3] %}
    <div class="overflow-x-auto border rounded-xl shadow avoid-break">
      <table class="min-w-full text-sm text-gray-700 avoid-break">
        <thead class="bg-indigo-50">
          <tr>
            <th class="px-4 py-2 text-left">Anuncio</th>
            <th class="px-4 py-2 text-left">Plataforma</th>
            <th class="px-4 py-2 text-left">Campa√±a</th>
            <th class="px-4 py-2 text-right">Gasto</th>
            <th class="px-4 py-2 text-right">Clicks</th>
            <th class="px-4 py-2 text-right">Link Clicks</th>
            <th class="px-4 py-2 text-right">Impresiones</th>
            <th class="px-4 py-2 text-right">Alcance</th>
          </tr>
        </thead>
        <tbody>
          {% for anuncio in top_anuncios %}
          <tr class="border-b hover:bg-indigo-50">
            <td class="px-4 py-2 font-mono text-indigo-700">{{ (anuncio.nombre_anuncio or anuncio.ad_id or 'Sin nombre')[:50] }}</td>
            <td class="px-4 py-2">
              <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium {% if anuncio.publisher_platform == 'facebook' %}bg-blue-100 text-blue-800{% elif anuncio.publisher_platform == 'instagram' %}bg-pink-100 text-pink-800{% else %}bg-gray-100 text-gray-600{% endif %}">
                {% if anuncio.publisher_platform == 'facebook' %}üìò Facebook{% elif anuncio.publisher_platform == 'instagram' %}üì∑ Instagram{% else %}‚Äî{% endif %}
              </span>
            </td>
            <td class="px-4 py-2">
              <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
                {{ anuncio.nombre_campana or 'N/D' }}
              </span>
            </td>
            <td class="px-4 py-2 text-right font-semibold text-green-700">${{ "{:,.2f}".format(anuncio.importe_gastado|float) }}</td>
            <td class="px-4 py-2 text-right font-semibold text-indigo-600">{{ "{:,}".format(anuncio.clicks|int) }}</td>
            <td class="px-4 py-2 text-right font-semibold text-blue-600">{{ "{:,}".format(anuncio.link_clicks|int) if anuncio.link_clicks else 0 }}</td>
            <td class="px-4 py-2 text-right font-semibold text-indigo-600">{{ "{:,}".format(anuncio.impresiones|int) }}</td>
            <td class="px-4 py-2 text-right font-semibold text-purple-600">{{ "{:,}".format(anuncio.alcance|int) if anuncio.alcance else 0 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- Scripts para exportar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
function exportarDetalleReportePDF() {
  const detalle = document.getElementById('detalle-reporte-pdf');
  if (!detalle) return;
  // Construir nombre de archivo personalizado
  const nombreEmpresa = '{{ empresa.nombre_empresa|default("Empresa")|replace(" ", "_") }}';
  const fecha = '{{ reporte.fecha_fin|default("") }}';
  const nombreArchivo = `Aura - Reporte de Anuncios Meta Ads ${nombreEmpresa} ${fecha}.pdf`;
  const opt = {
    margin: 0.3,
    filename: nombreArchivo,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { useCORS: true, scale: 2 },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
  };
  html2pdf().set(opt).from(detalle).save();
}

function compartirReporte() {
  // Obtener datos del reporte actual
  const reporteId = {{ reporte.id if reporte and reporte.id else 'null' }};
  const empresaNombre = '{{ empresa.nombre_empresa if empresa else (reporte.empresa_nombre if reporte else "Empresa") }}';
  const periodo = '{{ reporte.fecha_inicio }} - {{ reporte.fecha_fin }}';
  
  if (!reporteId) {
    alert('Error: No se puede compartir este reporte');
    return;
  }
  
  // Mostrar loading
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.innerHTML = '<span>‚è≥</span> Generando enlace...';
  btn.disabled = true;
  
  // Hacer petici√≥n para generar enlace
  fetch(`${metaAdsBaseUrl}/compartir_reporte`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      reporte_id: reporteId,
      empresa_nombre: empresaNombre,
      periodo: periodo,
      nombre_nora: nombreNora
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.ok) {
      // Mostrar modal con el enlace generado
      mostrarModalCompartir(data.url_publico);
    } else {
      alert('Error al generar enlace: ' + (data.error || 'Error desconocido'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error al generar enlace de compartir');
  })
  .finally(() => {
    // Restaurar bot√≥n
    btn.innerHTML = originalText;
    btn.disabled = false;
  });
}

function mostrarModalCompartir(urlPublico) {
  // Crear modal din√°micamente
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h3 class="text-lg font-bold mb-4">üîó Enlace de reporte generado</h3>
      <p class="text-gray-600 mb-4">Comparte este enlace con tu cliente:</p>
      <div class="bg-gray-100 p-3 rounded border mb-4">
        <input type="text" id="enlaceCompartir" value="${urlPublico}" class="w-full bg-transparent text-sm" readonly>
      </div>
      <div class="flex gap-2">
        <button onclick="copiarEnlace()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          üìã Copiar
        </button>
        <button onclick="cerrarModal()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
          Cerrar
        </button>
      </div>
    </div>
  `;
  
  // Funciones para el modal
  window.copiarEnlace = function() {
    const input = document.getElementById('enlaceCompartir');
    input.select();
    input.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    // Cambiar texto del bot√≥n temporalmente
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚úÖ Copiado!';
    setTimeout(() => {
      btn.innerHTML = originalText;
    }, 2000);
  };
  
  window.cerrarModal = function() {
    document.body.removeChild(modal);
    delete window.copiarEnlace;
    delete window.cerrarModal;
  };
  
  // Cerrar modal al hacer clic fuera
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      window.cerrarModal();
    }
  });
  
  document.body.appendChild(modal);
}
</script>
{% endblock %}
