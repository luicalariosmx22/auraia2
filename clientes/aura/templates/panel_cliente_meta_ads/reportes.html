{% extends "base_cliente.html" %}
{% block contenido %}
<script>
const nombreNora = "{{ nombre_nora }}";
const metaAdsBaseUrl = `/panel_cliente/${nombreNora}/meta_ads`;

function generarReporteSemanal() {
  const statusDiv = document.getElementById('reporte-status');
  statusDiv.innerHTML = '<div class="text-blue-600 font-semibold">‚è≥ Generando reporte semanal...</div>';
  
  fetch(`${metaAdsBaseUrl}/sincronizar-semanal`)
    .then(response => response.json())
    .then(data => {
      if (data.ok) {
        statusDiv.innerHTML = '<div class="text-green-600 font-semibold">‚úÖ Reporte semanal generado exitosamente</div>';
        setTimeout(() => location.reload(), 2000);
      } else {
        statusDiv.innerHTML = '<div class="text-red-600 font-semibold">‚ùå Error al generar el reporte</div>';
      }
    })
    .catch(error => {
      statusDiv.innerHTML = '<div class="text-red-600 font-semibold">‚ùå Error de conexi√≥n</div>';
    });
}

function sincronizarCompleto() {
  const statusDiv = document.getElementById('sincronizacion-status');
  statusDiv.innerHTML = '<div class="text-blue-600 font-semibold">‚è≥ Sincronizando datos de Meta Ads (7 d√≠as)... Esto puede tomar varios minutos.</div>';
  
  fetch(`${metaAdsBaseUrl}/sincronizar_completo`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      dias_atras: 7
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.ok) {
      statusDiv.innerHTML = `
        <div class="text-green-600 font-semibold">
          ‚úÖ Sincronizaci√≥n exitosa!<br>
          üìä Cuentas procesadas: ${data.cuentas_procesadas}<br>
          ‚úÖ Cuentas exitosas: ${data.cuentas_exitosas}<br>
          üìÖ Per√≠odo: ${data.fecha_inicio} a ${data.fecha_fin}
          ${data.errores.length > 0 ? '<br>‚ö†Ô∏è Errores: ' + data.errores.length : ''}
        </div>
      `;
      // Recargar p√°gina despu√©s de 3 segundos para mostrar nuevos datos
      setTimeout(() => location.reload(), 3000);
    } else {
      statusDiv.innerHTML = `<div class="text-red-600 font-semibold">‚ùå Error: ${data.error}</div>`;
    }
  })
  .catch(error => {
    statusDiv.innerHTML = `<div class="text-red-600 font-semibold">‚ùå Error de conexi√≥n: ${error.message}</div>`;
  });
}
</script>
<div class="max-w-7xl mx-auto py-10 px-4">
  <!-- Navegaci√≥n Superior -->
  <div class="flex items-center justify-between mb-6">
    <a href="{{ url_for('panel_cliente_meta_ads_bp.panel_cliente_meta_ads', nombre_nora=nombre_nora) }}" 
       class="text-blue-700 hover:underline font-semibold flex items-center">
       <i class="fa fa-arrow-left mr-2"></i> Regresar al panel
    </a>
    <div class="flex gap-3">
      <!-- Enlace a Dise√±o de Reportes eliminado -->
      <a href="{{ url_for('panel_cliente_meta_ads_bp.vista_cuentas_publicitarias', nombre_nora=nombre_nora) }}" 
         class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition flex items-center">
         <i class="fa fa-briefcase mr-2"></i> Cuentas Publicitarias
      </a>
      <a href="{{ url_for('panel_cliente_meta_ads_bp.panel_cliente_meta_ads', nombre_nora=nombre_nora) }}" 
         class="bg-yellow-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-700 transition flex items-center">
         <i class="fa fa-flask mr-2"></i> Meta Ads Lab
      </a>
    </div>
  </div>

  <h1 class="text-4xl font-extrabold text-center text-indigo-900 mb-8">Reportes de Meta Ads</h1>

  <!-- Panel de Control -->
  <div class="bg-white rounded-xl shadow-lg p-8 border border-indigo-100 mb-8">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- Bot√≥n de Generar Reporte -->
      <button onclick="generarReporteSemanal()" class="btn-tarjeta-meta tarjeta-azul">
        <span class="icono-btn"><i class="fa-solid fa-file-invoice"></i></span>
        <span>Generar<br>Reporte Semanal</span>
      </button>
      
      <!-- Bot√≥n de Sincronizaci√≥n Completa -->
      <button onclick="sincronizarCompleto()" class="btn-tarjeta-meta tarjeta-azul">
        <span class="icono-btn"><i class="fa-solid fa-sync-alt"></i></span>
        <span>Sincronizar Datos<br>(7 d√≠as)</span>
      </button>
      
      <!-- Bot√≥n de Reportes Archivados -->
      <a href="{{ url_for('panel_cliente_meta_ads_bp.vista_reportes_archivados', nombre_nora=nombre_nora) }}" class="btn-tarjeta-meta tarjeta-naranja text-decoration-none">
        <span class="icono-btn"><i class="fa-solid fa-archive"></i></span>
        <span>Reportes<br>Archivados</span>
      </a>
      
      <!-- Bot√≥n de Copiar Todos los Reportes -->
      <button onclick="copiarTodosLosReportes()" class="btn-tarjeta-meta tarjeta-verde">
        <span class="icono-btn"><i class="fa-solid fa-copy"></i></span>
        <span>Copiar Todos<br>los Reportes</span>
      </button>
    </div>

    <!-- √Årea de Estado -->
    <div id="reporte-status" class="mt-4 text-center text-lg"></div>
    <div id="sincronizacion-status" class="mt-4 text-center text-lg"></div>
    <div id="copia-reportes-status" class="mt-4 text-center text-lg"></div>
  </div>

  <!-- Listado de Reportes -->
  <div id="reportes-contenido" class="bg-white rounded-xl shadow-lg p-8 border border-indigo-100">
    {% if reportes %}
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm border border-gray-200 rounded-lg">
        <thead class="bg-indigo-50">
          <tr>
            <th class="px-4 py-2">Cliente</th>
            <th class="px-4 py-2">Hasta el</th>
            <th class="px-4 py-2">Gasto Total</th>
            <th class="px-4 py-2">Facebook</th>
            <th class="px-4 py-2">Instagram</th>
            <th class="px-4 py-2">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for reporte in reportes %}
          <tr class="border-b hover:bg-indigo-50 transition">
            <td class="px-4 py-2">{{ reporte.empresa_nombre or reporte.nombre_cliente or 'Sin empresa' }}</td>
            <td class="px-4 py-2">{{ reporte.fecha_fin }}</td>
            <td class="px-4 py-2 font-mono text-green-700 font-semibold">${{ "{:,.2f}".format(reporte.importe_gastado_campa√±as|float) if reporte.importe_gastado_campa√±as else '0.00' }}</td>
            <td class="px-4 py-2 text-blue-700 font-semibold">${{ "{:,.2f}".format(reporte.facebook_importe_gastado|float) if reporte.facebook_importe_gastado else '0.00' }}</td>
            <td class="px-4 py-2 text-pink-700 font-semibold">${{ "{:,.2f}".format(reporte.instagram_importe_gastado|float) if reporte.instagram_importe_gastado else '0.00' }}</td>
            <td class="px-4 py-2">
              <div class="flex gap-2">
                <a href="{{ url_for('panel_cliente_meta_ads_bp.detalle_reporte_ads', nombre_nora=nombre_nora, reporte_id=reporte.id) }}" 
                   class="text-blue-700 hover:underline font-semibold text-xs px-2 py-1 bg-blue-50 rounded">
                   üëÅÔ∏è Ver
                </a>
                <button onclick="compartirReporteMetaAds(this)" 
                        data-id="{{ reporte.id }}"
                        data-empresa="{{ reporte.empresa_nombre|default('Sin empresa', true) }}"
                        data-desde="{{ reporte.fecha_desde_fmt }}"
                        data-hasta="{{ reporte.fecha_hasta_fmt }}"
                        class="text-green-700 hover:underline font-semibold text-xs px-2 py-1 bg-green-50 rounded border-0 cursor-pointer">
                        üîó Compartir
                </button>
                <a href="/panel_cliente/{{ nombre_nora }}/meta_ads/reportes_semanales/{{ reporte.uuid }}/descargar" 
                   class="text-orange-700 hover:underline font-semibold text-xs px-2 py-1 bg-orange-50 rounded">
                   üìä Descargar
                </a>
                <button onclick="archivarReporte('{{ reporte.id }}', this)" 
                        class="text-red-700 hover:underline font-semibold text-xs px-2 py-1 bg-red-50 rounded border-0 cursor-pointer">
                        üóÑÔ∏è Archivar
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center text-gray-500 py-8">
      No hay reportes disponibles. Utiliza el bot√≥n "Generar Reporte" para crear uno nuevo.
    </div>
    {% endif %}
  </div>
</div>

<style>
.btn-tarjeta-meta {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: #f8fafc;
  border: 2px solid #e0e7ef;
  border-radius: 1.1rem;
  box-shadow: 0 2px 8px 0 rgba(60,60,120,0.08);
  padding: 1rem 1.5rem;
  min-width: 150px;
  min-height: 100px;
  font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
  font-weight: 700;
  font-size: 1.1rem;
  color: #283046;
  letter-spacing: 0.01em;
  transition: box-shadow 0.18s, border-color 0.18s, background 0.18s, color 0.18s, transform 0.18s;
  cursor: pointer;
  text-align: center;
  gap: 0.5rem;
  text-decoration: none;
}

.btn-tarjeta-meta:hover, .btn-tarjeta-meta:focus {
  border-color: #6366f1;
  box-shadow: 0 4px 16px 0 rgba(99,102,241,0.13);
  color: #3730a3;
  background: #f1f5fd;
  transform: translateY(-2px) scale(1.04);
}

.icono-btn {
  font-size: 2.1rem;
  margin-bottom: 0.2rem;
  color: #6366f1;
  transition: color 0.18s;
}

.tarjeta-azul {
  background: #eef2ff;
  border-color: #c7d2fe;
}
.tarjeta-azul .icono-btn { color: #4f46e5; }
.tarjeta-azul:hover, .tarjeta-azul:focus {
  background: #e0e7ff;
  border-color: #6366f1;
  color: #3730a3;
}

.tarjeta-verde {
  background: #f0fdf4;
  border-color: #bbf7d0;
}
.tarjeta-verde .icono-btn { color: #16a34a; }
.tarjeta-verde:hover, .tarjeta-verde:focus {
  background: #dcfce7;
  border-color: #16a34a;
  color: #14532d;
}

.tarjeta-naranja {
  background: #fff7ed;
  border-color: #fed7aa;
}
.tarjeta-naranja .icono-btn { color: #ea580c; }
.tarjeta-naranja:hover, .tarjeta-naranja:focus {
  background: #ffedd5;
  border-color: #ea580c;
  color: #9a3412;
}

.tarjeta-roja {
  background: #fef2f2;
  border-color: #fecaca;
}
.tarjeta-roja .icono-btn { color: #ef4444; }
.tarjeta-roja:hover, .tarjeta-roja:focus {
  background: #fee2e2;
  border-color: #ef4444;
  color: #991b1b;
}

.btn-tarjeta-meta:active {
  transform: scale(0.97);
  box-shadow: 0 1.5px 4px 0 rgba(60,60,120,0.08);
}
</style>


{% endblock contenido %}

{% block scripts %}
<!-- Font Awesome para iconos -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/reportes_meta_ads.js') }}?v=20250723-{{ range(1000000) | random }}"></script>

<script>
function sincronizarCompleto() {
  const statusDiv = document.getElementById('sincronizacion-status');
  statusDiv.innerHTML = '‚è≥ Sincronizando datos de los √∫ltimos 7 d√≠as...';
  
  fetch(`/panel_cliente/{{ nombre_nora }}/meta_ads/sincronizar_completo`, {
    method: "POST",
    headers: { 
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      "dias": 7
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.ok) {
      statusDiv.innerHTML = `‚úÖ Sincronizaci√≥n exitosa`;
      setTimeout(() => location.reload(), 3000); // Recargar despu√©s de 3 segundos
    } else {
      statusDiv.innerHTML = `‚ùå Error: ${data.error}`;
    }
  })
  .catch(err => {
    console.error(err);
    statusDiv.innerHTML = '‚ùå Error al sincronizar datos';
  });
}

function compartirReporteMetaAds(button) {
  // Obtener datos del reporte desde los atributos del bot√≥n
  const reporteId = button.getAttribute('data-id');
  const empresaNombre = button.getAttribute('data-empresa');
  const fechaDesde = button.getAttribute('data-desde');
  const fechaHasta = button.getAttribute('data-hasta');
  const periodo = `${fechaDesde} - ${fechaHasta}`;
  
  if (!reporteId) {
    alert('Error: No se puede compartir este reporte');
    return;
  }
  
  // Mostrar loading en el bot√≥n
  const originalText = button.innerHTML;
  button.innerHTML = '<span>‚è≥</span> Generando...';
  button.disabled = true;
  
  // Hacer petici√≥n para generar enlace
  fetch(`${metaAdsBaseUrl}/compartir_reporte`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      reporte_id: reporteId, // Enviar como string UUID, no como parseInt
      empresa_nombre: empresaNombre,
      periodo: periodo,
      nombre_nora: nombreNora
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.ok) {
      // Mostrar modal con el enlace generado
      mostrarModalCompartirReporte(data.url_publico, empresaNombre, periodo);
    } else {
      alert('Error al generar enlace: ' + (data.error || 'Error desconocido'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error al generar enlace de compartir');
  })
  .finally(() => {
    // Restaurar bot√≥n
    button.innerHTML = originalText;
    button.disabled = false;
  });
}

function mostrarModalCompartirReporte(urlPublico, empresaNombre, periodo) {
  // Crear modal din√°micamente
  const modal = document.createElement('div');
  modal.className = 'modal fade';
  modal.id = 'modalCompartirReporte';
  modal.setAttribute('tabindex', '-1');
  modal.innerHTML = `
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">
            <i class="fas fa-share-alt me-2"></i>
            Enlace de Reporte Generado
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <strong><i class="fas fa-info-circle me-2"></i>Reporte listo para compartir</strong><br>
            <small>Empresa: <strong>${empresaNombre}</strong> | Per√≠odo: <strong>${periodo}</strong></small>
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-bold">Enlace p√∫blico:</label>
            <div class="input-group">
              <input type="text" id="enlaceCompartirReporte" value="${urlPublico}" class="form-control" readonly>
              <button class="btn btn-outline-primary" type="button" onclick="copiarEnlaceReporte()">
                <i class="fas fa-copy me-1"></i>Copiar
              </button>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="card border-primary h-100">
                <div class="card-body text-center">
                  <i class="fas fa-whatsapp text-success" style="font-size: 2rem;"></i>
                  <h6 class="card-title mt-2">WhatsApp</h6>
                  <button onclick="compartirWhatsApp('${urlPublico}', '${empresaNombre}', '${periodo}')" class="btn btn-success btn-sm">
                    <i class="fab fa-whatsapp me-1"></i>Compartir
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-info h-100">
                <div class="card-body text-center">
                  <i class="fas fa-envelope text-primary" style="font-size: 2rem;"></i>
                  <h6 class="card-title mt-2">Email</h6>
                  <button onclick="compartirEmail('${urlPublico}', '${empresaNombre}', '${periodo}')" class="btn btn-primary btn-sm">
                    <i class="fas fa-envelope me-1"></i>Enviar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" onclick="abrirReportePublico('${urlPublico}')">
            <i class="fas fa-external-link-alt me-1"></i>Ver Reporte
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Mostrar modal usando Bootstrap
  const bootstrapModal = new bootstrap.Modal(modal);
  bootstrapModal.show();
  
  // Limpiar modal cuando se cierre
  modal.addEventListener('hidden.bs.modal', function() {
    document.body.removeChild(modal);
  });
}

function copiarEnlaceReporte() {
  const input = document.getElementById('enlaceCompartirReporte');
  input.select();
  input.setSelectionRange(0, 99999);
  
  navigator.clipboard.writeText(input.value).then(function() {
    // Cambiar texto del bot√≥n temporalmente
    const btn = event.target;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check me-1"></i>¬°Copiado!';
    btn.classList.remove('btn-outline-primary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
      btn.innerHTML = originalHTML;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-primary');
    }, 2000);
  }).catch(function() {
    // Fallback para navegadores antiguos
    document.execCommand('copy');
    alert('Enlace copiado al portapapeles');
  });
}

function compartirWhatsApp(urlPublico, empresaNombre, periodo) {
  const mensaje = `üìä *Reporte Meta Ads - ${empresaNombre}*%0A%0AüóìÔ∏è Per√≠odo: ${periodo}%0A%0AüëÅÔ∏è Ver reporte: ${encodeURIComponent(urlPublico)}%0A%0A‚ú® _Generado por NoraAI_`;
  const urlWhatsApp = `https://wa.me/?text=${mensaje}`;
  window.open(urlWhatsApp, '_blank');
}

function compartirEmail(urlPublico, empresaNombre, periodo) {
  const asunto = `Reporte Meta Ads - ${empresaNombre} (${periodo})`;
  const cuerpo = `Hola,%0A%0ATE comparto el reporte de Meta Ads de ${empresaNombre} correspondiente al per√≠odo ${periodo}.%0A%0APuedes ver el reporte completo en el siguiente enlace:%0A${urlPublico}%0A%0ASaludos,%0AEquipo NoraAI`;
  
  const mailtoUrl = `mailto:?subject=${encodeURIComponent(asunto)}&body=${cuerpo}`;
  window.location.href = mailtoUrl;
}

function abrirReportePublico(urlPublico) {
  window.open(urlPublico, '_blank');
}

function copiarTodosLosReportes() {
  const statusDiv = document.getElementById('copia-reportes-status');
  if (!statusDiv) {
    // Crear div de status si no existe
    const nuevoStatusDiv = document.createElement('div');
    nuevoStatusDiv.id = 'copia-reportes-status';
    nuevoStatusDiv.className = 'mt-4 text-center text-lg';
    document.getElementById('sincronizacion-status').parentNode.appendChild(nuevoStatusDiv);
  }
  
  const statusDivFinal = document.getElementById('copia-reportes-status');
  statusDivFinal.innerHTML = '<div class="text-blue-600 font-semibold">‚è≥ Generando enlaces de todos los reportes...</div>';
  
  // Obtener todos los reportes de la tabla
  const botonesCompartir = document.querySelectorAll('button[data-id]');
  const reportes = Array.from(botonesCompartir).map(btn => ({
    id: btn.getAttribute('data-id'),
    empresa: btn.getAttribute('data-empresa'),
    desde: btn.getAttribute('data-desde'),
    hasta: btn.getAttribute('data-hasta')
  }));
  
  if (reportes.length === 0) {
    statusDivFinal.innerHTML = '<div class="text-orange-600 font-semibold">‚ö†Ô∏è No hay reportes disponibles para copiar</div>';
    return;
  }
  
  // Generar enlaces para todos los reportes
  Promise.all(reportes.map(reporte => 
    fetch(`${metaAdsBaseUrl}/compartir_reporte`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        reporte_id: reporte.id,
        empresa_nombre: reporte.empresa,
        periodo: `${reporte.desde} - ${reporte.hasta}`,
        nombre_nora: nombreNora
      })
    })
    .then(response => response.json())
    .then(data => ({
      empresa: reporte.empresa,
      periodo: `${reporte.desde} - ${reporte.hasta}`,
      url: data.ok ? data.url_publico : 'Error al generar enlace',
      success: data.ok
    }))
    .catch(() => ({
      empresa: reporte.empresa,
      periodo: `${reporte.desde} - ${reporte.hasta}`,
      url: 'Error de conexi√≥n',
      success: false
    }))
  ))
  .then(resultados => {
    // Crear texto para copiar
    let textoCopiar = 'üìä REPORTES META ADS - ENLACES P√öBLICOS\n';
    textoCopiar += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    
    const exitosos = resultados.filter(r => r.success);
    const fallidos = resultados.filter(r => !r.success);
    
    exitosos.forEach((resultado, index) => {
      textoCopiar += `${index + 1}. üè¢ ${resultado.empresa}\n`;
      textoCopiar += `   üìÖ ${resultado.periodo}\n`;
      textoCopiar += `   üîó ${resultado.url}\n\n`;
    });
    
    if (fallidos.length > 0) {
      textoCopiar += '‚ùå REPORTES CON ERRORES:\n';
      textoCopiar += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
      fallidos.forEach((resultado, index) => {
        textoCopiar += `${index + 1}. ‚ùå ${resultado.empresa} (${resultado.periodo})\n`;
      });
      textoCopiar += '\n';
    }
    
    textoCopiar += '‚ú® Generado por NoraAI\n';
    textoCopiar += `üìä Total de reportes: ${exitosos.length} exitosos, ${fallidos.length} con errores`;
    
    // Copiar al portapapeles
    navigator.clipboard.writeText(textoCopiar).then(() => {
      statusDivFinal.innerHTML = `
        <div class="text-green-600 font-semibold">
          ‚úÖ ¬°Enlaces copiados al portapapeles!<br>
          üìä ${exitosos.length} reportes exitosos
          ${fallidos.length > 0 ? `<br>‚ö†Ô∏è ${fallidos.length} reportes con errores` : ''}
        </div>
      `;
      
      // Mostrar modal con preview
      mostrarModalTodosLosReportes(textoCopiar, exitosos.length, fallidos.length);
      
    }).catch(() => {
      // Fallback para navegadores antiguos
      statusDivFinal.innerHTML = '<div class="text-orange-600 font-semibold">‚ö†Ô∏è No se pudo copiar autom√°ticamente. Usa el modal para copiar manualmente.</div>';
      mostrarModalTodosLosReportes(textoCopiar, exitosos.length, fallidos.length);
    });
    
  })
  .catch(error => {
    console.error('Error al generar enlaces:', error);
    statusDivFinal.innerHTML = '<div class="text-red-600 font-semibold">‚ùå Error al generar enlaces de reportes</div>';
  });
}

function mostrarModalTodosLosReportes(textoCopiar, exitosos, fallidos) {
  const modal = document.createElement('div');
  modal.className = 'modal fade';
  modal.id = 'modalTodosLosReportes';
  modal.setAttribute('tabindex', '-1');
  modal.innerHTML = `
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">
            <i class="fas fa-copy me-2"></i>
            Todos los Enlaces de Reportes (${exitosos} exitosos${fallidos > 0 ? `, ${fallidos} con errores` : ''})
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert ${fallidos > 0 ? 'alert-warning' : 'alert-success'}">
            <strong><i class="fas fa-info-circle me-2"></i>Enlaces generados</strong><br>
            <small>‚úÖ ${exitosos} reportes exitosos${fallidos > 0 ? ` | ‚ö†Ô∏è ${fallidos} con errores` : ''}</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-bold">Texto completo (ya copiado al portapapeles):</label>
            <textarea id="todosLosEnlaces" class="form-control" rows="15" readonly>${textoCopiar}</textarea>
          </div>
          
          <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-outline-primary" onclick="copiarTextoModal()">
              <i class="fas fa-copy me-1"></i>Copiar de Nuevo
            </button>
            <button class="btn btn-success" onclick="compartirTodosWhatsApp()">
              <i class="fab fa-whatsapp me-1"></i>Compartir por WhatsApp
            </button>
            <button class="btn btn-primary" onclick="compartirTodosEmail()">
              <i class="fas fa-envelope me-1"></i>Enviar por Email
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  const bootstrapModal = new bootstrap.Modal(modal);
  bootstrapModal.show();
  
  modal.addEventListener('hidden.bs.modal', function() {
    document.body.removeChild(modal);
  });
}

function copiarTextoModal() {
  const textarea = document.getElementById('todosLosEnlaces');
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  
  navigator.clipboard.writeText(textarea.value).then(() => {
    const btn = event.target;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check me-1"></i>¬°Copiado!';
    btn.classList.remove('btn-outline-primary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
      btn.innerHTML = originalHTML;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-primary');
    }, 2000);
  }).catch(() => {
    document.execCommand('copy');
    alert('Texto copiado al portapapeles');
  });
}

function compartirTodosWhatsApp() {
  const texto = document.getElementById('todosLosEnlaces').value;
  const mensaje = encodeURIComponent(texto);
  const urlWhatsApp = `https://wa.me/?text=${mensaje}`;
  window.open(urlWhatsApp, '_blank');
}

function compartirTodosEmail() {
  const texto = document.getElementById('todosLosEnlaces').value;
  const asunto = 'Reportes Meta Ads - Enlaces P√∫blicos';
  const cuerpo = encodeURIComponent(texto);
  
  const mailtoUrl = `mailto:?subject=${encodeURIComponent(asunto)}&body=${cuerpo}`;
  window.location.href = mailtoUrl;
}
</script>
{% endblock scripts %}
