<!-- ‚úÖ Archivo: clientes/aura/templates/panel_cliente_conocimiento/index.html -->
<!-- üëâ Plantilla base del m√≥dulo de Conocimiento -->
{% extends "base.html" %}

{% block content %}
<div class="p-6">
  <h1 class="text-3xl font-bold mb-4">üìö Base de Conocimiento</h1>

  <!-- üîò Bot√≥n nuevo -->
  <div class="mb-6">
    <button class="btn btn-primary">+ Nuevo bloque de conocimiento</button>
  </div>

  <!-- üè∑Ô∏è Filtro por etiqueta -->
  <div class="mb-4">
    <label class="block mb-2 font-semibold">Filtrar por etiqueta:</label>
    <select name="etiqueta" class="form-select">
      <option value="">Todas</option>
      {% for etiqueta in etiquetas %}
      <option value="{{ etiqueta }}">{{ etiqueta }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- üì¶ Columnas por etiqueta -->
  <div class="flex flex-wrap gap-4">
    {% for etiqueta, bloques in bloques_por_etiqueta.items() %}
    <div class="columna-etiqueta w-full md:w-1/2 lg:w-1/3 bg-gray-50 rounded shadow p-4">
      <h2 class="text-lg font-semibold mb-3">{{ etiqueta }}</h2>

      {% for bloque in bloques %}
      <div class="bloque-conocimiento bg-white border rounded p-4 mb-4 shadow-sm">
        <p class="text-sm mb-2">{{ bloque.contenido }}</p>

        <div class="flex flex-wrap gap-2 mb-2">
          {% for tag in bloque.etiquetas %}
          <span class="tag bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">{{ tag }}</span>
          {% endfor %}
        </div>

        <div class="flex items-center justify-between text-xs text-gray-500 mb-2">
          <span>
            {% if bloque.origen == 'manual' %}üß† Manual
            {% elif bloque.origen == 'pdf' %}üìÑ PDF
            {% elif bloque.origen == 'ia' %}ü§ñ IA
            {% endif %}
          </span>
          {% if bloque.prioridad %}
          <span class="prioridad text-yellow-500">‚≠ê</span>
          {% endif %}
        </div>

        <div class="text-xs text-gray-400 mb-2">
          Creado: {{ bloque.fecha_creacion[:10] }}
        </div>

        {% if bloque.servicios_vinculados %}
        <div class="text-xs text-green-600 mt-2">
          üîó {% if bloque.servicios_vinculados|length == 1 %}
          Vinculado a: <span class="chip-servicio">{{ bloque.servicios_vinculados[0] }}</span>
          {% else %}
          Servicios:
          {% for servicio in bloque.servicios_vinculados %}
          <span class="chip-servicio">{{ servicio }}</span>{% if not loop.last %},{% endif %}
          {% endfor %}
          {% endif %}
        </div>
        {% endif %}

        <!-- üõ†Ô∏è Acciones -->
        <div class="flex justify-between mt-3">
          <button class="btn btn-sm btn-outline">‚úèÔ∏è Editar</button>
          <button class="btn btn-sm btn-outline text-red-600">üóëÔ∏è Eliminar</button>
          <button class="btn btn-sm btn-outline text-yellow-500">‚≠ê Prioridad</button>
        </div>
      </div>
      {% endfor %}

      <!-- ‚ûï Agregar bloque a esta categor√≠a -->
      <div class="text-center mt-4">
        <button class="btn btn-secondary text-sm">+ Agregar bloque en esta categor√≠a</button>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("modal-bloque");
  const form = modal.querySelector("form");
  const alertBox = document.createElement("div");
  alertBox.className = "alert hidden p-2 mt-3 text-sm rounded";
  form.appendChild(alertBox);

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    limpiarAlertas();
    
    const submitBtn = form.querySelector("button[type='submit']");
    submitBtn.disabled = true;
    submitBtn.textContent = "Guardando...";

    const contenido = form.querySelector("textarea[name='contenido']").value.trim();
    const prioridad = form.querySelector("input[name='prioridad']").checked;
    const etiquetasSelect = form.querySelector("select[name='etiquetas']");
    const etiquetas = Array.from(etiquetasSelect.selectedOptions).map(opt => opt.value);
    const activoInput = form.querySelector("input[name='activo']");
    const activo = activoInput ? activoInput.checked : true;

    if (contenido.length === 0 || contenido.length > 500) {
      mostrarAlerta("El contenido debe tener entre 1 y 500 caracteres.", "error");
      resetBoton();
      return;
    }

    if (etiquetas.length === 0) {
      mostrarAlerta("Debes seleccionar al menos una etiqueta.", "error");
      resetBoton();
      return;
    }

    const data = {
      contenido,
      etiquetas,
      prioridad,
      activo
    };

    const actionUrl = form.getAttribute("action");

    try {
      const res = await fetch(actionUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();

      if (!res.ok) {
        mostrarAlerta(result.error || "Error al guardar bloque.", "error");
        resetBoton();
        return;
      }

      mostrarAlerta("‚úÖ Bloque guardado correctamente.", "success");
      setTimeout(() => {
        cerrarModal();
        if (typeof actualizarVistaConocimiento === "function") {
          actualizarVistaConocimiento();
        } else {
          location.reload();
        }
      }, 1000);

    } catch (error) {
      mostrarAlerta("‚ùå Error de conexi√≥n con el servidor.", "error");
    } finally {
      resetBoton();
    }
  });

  function mostrarAlerta(mensaje, tipo) {
    alertBox.textContent = mensaje;
    alertBox.classList.remove("hidden");
    alertBox.className = `alert ${tipo === "success" ? "bg-green-100 text-green-700" : "bg-red-100 text-red-700"} p-2 mt-3 text-sm rounded`;
  }

  function limpiarAlertas() {
    alertBox.textContent = "";
    alertBox.classList.add("hidden");
  }

  function resetBoton() {
    const btn = form.querySelector("button[type='submit']");
    btn.disabled = false;
    btn.textContent = "Guardar";
  }
});

// Funci√≥n global para cerrar modal
function cerrarModal() {
  document.getElementById("modal-bloque").classList.add("hidden");
}
</script>
