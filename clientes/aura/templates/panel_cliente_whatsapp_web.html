<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Web - {{ nombre_nora }}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <style>
    .qr-container {
        border: 2px dashed #ddd;
        padding: 20px;
        border-radius: 10px;
        min-height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #qr-canvas {
        border: 1px solid #ddd;
        border-radius: 8px;
    }
    
    .info-box {
        box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
        border-radius: .25rem;
        background: #fff;
        display: flex;
        margin-bottom: 1rem;
        min-height: 80px;
        padding: .5rem;
        position: relative;
        width: 100%;
    }
</style>
</head>
<body>

{% block contenido %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">
                        <i class="fab fa-whatsapp text-success"></i>
                        WhatsApp Web - {{ nombre_nora }}
                    </h3>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshStatus()">
                            <i class="fas fa-sync"></i> Actualizar
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="openBackendInNewTab()">
                            <i class="fas fa-external-link-alt"></i> Abrir Backend
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Estado del Backend -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="info-box">
                                <span class="info-box-icon bg-info">
                                    <i class="fas fa-server"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Backend Status</span>
                                    <span class="info-box-number" id="backend-status">
                                        {% if health_status %}
                                            <span class="badge badge-success">Online</span>
                                        {% else %}
                                            <span class="badge badge-danger">Offline</span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-box">
                                <span class="info-box-icon bg-warning">
                                    <i class="fas fa-link"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Conexi√≥n</span>
                                    <span class="info-box-number" id="connection-status">
                                        {% if client_status and client_status.connected %}
                                            <span class="badge badge-success">Conectado</span>
                                        {% else %}
                                            <span class="badge badge-secondary">Desconectado</span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-box">
                                <span class="info-box-icon bg-success">
                                    <i class="fab fa-whatsapp"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">WhatsApp</span>
                                    <span class="info-box-number" id="whatsapp-status">
                                        {% if detailed_status and detailed_status.authenticated %}
                                            <span class="badge badge-success">Autenticado</span>
                                        {% else %}
                                            <span class="badge badge-warning">No autenticado</span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Controles -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <!-- Bot√≥n principal para flujo completo -->
                            <div class="text-center mb-3">
                                <button class="btn btn-success btn-lg" onclick="startWhatsAppFlow()">
                                    <i class="fab fa-whatsapp"></i> Flujo Autom√°tico
                                </button>
                                <p class="text-muted mt-2">Conecta, inicia sesi√≥n y genera el QR autom√°ticamente</p>
                            </div>
                            
                            <!-- Controles individuales -->
                            <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
                                <button class="btn btn-outline-primary" onclick="connectToBackend()">
                                    <i class="fas fa-plug"></i> Conectar
                                </button>
                                <button class="btn btn-outline-success" onclick="initWhatsAppSession()">
                                    <i class="fas fa-play"></i> Iniciar Sesi√≥n
                                </button>
                                <button class="btn btn-outline-warning" onclick="refreshQR()">
                                    <i class="fas fa-qrcode"></i> Generar QR
                                </button>
                                <button class="btn btn-outline-info" onclick="checkWhatsAppStatus()">
                                    <i class="fas fa-search"></i> Verificar Estado
                                </button>
                                <button class="btn btn-outline-secondary" onclick="sendTestMessage()">
                                    <i class="fas fa-paper-plane"></i> Mensaje Prueba
                                </button>
                                <button class="btn btn-outline-warning" onclick="closeWhatsAppSession()">
                                    <i class="fas fa-stop"></i> Cerrar Sesi√≥n
                                </button>
                                <button class="btn btn-outline-danger" onclick="disconnectFromBackend()">
                                    <i class="fas fa-times"></i> Desconectar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Detallada -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Informaci√≥n del Backend</h5>
                                </div>
                                <div class="card-body">
                                    <dl class="row">
                                        <dt class="col-sm-4">URL:</dt>
                                        <dd class="col-sm-8">
                                            <small>{{ backend_url }}</small>
                                        </dd>
                                        <dt class="col-sm-4">Estado:</dt>
                                        <dd class="col-sm-8" id="backend-detailed-status">
                                            {% if health_status %}
                                                <span class="badge badge-success">{{ health_status.status }}</span>
                                                <small class="text-muted">{{ health_status.timestamp }}</small>
                                            {% else %}
                                                <span class="badge badge-danger">Sin respuesta</span>
                                            {% endif %}
                                        </dd>
                                        <dt class="col-sm-4">Sesi√≥n Activa:</dt>
                                        <dd class="col-sm-8" id="session-active">
                                            {% if detailed_status %}
                                                {{ "S√≠" if detailed_status.session_active else "No" }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">C√≥digo QR WhatsApp</h5>
                                    <div class="card-tools">
                                        <button class="btn btn-tool" onclick="refreshQR()">
                                            <i class="fas fa-sync"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body text-center">
                                    <div id="qr-container">
                                        <div id="qr-placeholder" class="text-muted">
                                            <i class="fas fa-qrcode fa-3x mb-2"></i>
                                            <p>Inicia sesi√≥n para generar el QR</p>
                                        </div>
                                        <div id="qr-code" style="display: none;">
                                            <canvas id="qr-canvas"></canvas>
                                            <p class="text-muted mt-2">Escanea este c√≥digo con tu WhatsApp</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Logs de Actividad -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Logs de Actividad</h5>
                                </div>
                                <div class="card-body">
                                    <div id="activity-logs" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                        <small class="text-muted">Los logs aparecer√°n aqu√≠...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Iframe del Backend (opcional) -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Interfaz del Backend WhatsApp Web</h5>
                                    <div class="card-tools">
                                        <button class="btn btn-tool" onclick="toggleIframe()">
                                            <i class="fas fa-eye" id="iframe-toggle-icon"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" id="iframe-container" style="display: none;">
                                    <iframe 
                                        src="{{ backend_url }}" 
                                        style="width: 100%; height: 600px; border: 1px solid #dee2e6; border-radius: 4px;"
                                        id="whatsapp-iframe">
                                    </iframe>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <p id="loading-message">Procesando...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let refreshInterval;
const backendUrl = "{{ backend_url }}";
const nombreNora = "{{ nombre_nora }}";

// Variables para WebSocket directo
let whatsappSocket = null;
let isConnectedToBackend = false;
let currentQR = null;
let isAuthenticated = false;

// Funci√≥n para agregar logs
function addLog(message, type = 'info') {
    const logsContainer = document.getElementById('activity-logs');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.className = `alert alert-${type} alert-sm mb-1`;
    logEntry.style.padding = '5px';
    logEntry.innerHTML = `<small><strong>${timestamp}</strong> - ${message}</small>`;
    logsContainer.appendChild(logEntry);
    logsContainer.scrollTop = logsContainer.scrollHeight;
}

// Funci√≥n para mostrar loading
function showLoading(message) {
    document.getElementById('loading-message').textContent = message;
    $('#loadingModal').modal('show');
}

// Funci√≥n para ocultar loading
function hideLoading() {
    $('#loadingModal').modal('hide');
}

// Funci√≥n para mostrar toast
function showToast(message, type = 'success') {
    toastr[type](message);
}

// Funci√≥n para actualizar estado visual
function updateStatusDisplay() {
    // Backend status
    document.getElementById('backend-status').innerHTML = 
        isConnectedToBackend ? 
        '<span class="badge badge-success">Online</span>' : 
        '<span class="badge badge-danger">Offline</span>';
    
    // Connection status
    document.getElementById('connection-status').innerHTML = 
        isConnectedToBackend ? 
        '<span class="badge badge-success">Conectado</span>' : 
        '<span class="badge badge-secondary">Desconectado</span>';
    
    // WhatsApp status
    document.getElementById('whatsapp-status').innerHTML = 
        isAuthenticated ? 
        '<span class="badge badge-success">Autenticado</span>' : 
        '<span class="badge badge-warning">No autenticado</span>';
        
    // Session active
    document.getElementById('session-active').textContent = 
        isConnectedToBackend ? 'S√≠' : 'No';
}

// IMPLEMENTACI√ìN WEBSOCKET DIRECTO COMO EN LA DOCUMENTACI√ìN
function connectToBackend() {
    if (isConnectedToBackend) {
        addLog('Ya est√° conectado al backend', 'info');
        showToast('Ya conectado', 'info');
        return;
    }
    
    showLoading('Conectando al backend WhatsApp Web...');
    addLog('üîó Conectando directamente al backend via WebSocket...', 'info');
    
    try {
        // Conectar al servidor WebSocket como indica la documentaci√≥n
        whatsappSocket = io(backendUrl);
        
        // Eventos del cliente como en la documentaci√≥n
        whatsappSocket.on('connect', () => {
            console.log('‚úÖ Conectado al servidor WhatsApp');
            console.log('üîó Backend URL:', backendUrl);
            isConnectedToBackend = true;
            updateStatusDisplay();
            hideLoading();
            addLog('‚úÖ Conectado al backend WhatsApp Web via WebSocket', 'success');
            addLog(`üåê Backend URL: ${backendUrl}`, 'info');
            showToast('WebSocket conectado exitosamente', 'success');
        });
        
        whatsappSocket.on('qr_code', (data) => {
            console.log('üì± QR Code recibido:', data);
            addLog('üì± QR Code recibido del backend', 'success');
            
            // Mostrar QR en el DOM como indica la documentaci√≥n
            if (data.qr_data) {
                currentQR = data.qr_data;
                displayQR(data.qr_data);
                showToast('QR generado - Escanea con WhatsApp', 'success');
                
                // Si es imagen, mostrarla directamente
                if (data.qr_data.startsWith('data:image/')) {
                    addLog('‚úÖ QR real recibido como imagen PNG', 'success');
                } else {
                    addLog('üì± QR recibido como texto de WhatsApp Web', 'info');
                }
            }
            
            // Actualizar estado si viene en la respuesta
            if (data.session_id) {
                addLog(`üÜî Session ID: ${data.session_id}`, 'info');
            }
        });
        
        // Evento 'connected' del backend
        whatsappSocket.on('connected', (data) => {
            console.log('üì° Backend confirm√≥ conexi√≥n:', data);
            addLog('üì° Backend confirm√≥ conexi√≥n exitosa', 'success');
            if (data.client_id) {
                addLog(`üÜî Client ID: ${data.client_id}`, 'info');
            }
            if (data.message) {
                addLog(`üí¨ ${data.message}`, 'info');
            }
        });
        
        whatsappSocket.on('whatsapp_status', (data) => {
            console.log('üìä Estado WhatsApp:', data);
            addLog(`üìä Estado WhatsApp: ${JSON.stringify(data)}`, 'info');
            
            if (data.status === 'authenticated') {
                console.log('üéâ WhatsApp autenticado exitosamente');
                isAuthenticated = true;
                updateStatusDisplay();
                hideQR();
                addLog('üéâ WhatsApp autenticado exitosamente', 'success');
                showToast('¬°WhatsApp autenticado!', 'success');
            }
        });
        
        whatsappSocket.on('authenticated', (data) => {
            console.log('üéâ Evento authenticated recibido:', data);
            isAuthenticated = true;
            updateStatusDisplay();
            hideQR();
            addLog('üéâ WhatsApp Web autenticado exitosamente', 'success');
            showToast('¬°Autenticaci√≥n exitosa!', 'success');
        });
        
        whatsappSocket.on('error', (error) => {
            console.error('‚ùå Error:', error);
            
            // Extraer mensaje del error
            const errorMessage = error.message || error.toString();
            
            // Distinguir entre errores de conexi√≥n y errores de aplicaci√≥n
            if (errorMessage.includes('Chrome') || errorMessage.includes('browser')) {
                addLog('‚ö†Ô∏è Backend necesita Chrome para generar QR real', 'warning');
                showToast('Backend necesita Chrome - conexi√≥n WebSocket OK', 'warning');
            } else if (errorMessage.includes('iniciando sesi√≥n') || errorMessage.includes('WhatsApp Web')) {
                addLog('‚ö†Ô∏è Error generando QR real - conexi√≥n WebSocket funciona', 'warning');
                showToast('Error generando QR real - WebSocket conectado', 'warning');
                // NO desconectar - el WebSocket funciona, solo falta Chrome
            } else if (errorMessage.includes('conexi√≥n') || errorMessage.includes('connection')) {
                addLog('‚ùå Error de conexi√≥n WebSocket', 'danger');
                showToast('Error de conexi√≥n WebSocket', 'error');
                isConnectedToBackend = false;
                updateStatusDisplay();
            } else {
                addLog(`‚ùå Error del backend: ${errorMessage}`, 'danger');
                showToast('Error en el backend - WebSocket OK', 'warning');
                // NO desconectar - podr√≠a ser un error temporal
            }
        });
        
        whatsappSocket.on('disconnect', () => {
            console.log('üîå Desconectado del backend');
            isConnectedToBackend = false;
            isAuthenticated = false;
            updateStatusDisplay();
            addLog('üîå Desconectado del backend', 'warning');
        });
        
        whatsappSocket.on('connect_error', (error) => {
            console.error('‚ùå Error de conexi√≥n:', error);
            hideLoading();
            addLog(`‚ùå Error conectando: ${error.message || error}`, 'danger');
            showToast('Error conectando al backend', 'error');
        });
        
    } catch (error) {
        hideLoading();
        addLog(`‚ùå Error: ${error.message}`, 'danger');
        showToast('Error de conexi√≥n', 'error');
    }
}

function disconnectFromBackend() {
    if (!isConnectedToBackend) {
        addLog('No est√° conectado', 'info');
        return;
    }
    
    showLoading('Desconectando...');
    
    if (whatsappSocket) {
        whatsappSocket.disconnect();
        whatsappSocket = null;
    }
    
    isConnectedToBackend = false;
    isAuthenticated = false;
    currentQR = null;
    updateStatusDisplay();
    hideQR();
    hideLoading();
    
    addLog('üîå Desconectado del backend', 'warning');
    showToast('Desconectado', 'success');
}

function initWhatsAppSession() {
    if (!isConnectedToBackend) {
        addLog('‚ùå No conectado al backend - Conecta primero', 'danger');
        showToast('Conecta al backend primero', 'error');
        return;
    }
    
    showLoading('Iniciando sesi√≥n WhatsApp Web...');
    addLog('üöÄ Solicitando c√≥digo QR...', 'info');
    
    // Solicitar c√≥digo QR como indica la documentaci√≥n
    whatsappSocket.emit('get_qr', {});
}

function refreshQR() {
    if (!isConnectedToBackend) {
        addLog('‚ùå No conectado al backend', 'danger');
        showToast('Conecta al backend primero', 'error');
        return;
    }
    
    showLoading('Obteniendo c√≥digo QR...');
    addLog('üîÑ Solicitando QR fresco...', 'info');
    
    // Solicitar QR fresco
    whatsappSocket.emit('get_qr', {
        force_refresh: true,
        timestamp: new Date().toISOString()
    });
}

function checkWhatsAppStatus() {
    if (!isConnectedToBackend) {
        addLog('‚ùå No conectado al backend', 'danger');
        showToast('Conecta al backend primero', 'error');
        return;
    }
    
    showLoading('Verificando estado...');
    addLog('üìä Verificando estado de WhatsApp Web...', 'info');
    
    // Probar funcionalidad como indica la documentaci√≥n
    whatsappSocket.emit('get_status', {
        action: 'check_connection'
    });
    
    setTimeout(() => {
        hideLoading();
        addLog('‚úÖ Verificaci√≥n completada', 'success');
        showToast('Estado verificado', 'success');
    }, 2000);
}

function sendTestMessage() {
    if (!isConnectedToBackend) {
        addLog('‚ùå No conectado al backend', 'danger');
        showToast('Conecta al backend primero', 'error');
        return;
    }
    
    if (!isAuthenticated) {
        addLog('‚ùå WhatsApp no est√° autenticado', 'danger');
        showToast('Autentica WhatsApp primero', 'error');
        return;
    }
    
    showLoading('Enviando mensaje de prueba...');
    addLog('üì§ Enviando mensaje de prueba...', 'info');
    
    // Enviar mensaje de prueba
    whatsappSocket.emit('test_whatsapp', {
        action: 'send_test_message',
        phone_number: '123456789',
        message: 'Mensaje de prueba desde NORA'
    });
    
    setTimeout(() => {
        hideLoading();
        addLog('‚úÖ Mensaje de prueba enviado', 'success');
        showToast('Mensaje enviado', 'success');
    }, 2000);
}

function closeWhatsAppSession() {
    if (!isConnectedToBackend) {
        addLog('‚ùå No conectado al backend', 'danger');
        return;
    }
    
    showLoading('Cerrando sesi√≥n...');
    addLog('üîí Cerrando sesi√≥n WhatsApp Web...', 'info');
    
    // Cerrar sesi√≥n
    whatsappSocket.emit('close_session', {});
    
    isAuthenticated = false;
    currentQR = null;
    updateStatusDisplay();
    hideQR();
    hideLoading();
    
    addLog('üîí Sesi√≥n cerrada', 'warning');
    showToast('Sesi√≥n cerrada', 'success');
}

// Funci√≥n de estado simplificada (no hace requests HTTP)
function refreshStatus() {
    updateStatusDisplay();
    addLog('üìä Estado actualizado', 'info');
}

// Flujo autom√°tico usando WebSocket directo
function startWhatsAppFlow() {
    addLog('üöÄ Iniciando flujo autom√°tico de WhatsApp Web...', 'info');
    showLoading('Ejecutando flujo autom√°tico...');
    
    // Paso 1: Conectar si no est√° conectado
    if (!isConnectedToBackend) {
        connectToBackend();
        
        // Esperar conexi√≥n y luego solicitar QR
        setTimeout(() => {
            if (isConnectedToBackend) {
                addLog('‚úÖ Conectado, solicitando QR...', 'success');
                whatsappSocket.emit('get_qr', {});
                hideLoading();
            } else {
                hideLoading();
                addLog('‚ùå No se pudo conectar autom√°ticamente', 'danger');
                showToast('Error en flujo autom√°tico', 'error');
            }
        }, 3000);
    } else {
        // Ya conectado, solicitar QR directamente
        whatsappSocket.emit('get_qr', {});
        hideLoading();
        addLog('üì± Solicitando QR (ya conectado)...', 'info');
    }
}

// Funci√≥n para abrir backend en nueva pesta√±a
function openBackendInNewTab() {
    window.open(backendUrl, '_blank');
    addLog('Backend abierto en nueva pesta√±a', 'info');
}

// Funci√≥n para mostrar/ocultar iframe
function toggleIframe() {
    const container = document.getElementById('iframe-container');
    const icon = document.getElementById('iframe-toggle-icon');
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        icon.className = 'fas fa-eye-slash';
    } else {
        container.style.display = 'none';
        icon.className = 'fas fa-eye';
    }
}

// Funci√≥n para mostrar QR
function displayQR(qrData) {
    console.log('üîß displayQR llamada con:', qrData ? `${qrData.substring(0, 50)}...` : 'null');
    
    const qrPlaceholder = document.getElementById('qr-placeholder');
    const qrCodeDiv = document.getElementById('qr-code');
    const canvas = document.getElementById('qr-canvas');
    
    if (!qrData) {
        console.warn('‚ö†Ô∏è No hay datos de QR para mostrar');
        addLog('No hay datos de QR', 'warning');
        return;
    }
    
    if (!canvas) {
        console.error('‚ùå No se encontr√≥ el canvas para QR');
        addLog('Error: Canvas QR no encontrado', 'danger');
        return;
    }
    
    console.log('üì± Procesando QR...');
    addLog('Procesando c√≥digo QR...', 'info');
    
    // Verificar si es un QR en formato base64 (imagen)
    if (qrData.startsWith('data:image/')) {
        console.log('üì± QR es una imagen base64, mostrando directamente');
        addLog('QR recibido como imagen - Mostrando directamente', 'success');
        
        // Mostrar imagen directamente
        qrCodeDiv.innerHTML = `
            <div class="text-center">
                <img src="${qrData}" alt="QR Code WhatsApp" style="max-width: 256px; max-height: 256px; border: 1px solid #ddd; border-radius: 8px;">
                <p class="mt-2 text-success">
                    <i class="fas fa-qrcode"></i> 
                    <strong>¬°Escanea este QR con tu WhatsApp!</strong>
                </p>
                <small class="text-muted">C√≥digo QR generado por el backend</small>
            </div>
        `;
        qrPlaceholder.style.display = 'none';
        qrCodeDiv.style.display = 'block';
        
        addLog('‚úÖ QR mostrado exitosamente', 'success');
        return;
    }
    
    // Verificar si QRCode.js est√° disponible para QR de texto
    if (typeof QRCode === 'undefined') {
        console.error('‚ùå QRCode.js no est√° disponible');
        addLog('QRCode.js no disponible, usando API alternativa...', 'warning');
        
        // Fallback: usar API de QR online
        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent(qrData)}`;
        
        qrCodeDiv.innerHTML = `
            <div class="text-center">
                <img src="${qrApiUrl}" alt="QR Code WhatsApp" 
                     style="max-width: 256px; max-height: 256px; border: 1px solid #ddd; border-radius: 8px;"
                     onload="console.log('‚úÖ QR cargado desde API externa')"
                     onerror="this.style.display='none'; document.getElementById('qr-fallback-text').style.display='block'">
                <p class="mt-2 text-success">
                    <i class="fas fa-qrcode"></i> 
                    <strong>¬°Escanea este QR con tu WhatsApp!</strong>
                </p>
                <small class="text-muted">QR generado via API externa</small>
                
                <!-- Fallback si la imagen tampoco carga -->
                <div id="qr-fallback-text" style="display: none;" class="alert alert-info mt-2">
                    <strong>QR como texto:</strong><br>
                    <code style="word-break: break-all; font-size: 10px;">${qrData}</code>
                    <hr>
                    <a href="${backendUrl}" target="_blank" class="btn btn-sm btn-primary">
                        <i class="fas fa-external-link-alt"></i> Ver en Backend
                    </a>
                </div>
            </div>
        `;
        qrPlaceholder.style.display = 'none';
        qrCodeDiv.style.display = 'block';
        
        addLog('‚úÖ QR mostrado con API externa', 'success');
        return;
    }
    
    try {
        // Limpiar canvas anterior
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        canvas.width = 256;
        canvas.height = 256;
        
        // Crear QR usando biblioteca QRCode.js
        QRCode.toCanvas(canvas, qrData, {
            width: 256,
            height: 256,
            margin: 2,
            color: {
                dark: '#000000',
                light: '#FFFFFF'
            }
        }, function (error) {
            if (error) {
                console.error('‚ùå Error generando QR:', error);
                addLog(`Error generando QR: ${error.message}`, 'danger');
                
                // Fallback en caso de error
                qrCodeDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error generando QR visual</strong><br>
                        <p>Error: ${error.message}</p>
                        <a href="${backendUrl}" target="_blank" class="btn btn-primary btn-sm">
                            Ver en Backend
                        </a>
                    </div>
                `;
            } else {
                console.log('‚úÖ QR generado exitosamente');
                addLog('C√≥digo QR generado exitosamente', 'success');
                qrPlaceholder.style.display = 'none';
                qrCodeDiv.style.display = 'block';
            }
        });
        
    } catch (error) {
        console.error('‚ùå Error con QRCode.js:', error);
        addLog(`Error con biblioteca QR: ${error.message}`, 'danger');
        
        // Fallback: mostrar informaci√≥n y enlace al backend
        qrCodeDiv.innerHTML = `
            <div class="alert alert-info">
                <h5><i class="fas fa-qrcode"></i> C√≥digo QR Generado</h5>
                <p>No se pudo generar la imagen QR, pero puedes verlo en el backend.</p>
                <a href="${backendUrl}" target="_blank" class="btn btn-success">
                    <i class="fas fa-external-link-alt"></i> Ver QR en Backend
                </a>
                <hr>
                <details>
                    <summary>Datos t√©cnicos del QR</summary>
                    <small style="word-break: break-all;">${qrData}</small>
                </details>
            </div>
        `;
        qrPlaceholder.style.display = 'none';
        qrCodeDiv.style.display = 'block';
    }
}

// Funci√≥n para ocultar QR
function hideQR() {
    const qrPlaceholder = document.getElementById('qr-placeholder');
    const qrCodeDiv = document.getElementById('qr-code');
    
    qrPlaceholder.style.display = 'block';
    qrCodeDiv.style.display = 'none';
}

// Funci√≥n para monitorear QR autom√°ticamente
function startQRMonitoring() {
    setInterval(() => {
        // Solo refrescar QR si no est√° autenticado y tenemos WebSocket
        if (isConnectedToBackend && !isAuthenticated) {
            // Solicitar estado actual via WebSocket
            whatsappSocket.emit('get_status', {});
        }
    }, 5000); // Cada 5 segundos
}

// Inicializar p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Verificar dependencias cr√≠ticas
    console.log('üîß Verificando dependencias...');
    console.log('jQuery:', typeof $ !== 'undefined');
    console.log('Bootstrap:', typeof $.fn.modal !== 'undefined');
    console.log('Toastr:', typeof toastr !== 'undefined');
    console.log('QRCode:', typeof QRCode !== 'undefined');
    
    // Configurar toastr si est√° disponible
    if (typeof toastr !== 'undefined') {
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "timeOut": "3000"
        };
    }
    
    // Agregar log inicial
    addLog('Panel WhatsApp Web iniciado', 'info');
    
    if (typeof QRCode === 'undefined') {
        addLog('‚ö†Ô∏è QRCode.js no disponible - usando fallback con API externa', 'warning');
    } else {
        addLog('‚úÖ QRCode.js cargado correctamente', 'success');
    }
    
    // Refrescar estado inicial
    refreshStatus();
    
    // NO configurar auto-refresh autom√°tico - solo manual
    // refreshInterval = setInterval(refreshStatus, 30000);
    
    addLog('‚úÖ Panel iniciado - Auto-refresh deshabilitado', 'info');
});

// Limpiar interval al salir
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});

// Inicializaci√≥n autom√°tica al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Inicializando panel WhatsApp Web...');
    addLog('üéØ Panel WhatsApp Web cargado', 'info');
    
    // Conectar autom√°ticamente al backend
    setTimeout(() => {
        console.log('üîÑ Conectando autom√°ticamente al backend...');
        connectToBackend();
    }, 1000);
});
</script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Toastr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- QRCode.js - Usando CDNJS que funciona -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>

<!-- Socket.IO Cliente -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

</body>
</html>

{% endblock %}
