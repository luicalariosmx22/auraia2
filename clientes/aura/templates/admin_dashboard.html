{% extends "base_admin_horizontal.html" %}

{% block titulo %}Panel Administrador{% endblock %}

{% block contenido %}
<div class="space-y-8">
  <h1 class="text-2xl font-bold text-gray-800">Panel de Administraci√≥n</h1>

  <!-- Secci√≥n de estad√≠sticas -->
  <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <!-- Noras activas -->
    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
      <h2 class="text-3xl font-bold text-gray-800">{{ total_noras }}</h2>
      <p class="text-gray-600 text-sm">Noras activas</p>
    </div>
    
    <!-- M√≥dulos -->
    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
      <h2 class="text-3xl font-bold text-gray-800">{{ total_modulos }}</h2>
      <p class="text-gray-600 text-sm">M√≥dulos</p>
    </div>
    
    <!-- Informaci√≥n de Twilio -->
    <div id="twilio-card" class="bg-white rounded-lg shadow p-4 border-l-4 
      {% if twilio_info.estado == 'BUENO' %}border-green-500
      {% elif twilio_info.estado == 'ADVERTENCIA' %}border-yellow-500
      {% elif twilio_info.estado == 'BAJO' %}border-orange-500
      {% elif twilio_info.estado == 'CRITICO' %}border-red-500
      {% else %}border-gray-500{% endif %}">
      <div class="flex justify-between items-start">
        <h2 id="twilio-saldo" class="text-3xl font-bold text-gray-800">${{ "%.2f"|format(twilio_info.saldo) }}</h2>
        <button class="text-gray-500 hover:bg-gray-100 rounded p-1 transition-colors duration-200" 
                onclick="refreshTwilioStatus()" 
                id="refresh-btn">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
      <p class="text-gray-600 text-sm">Saldo Twilio (<span id="twilio-moneda">{{ twilio_info.moneda }}</span>)</p>
      <span id="twilio-estado" class="inline-block mt-2 text-xs px-2 py-1 rounded-full font-medium
        {% if twilio_info.estado == 'BUENO' %}bg-green-100 text-green-800
        {% elif twilio_info.estado == 'ADVERTENCIA' %}bg-yellow-100 text-yellow-800
        {% elif twilio_info.estado == 'BAJO' %}bg-orange-100 text-orange-800
        {% elif twilio_info.estado == 'CRITICO' %}bg-red-100 text-red-800
        {% else %}bg-gray-100 text-gray-800{% endif %}">
        {{ twilio_info.estado }}
      </span>
      {% if twilio_info.error %}
      <p id="twilio-error" class="mt-2 text-xs text-red-600">Error: {{ twilio_info.error }}</p>
      {% endif %}
    </div>
    
    <!-- Informaci√≥n de OpenAI -->
    <div id="openai-card" class="bg-white rounded-lg shadow p-4 border-l-4 
      {% if openai_info.estado == 'BUENO' %}border-green-500
      {% elif openai_info.estado == 'ADVERTENCIA' %}border-yellow-500
      {% elif openai_info.estado == 'BAJO' %}border-orange-500
      {% elif openai_info.estado == 'CRITICO' %}border-red-500
      {% else %}border-gray-500{% endif %}">
      <div class="flex justify-between items-start">
        <h2 id="openai-uso" class="text-3xl font-bold text-gray-800">{{ "%.1f"|format(openai_info.porcentaje_usado or 0) }}%</h2>
        <button class="text-gray-500 hover:bg-gray-100 rounded p-1 transition-colors duration-200" 
                onclick="refreshOpenAIStatus()" 
                id="openai-refresh-btn">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
      <p class="text-gray-600 text-sm">Uso OpenAI (<span id="openai-periodo">{{ openai_info.periodo or 'N/A' }}</span>)</p>
      <p class="text-xs text-gray-500 mt-1">${{ "%.2f"|format(openai_info.uso_actual or 0) }} / ${{ openai_info.limite or 0 }}</p>
      <span id="openai-estado" class="inline-block mt-2 text-xs px-2 py-1 rounded-full font-medium
        {% if openai_info.estado == 'BUENO' %}bg-green-100 text-green-800
        {% elif openai_info.estado == 'ADVERTENCIA' %}bg-yellow-100 text-yellow-800
        {% elif openai_info.estado == 'BAJO' %}bg-orange-100 text-orange-800
        {% elif openai_info.estado == 'CRITICO' %}bg-red-100 text-red-800
        {% else %}bg-gray-100 text-gray-800{% endif %}">
        {{ openai_info.estado }}
      </span>
      {% if openai_info.error %}
      <p id="openai-error" class="mt-2 text-xs text-red-600">Error: {{ openai_info.error }}</p>
      {% endif %}
    </div>
  </section>

  <!-- Secci√≥n de acciones -->
  <section class="flex flex-wrap gap-4">
    <a href="/admin/nora/nueva" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
      + Crear nueva Nora
    </a>
    <a href="/admin/creador_modulos/crear" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm font-semibold">
      <span>‚ûï</span> Crear nuevo m√≥dulo
    </a>

    <a href="/admin/creador_modulos/gestionar" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm font-semibold">
      <span>üõ†Ô∏è</span> Gestor avanzado de m√≥dulos
    </a>

    <a href="/admin/verificador_modulos" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
      üîç Verificador de m√≥dulos
    </a>
  </section>

  <!-- Lista de Noras -->
  <section class="bg-white shadow rounded-lg overflow-hidden">
    <div class="px-4 py-5 sm:px-6">
      <h2 class="text-lg leading-6 font-medium text-gray-900">Lista de Noras</h2>
    </div>
    
    {% if noras %}
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IA</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">M√≥dulos</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for nora in noras %}
          <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ nora["nombre"] }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {% if nora["ia_activada"] %}
                <span class="text-green-500">‚úÖ</span>
              {% else %}
                <span class="text-gray-400">‚Äî</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ nora["modulos"] | join(", ") }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 flex gap-2">
              <a href="/panel_cliente/{{ nora['nombre'] }}" class="text-blue-600 hover:text-blue-900">Panel</a>
              <span class="text-gray-300">|</span>
              <a href="/admin/estadisticas/{{ nora['nombre'] }}" class="text-blue-600 hover:text-blue-900">Estad√≠sticas</a>
              <span class="text-gray-300">|</span>
              <a href="/admin/nora/editar?nombre={{ nora['nombre'] }}" class="text-blue-600 hover:text-blue-900">Editar</a>
              <span class="text-gray-300">|</span>
              <form action="/admin/noras/borrar_nora" method="post" class="inline">
                <input type="hidden" name="nombre" value="{{ nora['nombre'] }}">
                <button type="submit" class="text-red-600 hover:text-red-900 bg-transparent border-none p-0">Borrar</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <p class="px-6 py-4 text-sm text-gray-500">No hay Noras registradas a√∫n.</p>
    {% endif %}
  </section>
</div>

<script>
async function refreshTwilioStatus() {
  const refreshBtn = document.getElementById('refresh-btn');
  const twilioCard = document.getElementById('twilio-card');
  const twilioEstado = document.getElementById('twilio-estado');
  
  // Mostrar loading
  refreshBtn.classList.add('animate-spin');
  
  try {
    const response = await fetch('/admin/twilio/refresh');
    const result = await response.json();
    
    if (result.success && result.data) {
      const data = result.data;
      
      // Actualizar valores
      document.getElementById('twilio-saldo').textContent = `$${data.saldo.toFixed(2)}`;
      document.getElementById('twilio-moneda').textContent = data.moneda || 'USD';
      document.getElementById('twilio-estado').textContent = data.estado || 'ERROR';
      
      // Actualizar clases CSS
      twilioCard.className = 'bg-white rounded-lg shadow p-4 border-l-4';
      twilioEstado.className = 'inline-block mt-2 text-xs px-2 py-1 rounded-full font-medium';
      
      if (data.estado === 'BUENO') {
        twilioCard.classList.add('border-green-500');
        twilioEstado.classList.add('bg-green-100', 'text-green-800');
      } else if (data.estado === 'ADVERTENCIA') {
        twilioCard.classList.add('border-yellow-500');
        twilioEstado.classList.add('bg-yellow-100', 'text-yellow-800');
      } else if (data.estado === 'BAJO') {
        twilioCard.classList.add('border-orange-500');
        twilioEstado.classList.add('bg-orange-100', 'text-orange-800');
      } else if (data.estado === 'CRITICO') {
        twilioCard.classList.add('border-red-500');
        twilioEstado.classList.add('bg-red-100', 'text-red-800');
      } else {
        twilioCard.classList.add('border-gray-500');
        twilioEstado.classList.add('bg-gray-100', 'text-gray-800');
      }
      
      // Manejar errores
      const errorElement = document.getElementById('twilio-error');
      if (data.error) {
        if (errorElement) {
          errorElement.textContent = `Error: ${data.error}`;
        } else {
          const newError = document.createElement('p');
          newError.className = 'mt-2 text-xs text-red-600';
          newError.id = 'twilio-error';
          newError.textContent = `Error: ${data.error}`;
          twilioCard.appendChild(newError);
        }
      } else if (errorElement) {
        errorElement.remove();
      }
      
      console.log('‚úÖ Estado de Twilio actualizado:', data);
    }
  } catch (error) {
    console.error('‚ùå Error al actualizar estado de Twilio:', error);
  } finally {
    // Quitar loading
    refreshBtn.classList.remove('animate-spin');
  }
}

async function refreshOpenAIStatus() {
  const refreshBtn = document.getElementById('openai-refresh-btn');
  const openaiCard = document.getElementById('openai-card');
  const openaiEstado = document.getElementById('openai-estado');
  
  // Mostrar loading
  refreshBtn.classList.add('animate-spin');
  
  try {
    const response = await fetch('/admin/openai/refresh');
    const result = await response.json();
    
    if (result.success && result.data) {
      const data = result.data;
      
      // Actualizar valores
      document.getElementById('openai-uso').textContent = `${(data.porcentaje_usado || 0).toFixed(1)}%`;
      document.getElementById('openai-periodo').textContent = data.periodo || 'N/A';
      document.getElementById('openai-estado').textContent = data.estado || 'ERROR';
      
      // Actualizar clases CSS
      openaiCard.className = 'bg-white rounded-lg shadow p-4 border-l-4';
      openaiEstado.className = 'inline-block mt-2 text-xs px-2 py-1 rounded-full font-medium';
      
      if (data.estado === 'BUENO') {
        openaiCard.classList.add('border-green-500');
        openaiEstado.classList.add('bg-green-100', 'text-green-800');
      } else if (data.estado === 'ADVERTENCIA') {
        openaiCard.classList.add('border-yellow-500');
        openaiEstado.classList.add('bg-yellow-100', 'text-yellow-800');
      } else if (data.estado === 'BAJO') {
        openaiCard.classList.add('border-orange-500');
        openaiEstado.classList.add('bg-orange-100', 'text-orange-800');
      } else if (data.estado === 'CRITICO') {
        openaiCard.classList.add('border-red-500');
        openaiEstado.classList.add('bg-red-100', 'text-red-800');
      } else {
        openaiCard.classList.add('border-gray-500');
        openaiEstado.classList.add('bg-gray-100', 'text-gray-800');
      }
      
      // Actualizar detalle de uso
      const detalleElement = openaiCard.querySelector('.text-xs.text-gray-500');
      if (detalleElement) {
        detalleElement.textContent = `$${(data.uso_actual || 0).toFixed(2)} / $${data.limite || 0}`;
      }
      
      // Manejar errores
      const errorElement = document.getElementById('openai-error');
      if (data.error) {
        if (errorElement) {
          errorElement.textContent = `Error: ${data.error}`;
        } else {
          const newError = document.createElement('p');
          newError.className = 'mt-2 text-xs text-red-600';
          newError.id = 'openai-error';
          newError.textContent = `Error: ${data.error}`;
          openaiCard.appendChild(newError);
        }
      } else if (errorElement) {
        errorElement.remove();
      }
      
      console.log('‚úÖ Estado de OpenAI actualizado:', data);
    }
  } catch (error) {
    console.error('‚ùå Error al actualizar estado de OpenAI:', error);
  } finally {
    // Quitar loading
    refreshBtn.classList.remove('animate-spin');
  }
}

// Auto-refresh cada 5 minutos
setInterval(() => {
  refreshTwilioStatus();
  refreshOpenAIStatus();
}, 300000);
</script>
{% endblock %}
