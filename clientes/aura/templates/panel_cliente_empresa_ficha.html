{% extends "base_cliente.html" %}

{% block contenido %}
<div class="container mx-auto max-w-5xl px-2 py-4">  <!-- changed from max-w-3xl to max-w-5xl -->
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">🏢 Ficha de empresa</h2>
    <div class="flex gap-2">
        <a href="{{ url_for('panel_cliente_clientes_bp.vista_empresas', nombre_nora=nombre_nora) }}" class="text-blue-600 text-xs hover:underline">← Volver a empresas</a>
        <a href="{{ url_for('panel_cliente_clientes_bp.editar_empresa', empresa_id=empresa.id) }}" class="px-2 py-1 bg-blue-600 text-white rounded text-xs shadow-sm hover:bg-blue-700 transition">✏️ Editar empresa</a>
        <button type="button" onclick="exportarFichaEmpresaPDF()" class="px-2 py-1 bg-indigo-600 text-white rounded text-xs shadow-sm hover:bg-indigo-700 transition flex items-center gap-1"><span>📄</span> Exportar PDF</button>
    </div>
  </div>

  <!-- Perfil tipo red social y detalles en 3 columnas -->
  <div class="bg-white rounded-lg shadow p-6 border border-gray-200 mb-4 grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
    <!-- Columna 1: Perfil visual -->
    <div class="flex flex-col items-center">
      <div class="relative mb-3">
        <div class="w-36 h-36 rounded-full bg-gray-100 border-4 border-white shadow flex items-center justify-center overflow-hidden">
          {% if empresa.logo_url %}
            <img src="{{ empresa.logo_url }}" alt="Logo empresa" class="object-cover w-full h-full">
          {% else %}
            <span class="text-5xl text-gray-400">🏢</span>
          {% endif %}
        </div>
      </div>
      <h3 class="text-2xl font-bold text-gray-900 mb-1 text-center font-sans">{{ empresa.nombre_empresa }}</h3>
      <p class="text-gray-500 mb-2 text-center font-sans text-lg">{{ empresa.giro or '—' }}</p>
      <div class="flex flex-wrap gap-2 justify-center mb-2">
        {% if empresa.ciudad %}<span class="inline-flex items-center text-sm text-gray-600 font-sans"><i class="fa fa-map-marker-alt mr-1"></i>{{ empresa.ciudad }}</span>{% endif %}
        {% if empresa.pais %}<span class="inline-flex items-center text-sm text-gray-600 font-sans"><i class="fa fa-globe mr-1"></i>{{ empresa.pais }}</span>{% endif %}
        {% if empresa.sitio_web %}<a href="{{ empresa.sitio_web }}" target="_blank" class="inline-flex items-center text-sm text-blue-700 hover:underline font-sans"><i class="fa fa-link mr-1"></i>{{ empresa.sitio_web }}</a>{% endif %}
      </div>
      <div class="flex flex-wrap gap-1 justify-center mb-2">
        <span class="bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full font-sans">{{ empresa.tipo or 'Empresa' }}</span>
        <span class="bg-green-100 text-green-800 text-sm font-semibold px-3 py-1 rounded-full font-sans">{{ 'Activa' if empresa.activo else 'Inactiva' }}</span>
      </div>
      {% if empresa.cliente_id and empresa.cliente %}
        <div class="flex flex-wrap gap-1 justify-center mb-1">
          <span class="bg-yellow-100 text-yellow-800 text-sm font-semibold px-3 py-1 rounded-full font-sans">
            👤 {{ empresa.cliente.nombre_cliente }}
          </span>
          <button type="button" onclick="document.getElementById('modal-reunion').classList.remove('hidden')" class="px-3 py-1 bg-purple-600 text-white rounded text-sm font-semibold shadow-sm hover:bg-purple-700 transition font-sans">📅 Reunión</button>
        </div>
      {% endif %}
    </div>
    <!-- Columna 2 y 3: Detalles -->
    <div class="md:col-span-2">
      <table class="w-full text-sm font-sans align-top">
        <tbody>
          {% set detalles = [
            ('Razón social', empresa.razon_social or '-'),
            ('RFC', empresa.rfc or '-'),
            ('Email', empresa.email_empresa or '-'),
            ('Teléfono', empresa.telefono_empresa or '-'),
            ('Sitio web', empresa.sitio_web or '-'),
            ('Ubicación', empresa.ubicacion or '-'),
            ('Ciudad', empresa.ciudad or '-'),
            ('Estado', empresa.estado or '-'),
            ('País', empresa.pais or '-'),
            ('Representante legal', empresa.representante_legal or '-'),
            ('Email representante', empresa.email_representante or '-'),
            ('Teléfono representante', empresa.telefono_representante or '-'),
            ('Fecha alta', empresa.fecha_alta or '-'),
            ('Fecha baja', empresa.fecha_baja or '-'),
            ('Notas', empresa.notas or '-'),
            ('Tipo', empresa.tipo or '-'),
            ('Giro', empresa.giro or '-'),
            ('Activo', 'Sí' if empresa.activo else 'No'),
          ] %}
          {% for i in range(0, detalles|length, 2) %}
          <tr class="border-b border-gray-100 last:border-0">
            <td class="font-semibold text-gray-700 py-2 pr-2 w-40 align-top">{{ detalles[i][0] }}</td>
            <td class="text-gray-900 py-2 pr-4 align-top">{{ detalles[i][1] }}</td>
            {% if detalles[i+1] is defined %}
              <td class="font-semibold text-gray-700 py-2 pr-2 w-40 align-top">{{ detalles[i+1][0] }}</td>
              <td class="text-gray-900 py-2 align-top">{{ detalles[i+1][1] }}</td>
            {% else %}
              <td></td><td></td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- SUBMÓDULO: Contraseñas de redes sociales y plataformas digitales -->
  <div class="bg-white rounded-lg shadow p-4 border border-yellow-300 mb-4">
    <div class="flex items-center justify-between mb-2">
      <h4 class="text-lg font-semibold text-yellow-700">🔐 Contraseñas de redes y plataformas</h4>
      <a href="{{ url_for('panel_cliente_clientes_bp.editar_accesos_empresa', empresa_id=empresa.id) }}" class="px-3 py-1 bg-yellow-500 text-white rounded text-xs font-semibold shadow-sm hover:bg-yellow-600 transition">✏️ Editar accesos</a>
    </div>
    {% set accesos = accesos if accesos is defined else [] %}
    {% if accesos and accesos|length > 0 %}
      <table class="w-full text-sm border border-gray-200 rounded-lg overflow-hidden mb-2">
        <thead class="bg-yellow-50">
          <tr>
            <th class="px-3 py-2 text-left font-semibold">Plataforma</th>
            <th class="px-3 py-2 text-left font-semibold">Usuario / Email</th>
            <th class="px-3 py-2 text-left font-semibold">Contraseña</th>
            <th class="px-3 py-2 text-left font-semibold">Notas</th>
          </tr>
        </thead>
        <tbody>
          {% for acceso in accesos %}
          <tr class="border-t border-gray-100 hover:bg-yellow-50 transition">
            <td class="px-3 py-2 font-medium">{{ acceso.plataforma or '-' }}</td>
            <td class="px-3 py-2">{{ acceso.usuario or acceso.email or '-' }}</td>
            <td class="px-3 py-2 font-mono select-all">
              <span class="password-mask">••••••••</span>
              <button type="button" class="ml-2 text-xs text-blue-600 hover:underline show-password-btn" data-password="{{ acceso.password|e }}">ver</button>
            </td>
            <td class="px-3 py-2">{{ acceso.notas or '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="text-xs text-gray-500 mt-2">⚠️ Muestra solo a usuarios autorizados. Protege esta información.</p>
    {% else %}
      <p class="text-gray-500">No hay contraseñas registradas para esta empresa.</p>
    {% endif %}
  </div>

  <!-- TAREAS -->
  <div class="mb-4" id="seccion-tareas">
    <div class="flex items-center justify-between mb-2">
      <h4 class="text-lg font-semibold text-blue-700">📋 Tareas Activas</h4>
      <button type="button" onclick="exportarSeccionPDF('seccion-tareas', 'Tareas')" class="px-2 py-1 bg-indigo-600 text-white rounded text-xs shadow-sm hover:bg-indigo-700 transition flex items-center gap-1"><span>📄</span> Exportar PDF</button>
    </div>
    {% set tareas_activas = tareas | selectattr('estatus', 'ne', 'completada') | list %}
    {% set tareas_completadas = tareas | selectattr('estatus', 'equalto', 'completada') | list %}
    {% if tareas_activas %}
    <div class="overflow-x-auto rounded-lg shadow border border-gray-200 mb-4 bg-white">
      <table class="w-full text-sm align-middle">
        <thead class="bg-blue-50">
          <tr>
            <th class="px-3 py-2 text-left font-semibold">Prioridad</th>
            <th class="px-3 py-2 text-left font-semibold">Título</th>
            <th class="px-3 py-2 text-left font-semibold">Estatus</th>
            <th class="px-3 py-2 text-left font-semibold">Asignado a</th>
            <th class="px-3 py-2 text-left font-semibold">Fecha límite</th>
          </tr>
        </thead>
        <tbody>
          {% for t in tareas_activas %}
          <tr class="border-t border-gray-100 hover:bg-blue-50 transition">
            <td class="px-3 py-2">
              {% if t.prioridad == 'alta' %}<span class="text-red-600 font-bold">🔴 Alta</span>{% elif t.prioridad == 'media' %}<span class="text-yellow-600 font-bold">🟠 Media</span>{% else %}<span class="text-green-600 font-bold">🟢 Baja</span>{% endif %}
            </td>
            <td class="px-3 py-2">
              <span class="font-medium">{{ t.titulo }}</span>
              {% if t.recurrente or t.is_recurrente %}<span title="Tarea recurrente" class="ml-1">🔁</span>{% endif %}
            </td>
            <td class="px-3 py-2">
              {% if t.estatus == 'pendiente' %}<span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs">⏳ Pendiente</span>{% elif t.estatus == 'en progreso' %}<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs">🚧 En progreso</span>{% elif t.estatus == 'retrasada' %}<span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs">❗ Retrasada</span>{% elif t.estatus == 'completada' %}<span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs">✅ Completada</span>{% else %}{{ t.estatus|capitalize }}{% endif %}
            </td>
            <td class="px-3 py-2">{{ usuarios | selectattr('id', 'equalto', t.usuario_empresa_id) | map(attribute='nombre') | first or '—' }}</td>
            <td class="px-3 py-2">
              {% if t.fecha_limite %}
                <span>{{ t.fecha_limite }}</span>
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <p class="text-gray-500">No hay tareas activas ligadas a esta empresa.</p>
    {% endif %}
    {% if tareas_completadas %}
    <div class="overflow-x-auto rounded-lg shadow border border-gray-200 mt-2 bg-white">
      <h5 class="text-sm font-semibold text-gray-600 mb-2 mt-2">✅ Tareas completadas</h5>
      <table class="w-full text-sm align-middle opacity-70">
        <thead class="bg-blue-50">
          <tr>
            <th class="px-3 py-2 text-left font-semibold">Prioridad</th>
            <th class="px-3 py-2 text-left font-semibold">Título</th>
            <th class="px-3 py-2 text-left font-semibold">Estatus</th>
            <th class="px-3 py-2 text-left font-semibold">Asignado a</th>
            <th class="px-3 py-2 text-left font-semibold">Fecha límite</th>
          </tr>
        </thead>
        <tbody>
          {% for t in tareas_completadas %}
          <tr class="border-t border-gray-100 hover:bg-blue-50 transition">
            <td class="px-3 py-2">
              {% if t.prioridad == 'alta' %}<span class="text-red-600 font-bold">🔴 Alta</span>{% elif t.prioridad == 'media' %}<span class="text-yellow-600 font-bold">🟠 Media</span>{% else %}<span class="text-green-600 font-bold">🟢 Baja</span>{% endif %}
            </td>
            <td class="px-3 py-2">
              <span class="font-medium">{{ t.titulo }}</span>
              {% if t.recurrente or t.is_recurrente %}<span title="Tarea recurrente" class="ml-1">🔁</span>{% endif %}
            </td>
            <td class="px-3 py-2">
              <span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs">✅ Completada</span>
            </td>
            <td class="px-3 py-2">{{ usuarios | selectattr('id', 'equalto', t.usuario_empresa_id) | map(attribute='nombre') | first or '—' }}</td>
            <td class="px-3 py-2">
              {% if t.fecha_limite %}
                <span>{{ t.fecha_limite }}</span>
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>

  <!-- PAGOS / TRANSACCIONES -->
  <div class="mb-4" id="seccion-pagos">
    <div class="flex items-center justify-between mb-2">
      <h4 class="text-lg font-semibold text-green-700">💳 Transacciones</h4>
      <button type="button" onclick="exportarSeccionPDF('seccion-pagos', 'Pagos')" class="px-2 py-1 bg-indigo-600 text-white rounded text-xs shadow-sm hover:bg-indigo-700 transition flex items-center gap-1"><span>📄</span> Exportar PDF</button>
    </div>
    {% if pagos %}
    <div class="overflow-x-auto rounded-lg shadow border border-gray-200 mb-2 bg-white">
      <table class="w-full text-sm align-middle">
        <thead class="bg-green-50">
          <tr>
            <th class="px-3 py-2 text-left font-semibold">Concepto</th>
            <th class="px-3 py-2 text-left font-semibold">Fecha vencimiento</th>
            <th class="px-3 py-2 text-left font-semibold">Monto</th>
            <th class="px-3 py-2 text-left font-semibold">Estatus</th>
          </tr>
        </thead>
        <tbody>
          {% for p in pagos %}
          <tr class="border-t border-gray-100 hover:bg-green-50 transition">
            <td class="px-3 py-2">{{ p.concepto or '—' }}</td>
            <td class="px-3 py-2">{{ p.fecha_vencimiento or '—' }}</td>
            <td class="px-3 py-2 font-mono text-green-700 font-semibold">${{ '%.2f'|format(p.monto|float) if p.monto else '—' }}</td>
            <td class="px-3 py-2">
              {% if p.estatus == 'pagado' %}
                <span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-semibold">Pagado</span>
              {% elif p.estatus == 'pendiente' %}
                <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-semibold">Pendiente</span>
              {% elif p.estatus == 'vencido' %}
                <span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs font-semibold">Vencido</span>
              {% else %}
                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-xs font-semibold">{{ p.estatus or '—' }}</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <p class="text-gray-500">No hay transacciones registradas para esta empresa.</p>
    {% endif %}
  </div>

  <!-- REUNIONES -->
  <div class="mb-4" id="seccion-reuniones">
    <div class="flex items-center justify-between mb-2">
        <h4 class="text-lg font-semibold text-purple-700">📅 Reuniones con el cliente</h4>
        <button type="button" onclick="exportarSeccionPDF('seccion-reuniones', 'Reuniones')" class="px-2 py-1 bg-indigo-600 text-white rounded text-xs shadow-sm hover:bg-indigo-700 transition flex items-center gap-1"><span>📄</span> Exportar PDF</button>
      </div>
    {% if reuniones %}
      <div class="overflow-x-auto rounded-lg shadow border border-gray-200 bg-white">
        <table class="w-full text-sm align-middle">
          <thead class="bg-purple-50">
            <tr>
              <th class="px-3 py-2 text-left font-semibold">Fecha y hora</th>
              <th class="px-3 py-2 text-left font-semibold">Participantes</th>
              <th class="px-3 py-2 text-left font-semibold">Minuta</th>
              <th class="px-3 py-2 text-left font-semibold">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for r in reuniones %}
            <tr class="border-t border-gray-100 hover:bg-purple-50 transition">
              <td class="px-3 py-2">{{ r.fecha_hora|default('-', true) }}</td>
              <td class="px-3 py-2">{{ r.participantes or '-' }}</td>
              <td class="px-3 py-2 truncate max-w-xs">
                <span class="text-gray-700 text-xs">{{ r.minuta[:60] }}{% if r.minuta and r.minuta|length > 60 %}...{% endif %}</span>
              </td>
              <td class="px-3 py-2">
                <button type="button" onclick="document.getElementById('minuta-{{ r.id }}').classList.remove('hidden')" class="text-purple-700 hover:underline text-xs font-semibold">Ver minuta</button>
              </td>
            </tr>
            <!-- Modal Minuta -->
            <div id="minuta-{{ r.id }}" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
              <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-5xl relative">
                <button type="button" onclick="document.getElementById('minuta-{{ r.id }}').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
                <h3 class="text-lg font-bold mb-4 text-purple-700 flex items-center gap-2">📝 Minuta de reunión</h3>
                <div class="mb-2 text-xs text-gray-500">Fecha: {{ r.fecha_hora or '-' }} | Participantes: {{ r.participantes or '-' }}</div>
                <div class="whitespace-pre-line text-gray-800 text-sm border rounded p-3 bg-gray-50 overflow-x-auto" id="minuta-texto-{{ r.id }}">{{ r.minuta }}</div>
                <div class="flex justify-end mt-4 gap-2">
                  <button type="button"
                          class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700"
                          data-id="{{ r.id }}"
                          data-fecha="{{ r.fecha_hora or '-' }}"
                          data-participantes="{{ r.participantes or '-' }}"
                          onclick="exportarMinutaPDF(this)"
                  >Exportar</button>
                  <button type="button" onclick="document.getElementById('minuta-{{ r.id }}').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Cerrar</button>
                </div>
              </div>
            </div>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-gray-500">No hay reuniones registradas para esta empresa.</p>
    {% endif %}
  </div>

  <!-- Modal para registrar reunión -->
  <div id="modal-reunion" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg relative">
      <button type="button" onclick="document.getElementById('modal-reunion').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
      <h3 class="text-lg font-bold mb-4 text-purple-700 flex items-center gap-2">
        {% if empresa.cliente %}
          📅 Registrar reunión con {{ empresa.cliente.nombre_cliente }}
        {% else %}
          📅 Registrar reunión (sin cliente ligado)
        {% endif %}
      </h3>
      <form method="post" action="{{ url_for('panel_cliente_clientes_bp.registrar_reunion', empresa_id=empresa.id) }}">
        <div class="mb-3">
          <label class="block text-xs font-semibold mb-1">Fecha y hora</label>
          <input type="datetime-local" name="fecha_hora" required class="w-full px-3 py-2 border rounded-lg text-sm">
        </div>
        <div class="mb-3">
          <label class="block text-xs font-semibold mb-1">Participantes</label>
          <input type="text" name="participantes" placeholder="Ej: Juan, Ana, Cliente..." class="w-full px-3 py-2 border rounded-lg text-sm">
        </div>
        <div class="mb-3">
          <label class="block text-xs font-semibold mb-1">Minuta / Notas</label>
          <textarea name="minuta" rows="4" required class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Describe los temas tratados, acuerdos, tareas, etc."></textarea>
        </div>
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" onclick="document.getElementById('modal-reunion').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
          <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700">Guardar reunión</button>
        </div>
      </form>
    </div>
  </div>

  <!-- DOCUMENTOS IMPORTANTES -->
  <div class="mb-4" id="seccion-documentos">
    <div class="flex items-center justify-between mb-2">
      <h4 class="text-lg font-semibold text-indigo-700 mb-2">📄 Documentos importantes</h4>
      <div class="flex gap-2">
        <button type="button" onclick="exportarSeccionPDF('seccion-documentos', 'Documentos')" class="px-2 py-1 bg-indigo-600 text-white rounded text-xs shadow-sm hover:bg-indigo-700 transition flex items-center gap-1"><span>📄</span> Exportar PDF</button>
        <button type="button" onclick="document.getElementById('form-doc-nuevo').classList.toggle('hidden')" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm">Agregar documento</button>
      </div>
    </div>
    <form id="form-doc-nuevo" method="post" action="{{ url_for('panel_cliente_clientes_bp.agregar_documento', empresa_id=empresa.id) }}" class="flex flex-wrap gap-2 mb-3 bg-indigo-50 p-3 rounded-lg hidden">
      <input type="text" name="nombre" placeholder="Nombre del documento" class="border rounded px-2 py-1 text-sm flex-1 min-w-[180px]" required>
      <input type="url" name="url" placeholder="URL del documento" class="border rounded px-2 py-1 text-sm flex-1 min-w-[180px]" required>
      <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm">Guardar</button>
    </form>
    {% if documentos %}
    <ul class="divide-y divide-gray-100 bg-white rounded-lg shadow">
      {% for doc in documentos %}
      <li class="flex items-center justify-between px-4 py-2">
        <div>
          <a href="{{ doc.url }}" target="_blank" class="text-indigo-700 hover:underline font-medium">{{ doc.nombre }}</a>
          <span class="text-xs text-gray-400 ml-2">{{ doc.creado_en[:10] }}</span>
        </div>
        <form method="post" action="{{ url_for('panel_cliente_clientes_bp.eliminar_documento', empresa_id=empresa.id, doc_id=doc.id) }}" onsubmit="return confirm('¿Eliminar este documento?');">
          <button type="submit" class="text-red-600 hover:text-red-800 text-xs font-medium">Eliminar</button>
        </form>
      </li>
      {% endfor %}
    </ul>
    {% else %}
      <p class="text-gray-500">No hay documentos importantes registrados para esta empresa.</p>
    {% endif %}
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
  function exportarMinutaPDF(btn) {
    const id = btn.getAttribute('data-id');
    const fecha = btn.getAttribute('data-fecha') || '-';
    const participantes = btn.getAttribute('data-participantes') || '-';
    const doc = new window.jspdf.jsPDF('p', 'pt');

    // Datos de empresa y cliente desde Jinja
    const nombreEmpresa = '{{ empresa.nombre_empresa|default("Empresa") }}';
    const nombreCliente = '{% if empresa.cliente %}{{ empresa.cliente.nombre_cliente|default("Cliente") }}{% else %}Cliente{% endif %}';
    const nombreNora = '{{ nombre_nora|default("Nora")|replace(" ", "_") }}';
    const logoUrl = '/static/images/nora_logo.png'; // Cambia la ruta si tu logo está en otro lugar

    // Encabezado con logo y título
    const pageWidth = doc.internal.pageSize.getWidth();
    let y = 40;
    // Logo Nora (si existe)
    const img = new Image();
    img.src = logoUrl;
    img.onload = function() {
      // Mantener proporción original del logo (ancho máx 50, alto máx 50)
      let imgW = img.width;
      let imgH = img.height;
      if (imgW > 50 || imgH > 50) {
        const scale = Math.min(50 / imgW, 50 / imgH);
        imgW = imgW * scale;
        imgH = imgH * scale;
      }
      doc.addImage(img, 'PNG', 40, y, imgW, imgH);
      // Título con color azul
      doc.setFontSize(22);
      doc.setTextColor(37, 99, 235); // azul Tailwind #2563eb
      doc.setFont('helvetica', 'bold');
      doc.text('Minuta de reunión', pageWidth / 2, y + 30, { align: 'center' });
      y += 60;
      // Empresa y cliente
      doc.setFontSize(13);
      doc.setTextColor(55, 65, 81); // gris oscuro
      doc.setFont('helvetica', 'bold');
      doc.text('Empresa:', 110, y);
      doc.setFont('helvetica', 'normal');
      doc.text(nombreEmpresa, 180, y);
      doc.setFont('helvetica', 'bold');
      doc.text('Cliente ligado:', 110, y + 20);
      doc.setFont('helvetica', 'normal');
      doc.text(nombreCliente, 210, y + 20);
      y += 40;
      // Línea separadora azul
      doc.setDrawColor(37, 99, 235);
      doc.setLineWidth(2);
      doc.line(40, y, pageWidth - 40, y);
      y += 20;
      // Fecha y participantes
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.text('Fecha:', 40, y);
      doc.setFont('helvetica', 'normal');
      doc.text(fecha, 100, y);
      doc.setFont('helvetica', 'bold');
      doc.text('Participantes:', 40, y + 20);
      doc.setFont('helvetica', 'normal');
      doc.text(participantes, 130, y + 20);
      y += 40;
      // Otra línea separadora azul claro
      doc.setDrawColor(96, 165, 250); // azul claro Tailwind #60a5fa
      doc.setLineWidth(1);
      doc.line(40, y, pageWidth - 40, y);
      y += 20;
      // Minuta en recuadro
      const minuta = document.getElementById('minuta-texto-' + id).innerText;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(13);
      doc.setTextColor(37, 99, 235);
      doc.text('Minuta / Notas:', 40, y);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(55, 65, 81);
      doc.setFillColor(219, 234, 254); // fondo azul muy claro #dbeafe
      doc.setDrawColor(96, 165, 250); // borde azul claro
      const boxTop = y + 10;
      const boxLeft = 40;
      const boxWidth = pageWidth - 80;
      // Procesar negritas (**texto**)
      function parseBoldLines(text) {
        const lines = text.split('\n');
        return lines.map(line => {
          const parts = [];
          let lastIdx = 0;
          let match;
          const boldRegex = /\*\*(.+?)\*\*/g;
          while ((match = boldRegex.exec(line)) !== null) {
            if (match.index > lastIdx) {
              parts.push({ text: line.substring(lastIdx, match.index), bold: false });
            }
            parts.push({ text: match[1], bold: true });
            lastIdx = match.index + match[0].length;
          }
          if (lastIdx < line.length) {
            parts.push({ text: line.substring(lastIdx), bold: false });
          }
          return parts;
        });
      }
      const parsedLines = parseBoldLines(minuta);
      // Calcular altura
      let totalLines = 0;
      parsedLines.forEach(partsArr => {
        let lineText = partsArr.map(p => p.text).join('');
        const split = doc.splitTextToSize(lineText, boxWidth - 20);
        totalLines += split.length;
      });
      let boxHeight = totalLines * 16 + 20;
      const maxBoxHeight = doc.internal.pageSize.getHeight() - boxTop - 80;
      if (boxHeight > maxBoxHeight) {
        boxHeight = maxBoxHeight;
      }
      doc.rect(boxLeft, boxTop, boxWidth, boxHeight, 'FD');
      doc.setFontSize(12);
      let textY = boxTop + 20;
      for (let i = 0; i < parsedLines.length; i++) {
        let x = boxLeft + 10;
        for (const part of parsedLines[i]) {
          if (part.text) {
            doc.setFont('helvetica', part.bold ? 'bold' : 'normal');
            const split = doc.splitTextToSize(part.text, boxWidth - 20 - (x - boxLeft - 10));
            for (let j = 0; j < split.length; j++) {
              if (textY > boxTop + boxHeight - 10) {
                doc.addPage();
                textY = 60;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(13);
                doc.setTextColor(37, 99, 235);
                doc.text('Minuta / Notas (continuación):', 40, textY);
                textY += 20;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(12);
                doc.setTextColor(55, 65, 81);
                x = boxLeft + 10;
              }
              doc.text(split[j], x, textY, { maxWidth: boxWidth - 20 });
              if (j < split.length - 1) {
                textY += 16;
                x = boxLeft + 10;
              } else {
                x += doc.getTextWidth(split[j]);
              }
            }
          }
        }
        textY += 16;
      }
      doc.setTextColor(0, 0, 0);
      // Pie de página
      doc.setFontSize(9);
      doc.setTextColor(37, 99, 235);
      doc.text('Exportado desde AuraAI', pageWidth - 140, doc.internal.pageSize.getHeight() - 30);
      // Nombre de archivo
      let fechaArchivo = fecha.split('T')[0] || fecha.split(' ')[0] || fecha;
      fechaArchivo = fechaArchivo.replace(/[:\\/]/g, '-');
      const nombreArchivo = `Reunion_${nombreNora}_${nombreCliente.replace(/ /g,'_')}_${fechaArchivo}.pdf`;
      doc.save(nombreArchivo);
    };
    img.onerror = function() {
      // Si no hay logo, igual genera el PDF sin logo
      doc.setFontSize(22);
      doc.setTextColor(37, 99, 235);
      doc.setFont('helvetica', 'bold');
      doc.text('Minuta de reunión', pageWidth / 2, 60, { align: 'center' });
      // Empresa y cliente
      let y = 80;
      doc.setFontSize(13);
      doc.setTextColor(55, 65, 81);
      doc.setFont('helvetica', 'bold');
      doc.text('Empresa:', 40, y);
      doc.setFont('helvetica', 'normal');
      doc.text(nombreEmpresa, 110, y);
      doc.setFont('helvetica', 'bold');
      doc.text('Cliente ligado:', 40, y + 20);
      doc.setFont('helvetica', 'normal');
      doc.text(nombreCliente, 140, y + 20);
      y += 40;
      doc.setDrawColor(37, 99, 235);
      doc.setLineWidth(2);
      doc.line(40, y, pageWidth - 40, y);
      y += 20;
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.text('Fecha:', 40, y);
      doc.setFont('helvetica', 'normal');
      doc.text(fecha, 100, y);
      doc.setFont('helvetica', 'bold');
      doc.text('Participantes:', 40, y + 20);
      doc.setFont('helvetica', 'normal');
      doc.text(participantes, 130, y + 20);
      y += 40;
      doc.setDrawColor(96, 165, 250);
      doc.setLineWidth(1);
      doc.line(40, y, pageWidth - 40, y);
      y += 20;
      const minuta = document.getElementById('minuta-texto-' + id).innerText;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(13);
      doc.setTextColor(37, 99, 235);
      doc.text('Minuta / Notas:', 40, y);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(55, 65, 81);
      doc.setFillColor(219, 234, 254);
      doc.setDrawColor(96, 165, 250);
      const boxTop = y + 10;
      const boxLeft = 40;
      const boxWidth = pageWidth - 80;
      // Procesar negritas (**texto**)
      function parseBoldLines(text) {
        const lines = text.split('\n');
        return lines.map(line => {
          const parts = [];
          let lastIdx = 0;
          let match;
          const boldRegex = /\*\*(.+?)\*\*/g;
          while ((match = boldRegex.exec(line)) !== null) {
            if (match.index > lastIdx) {
              parts.push({ text: line.substring(lastIdx, match.index), bold: false });
            }
            parts.push({ text: match[1], bold: true });
            lastIdx = match.index + match[0].length;
          }
          if (lastIdx < line.length) {
            parts.push({ text: line.substring(lastIdx), bold: false });
          }
          return parts;
        });
      }
      const parsedLines = parseBoldLines(minuta);
      // Calcular altura
      let totalLines = 0;
      parsedLines.forEach(partsArr => {
        let lineText = partsArr.map(p => p.text).join('');
        const split = doc.splitTextToSize(lineText, boxWidth - 20);
        totalLines += split.length;
      });
      let boxHeight = totalLines * 16 + 20;
      const maxBoxHeight = doc.internal.pageSize.getHeight() - boxTop - 80;
      if (boxHeight > maxBoxHeight) {
        boxHeight = maxBoxHeight;
      }
      doc.rect(boxLeft, boxTop, boxWidth, boxHeight, 'FD');
      doc.setFontSize(12);
      let textY = boxTop + 20;
      for (let i = 0; i < parsedLines.length; i++) {
        let x = boxLeft + 10;
        for (const part of parsedLines[i]) {
          if (part.text) {
            doc.setFont('helvetica', part.bold ? 'bold' : 'normal');
            const split = doc.splitTextToSize(part.text, boxWidth - 20 - (x - boxLeft - 10));
            for (let j = 0; j < split.length; j++) {
              if (textY > boxTop + boxHeight - 10) {
                doc.addPage();
                textY = 60;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(13);
                doc.setTextColor(37, 99, 235);
                doc.text('Minuta / Notas (continuación):', 40, textY);
                textY += 20;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(12);
                doc.setTextColor(55, 65, 81);
                x = boxLeft + 10;
              }
              doc.text(split[j], x, textY, { maxWidth: boxWidth - 20 });
              if (j < split.length - 1) {
                textY += 16;
                x = boxLeft + 10;
              } else {
                x += doc.getTextWidth(split[j]);
              }
            }
          }
        }
        textY += 16;
      }
      doc.setTextColor(0, 0, 0);
      // Pie de página
      doc.setFontSize(9);
      doc.setTextColor(37, 99, 235);
      doc.text('Exportado desde AuraAI', pageWidth - 140, doc.internal.pageSize.getHeight() - 30);
      let fechaArchivo = fecha.split('T')[0] || fecha.split(' ')[0] || fecha;
      fechaArchivo = fechaArchivo.replace(/[:\\/]/g, '-');
      const nombreArchivo = `Reunion_${nombreNora}_${nombreCliente.replace(/ /g,'_')}_${fechaArchivo}.pdf`;
      doc.save(nombreArchivo);
    };
  }

  function exportarFichaEmpresaPDF() {
    const ficha = document.querySelector('.container.mx-auto.max-w-5xl');
    if (!ficha) return;
    // Obtener mes y año actuales
    const now = new Date();
    const mes = (now.getMonth() + 1).toString().padStart(2, '0');
    const anio = now.getFullYear();
    // Construir nombre de archivo personalizado
    const nombreArchivo = `Ficha_${'{{ nombre_nora }}'}_${'{{ empresa.id }}'}_${mes}_${anio}.pdf`;
    const opt = {
      margin:       0.2,
      filename:     nombreArchivo,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(ficha).save();
  }

  function exportarSeccionPDF(idSeccion, nombreSeccion) {
    const seccion = document.getElementById(idSeccion);
    if (!seccion) return;
    const now = new Date();
    const mes = (now.getMonth() + 1).toString().padStart(2, '0');
    const anio = now.getFullYear();
    const nombreArchivo = `${nombreSeccion}_${'{{ nombre_nora }}'}_${'{{ empresa.id }}'}_${mes}_${anio}.pdf`;
    const opt = {
      margin:       0.2,
      filename:     nombreArchivo,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(seccion).save();
  }

  function exportarTareasPDF() {
    const seccion = document.getElementById('seccion-tareas');
    if (!seccion) return;
    const now = new Date();
    const mes = (now.getMonth() + 1).toString().padStart(2, '0');
    const anio = now.getFullYear();
    const nombreArchivo = `Tareas_${'{{ nombre_nora }}'}_${'{{ empresa.id }}'}_${mes}_${anio}.pdf`;
    const opt = {
      margin: 0.2,
      filename: nombreArchivo,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(seccion).save();
  }
  function exportarPagosPDF() {
    const seccion = document.getElementById('seccion-pagos');
    if (!seccion) return;
    const now = new Date();
    const mes = (now.getMonth() + 1).toString().padStart(2, '0');
    const anio = now.getFullYear();
    const nombreArchivo = `Pagos_${'{{ nombre_nora }}'}_${'{{ empresa.id }}'}_${mes}_${anio}.pdf`;
    const opt = {
      margin: 0.2,
      filename: nombreArchivo,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(seccion).save();
  }
  function exportarCuentasAdsPDF() {
    const seccion = document.getElementById('seccion-cuentas-ads');
    if (!seccion) return;
    const now = new Date();
    const mes = (now.getMonth() + 1).toString().padStart(2, '0');
    const anio = now.getFullYear();
    const nombreArchivo = `CuentasAds_${'{{ nombre_nora }}'}_${'{{ empresa.id }}'}_${mes}_${anio}.pdf`;
    const opt = {
      margin: 0.2,
      filename: nombreArchivo,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(seccion).save();
  }
  function exportarReunionesPDF() {
    const seccion = document.getElementById('seccion-reuniones');
    if (!seccion) return;
    const now = new Date();
    const mes = (now.getMonth() + 1).toString().padStart(2, '0');
    const anio = now.getFullYear();
    const nombreArchivo = `Reuniones_${'{{ nombre_nora }}'}_${'{{ empresa.id }}'}_${mes}_${anio}.pdf`;
    const opt = {
      margin: 0.2,
      filename: nombreArchivo,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(seccion).save();
  }
  function exportarDocumentosPDF() {
    const seccion = document.getElementById('seccion-documentos');
    if (!seccion) return;
    const now = new Date();
    const mes = (now.getMonth() + 1).toString().padStart(2, '0');
    const anio = now.getFullYear();
    const nombreArchivo = `Documentos_${'{{ nombre_nora }}'}_${'{{ empresa.id }}'}_${mes}_${anio}.pdf`;
    const opt = {
      margin: 0.2,
      filename: nombreArchivo,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(seccion).save();
  }
  </script>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.show-password-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const span = btn.parentElement.querySelector('.password-mask');
        if (btn.dataset.revealed === '1') {
          span.textContent = '••••••••';
          btn.textContent = 'ver';
          btn.dataset.revealed = '0';
        } else {
          span.textContent = btn.dataset.password || '-';
          btn.textContent = 'ocultar';
          btn.dataset.revealed = '1';
        }
      });
    });
  });
  </script>
</div>
{% endblock %}
