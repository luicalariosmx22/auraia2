{% extends "base_cliente.html" %}

{% block contenido %}
<div class="container mx-auto max-w-5xl px-2 py-4">  <!-- changed from max-w-3xl to max-w-5xl -->
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">ğŸ¢ Ficha de empresa</h2>
    <div class="flex gap-2">
        <a href="{{ url_for('panel_cliente_clientes_bp.vista_empresas', nombre_nora=nombre_nora) }}" class="text-blue-600 text-xs hover:underline">â† Volver a empresas</a>
        <a href="{{ url_for('panel_cliente_clientes_bp.editar_empresa', empresa_id=empresa.id) }}" class="px-2 py-1 bg-blue-600 text-white rounded text-xs shadow-sm hover:bg-blue-700 transition">âœï¸ Editar empresa</a>
        <button type="button" onclick="exportarFichaEmpresaPDF()" class="px-2 py-1 bg-indigo-600 text-white rounded text-xs shadow-sm hover:bg-indigo-700 transition flex items-center gap-1"><span>ğŸ“„</span> Exportar PDF</button>
    </div>
  </div>

  <!-- Perfil tipo red social y detalles en 3 columnas -->
  <div class="bg-white rounded-lg shadow p-6 border border-gray-200 mb-4 grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
    <!-- Columna 1: Perfil visual -->
    <div class="flex flex-col items-center">
      <div class="relative mb-3">
        <div class="w-36 h-36 rounded-full bg-gray-100 border-4 border-white shadow flex items-center justify-center overflow-hidden">
          {% if empresa.logo_url %}
            <img src="{{ empresa.logo_url }}" alt="Logo empresa" class="object-cover w-full h-full">
          {% else %}
            <span class="text-5xl text-gray-400">ğŸ¢</span>
          {% endif %}
        </div>
      </div>
      <h3 class="text-2xl font-bold text-gray-900 mb-1 text-center font-sans">{{ empresa.nombre_empresa }}</h3>
      <p class="text-gray-500 mb-2 text-center font-sans text-lg">{{ empresa.giro or 'â€”' }}</p>
      <div class="flex flex-wrap gap-2 justify-center mb-2">
        {% if empresa.ciudad %}<span class="inline-flex items-center text-sm text-gray-600 font-sans"><i class="fa fa-map-marker-alt mr-1"></i>{{ empresa.ciudad }}</span>{% endif %}
        {% if empresa.pais %}<span class="inline-flex items-center text-sm text-gray-600 font-sans"><i class="fa fa-globe mr-1"></i>{{ empresa.pais }}</span>{% endif %}
        {% if empresa.sitio_web %}<a href="{{ empresa.sitio_web }}" target="_blank" class="inline-flex items-center text-sm text-blue-700 hover:underline font-sans"><i class="fa fa-link mr-1"></i>{{ empresa.sitio_web }}</a>{% endif %}
      </div>
      <div class="flex flex-wrap gap-1 justify-center mb-2">
        <span class="bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full font-sans">{{ empresa.tipo or 'Empresa' }}</span>
        <span class="bg-green-100 text-green-800 text-sm font-semibold px-3 py-1 rounded-full font-sans">{{ 'Activa' if empresa.activo else 'Inactiva' }}</span>
      </div>
      {% if empresa.cliente_id and empresa.cliente %}
        <div class="flex flex-wrap gap-1 justify-center mb-1">
          <span class="bg-yellow-100 text-yellow-800 text-sm font-semibold px-3 py-1 rounded-full font-sans">
            ğŸ‘¤ {{ empresa.cliente.nombre_cliente }}
          </span>
          <button type="button" onclick="document.getElementById('modal-reunion').classList.remove('hidden')" class="px-3 py-1 bg-purple-600 text-white rounded text-sm font-semibold shadow-sm hover:bg-purple-700 transition font-sans">ğŸ“… ReuniÃ³n</button>
        </div>
      {% endif %}
    </div>
    <!-- Columna 2 y 3: Detalles -->
    <div class="md:col-span-2">
      <table class="w-full text-sm font-sans align-top">
        <tbody>
          {% set detalles = [
            ('RazÃ³n social', empresa.razon_social or '-'),
            ('RFC', empresa.rfc or '-'),
            ('Email', empresa.email_empresa or '-'),
            ('TelÃ©fono', empresa.telefono_empresa or '-'),
            ('Sitio web', empresa.sitio_web or '-'),
            ('UbicaciÃ³n', empresa.ubicacion or '-'),
            ('Ciudad', empresa.ciudad or '-'),
            ('Estado', empresa.estado or '-'),
            ('PaÃ­s', empresa.pais or '-'),
            ('Contacto', empresa.representante_legal or '-'),
            ('Email Contacto', empresa.email_representante or '-'),
            ('TelÃ©fono Contacto', empresa.telefono_representante or '-'),
            ('Fecha alta', empresa.fecha_alta or '-'),
            ('Fecha baja', empresa.fecha_baja or '-'),
            ('Notas', empresa.notas or '-'),
            ('Tipo', empresa.tipo or '-'),
            ('Giro', empresa.giro or '-'),
            ('Activo', 'SÃ­' if empresa.activo else 'No'),
          ] %}
          {% for i in range(0, detalles|length, 2) %}
          <tr class="border-b border-gray-100 last:border-0">
            <td class="font-semibold text-gray-700 py-2 pr-2 w-40 align-top">{{ detalles[i][0] }}</td>
            <td class="text-gray-900 py-2 pr-4 align-top">{{ detalles[i][1] }}</td>
            {% if detalles[i+1] is defined %}
              <td class="font-semibold text-gray-700 py-2 pr-2 w-40 align-top">{{ detalles[i+1][0] }}</td>
              <td class="text-gray-900 py-2 align-top">{{ detalles[i+1][1] }}</td>
            {% else %}
              <td></td><td></td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- BRIEF DEL CLIENTE -->
  <div class="bg-white rounded-lg shadow p-4 border border-blue-300 mb-4">
    <div class="flex items-center justify-between mb-2">
      <h4 class="text-lg font-semibold text-blue-700">ğŸ“ Brief del cliente</h4>
      <a href="#" onclick="document.getElementById('modal-brief').classList.remove('hidden');return false;" class="px-3 py-1 bg-blue-600 text-white rounded text-xs font-semibold shadow-sm hover:bg-blue-700 transition">âœï¸ Editar brief</a>
    </div>
    <div class="text-gray-800 whitespace-pre-line min-h-[48px] text-sm">{{ empresa.brief or 'No hay brief registrado para este cliente.' }}</div>
  </div>

  <!-- Modal para editar brief -->
  <div id="modal-brief" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg relative">
      <button type="button" onclick="document.getElementById('modal-brief').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
      <h3 class="text-lg font-bold mb-4 text-blue-700 flex items-center gap-2">ğŸ“ Editar Brief del Cliente</h3>
      <form method="post" action="{{ url_for('panel_cliente_clientes_bp.editar_brief_empresa', empresa_id=empresa.id) }}">
        <div class="mb-3">
          <label class="block text-xs font-semibold mb-1">Brief / InformaciÃ³n relevante</label>
          <textarea name="brief" rows="8" required class="w-full px-3 py-2 border rounded-lg text-sm">{{ empresa.brief }}</textarea>
        </div>
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" onclick="document.getElementById('modal-brief').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>
  <!-- FIN BRIEF DEL CLIENTE -->
  
  <!-- SUBMÃ“DULO: ContraseÃ±as de redes sociales y plataformas digitales -->
  <div class="bg-white rounded-lg shadow p-4 border border-yellow-300 mb-4">
    <div class="flex items-center justify-between mb-2">
      <h4 class="text-lg font-semibold text-yellow-700">ğŸ” ContraseÃ±as de redes y plataformas</h4>
      <a href="{{ url_for('panel_cliente_clientes_bp.editar_accesos_empresa', empresa_id=empresa.id) }}" class="px-3 py-1 bg-yellow-500 text-white rounded text-xs font-semibold shadow-sm hover:bg-yellow-600 transition">âœï¸ Editar accesos</a>
    </div>
    {% set accesos = accesos if accesos is defined else [] %}
    {% if accesos and accesos|length > 0 %}
      <table class="w-full text-sm border border-gray-200 rounded-lg overflow-hidden mb-2">
        <thead class="bg-yellow-50">
          <tr>
            <th class="px-3 py-2 text-left font-semibold">Plataforma</th>
            <th class="px-3 py-2 text-left font-semibold">Usuario / Email</th>
            <th class="px-3 py-2 text-left font-semibold">ContraseÃ±a</th>
            <th class="px-3 py-2 text-left font-semibold">Notas</th>
          </tr>
        </thead>
        <tbody>
          {% for acceso in accesos %}
          <tr class="border-t border-gray-100 hover:bg-yellow-50 transition">
            <td class="px-3 py-2 font-medium">{{ acceso.plataforma or '-' }}</td>
            <td class="px-3 py-2">{{ acceso.usuario or acceso.email or '-' }}</td>
            <td class="px-3 py-2 font-mono select-all">
              <span class="password-mask">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
              <button type="button" class="ml-2 text-xs text-blue-600 hover:underline show-password-btn" data-password="{{ acceso.password|e }}">ver</button>
            </td>
            <td class="px-3 py-2">{{ acceso.notas or '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="text-xs text-gray-500 mt-2">âš ï¸ Muestra solo a usuarios autorizados. Protege esta informaciÃ³n.</p>
    {% else %}
      <p class="text-gray-500">No hay contraseÃ±as registradas para esta empresa.</p>
    {% endif %}
  </div>

  <!-- TAREAS -->
  <div class="mb-4" id="seccion-tareas">
    <div class="flex items-center justify-between mb-2">
      <h4 class="text-lg font-semibold text-blue-700">ğŸ“‹ Tareas Activas</h4>
    </div>
    {% set tareas_activas = tareas | selectattr('estatus', 'ne', 'completada') | list %}
    {% if tareas_activas %}
    <div class="overflow-x-auto rounded-lg shadow border border-gray-200 mb-4 bg-white">
      <table class="w-full text-sm align-middle">
        <thead class="bg-blue-50">
          <tr>
            <th class="px-3 py-2 text-left font-semibold">Prioridad</th>
            <th class="px-3 py-2 text-left font-semibold">TÃ­tulo</th>
            <th class="px-3 py-2 text-left font-semibold">Estatus</th>
            <th class="px-3 py-2 text-left font-semibold">Asignado a</th>
            <th class="px-3 py-2 text-left font-semibold">Fecha lÃ­mite</th>
          </tr>
        </thead>
        <tbody>
          {% set all_tareas = [] %}
          {% for t in tareas_activas %}
            {% set _ = all_tareas.append(t) %}
            {% if t.subtareas and t.subtareas|length > 0 %}
              {% for s in t.subtareas %}
                {% set _ = all_tareas.append(s) %}
              {% endfor %}
            {% endif %}
          {% endfor %}
          {% for t in all_tareas %}
          <tr class="border-t border-gray-100 hover:bg-blue-50 transition">
            <td class="px-3 py-2">
              {% if t.prioridad == 'alta' %}<span class="text-red-600 font-bold">ğŸ”´ Alta</span>{% elif t.prioridad == 'media' %}<span class="text-yellow-600 font-bold">ğŸŸ  Media</span>{% else %}<span class="text-green-600 font-bold">ğŸŸ¢ Baja</span>{% endif %}
            </td>
            <td class="px-3 py-2">
              <span class="font-medium">{{ t.titulo }}</span>
            </td>
            <td class="px-3 py-2">
              {% if t.estatus == 'pendiente' %}<span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs">â³ Pendiente</span>{% elif t.estatus == 'en progreso' %}<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs">ğŸš§ En progreso</span>{% elif t.estatus == 'retrasada' %}<span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs">â— Retrasada</span>{% elif t.estatus == 'completada' %}<span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs">âœ… Completada</span>{% else %}{{ t.estatus|capitalize }}{% endif %}
            </td>
            <td class="px-3 py-2">{{ usuarios | selectattr('id', 'equalto', t.usuario_empresa_id) | map(attribute='nombre') | first or 'â€”' }}</td>
            <td class="px-3 py-2">
              {% if t.fecha_limite %}
                <span>{{ t.fecha_limite }}</span>
              {% else %}
                <span class="text-gray-400">â€”</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
    <!-- Ãšltimas 5 tareas completadas -->
    {% if tareas_completadas and tareas_completadas|length > 0 %}
    <div class="overflow-x-auto rounded-lg shadow border border-green-100 mb-4 bg-white">
      <h5 class="text-xs font-semibold text-green-700 mb-1 mt-1">Ãšltimas 5 tareas completadas</h5>
      <table class="w-full text-sm align-middle">
        <thead class="bg-green-50">
          <tr>
            <th class="px-3 py-2 text-left font-semibold">Prioridad</th>
            <th class="px-3 py-2 text-left font-semibold">TÃ­tulo</th>
            <th class="px-3 py-2 text-left font-semibold">Estatus</th>
            <th class="px-3 py-2 text-left font-semibold">Asignado a</th>
            <th class="px-3 py-2 text-left font-semibold">Fecha completada</th>
          </tr>
        </thead>
        <tbody>
          {% for t in tareas_completadas[:5] %}
          <tr class="border-t border-gray-100 hover:bg-green-50 transition">
            <td class="px-3 py-2">
              {% if t.prioridad == 'alta' %}<span class="text-red-600 font-bold">ğŸ”´ Alta</span>{% elif t.prioridad == 'media' %}<span class="text-yellow-600 font-bold">ğŸŸ  Media</span>{% else %}<span class="text-green-600 font-bold">ğŸŸ¢ Baja</span>{% endif %}
            </td>
            <td class="px-3 py-2">
              <span class="font-medium">{{ t.titulo }}</span>
              {% if t.recurrente or t.is_recurrente %}<span title="Tarea recurrente" class="ml-1">ğŸ”</span>{% endif %}
            </td>
            <td class="px-3 py-2">
              <span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs">âœ… Completada</span>
            </td>
            <td class="px-3 py-2">{{ usuarios | selectattr('id', 'equalto', t.usuario_empresa_id) | map(attribute='nombre') | first or 'â€”' }}</td>
            <td class="px-3 py-2">
              {% if t.updated_at %}
                <span>{{ t.updated_at[:10] }}</span>
              {% else %}
                <span class="text-gray-400">â€”</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

  <!-- PAGOS / TRANSACCIONES -->
  <div class="mb-4" id="seccion-pagos">
    <div class="flex items-center justify-between mb-2">
      <h4 class="text-lg font-semibold text-green-700">ğŸ’³ Transacciones</h4>
    </div>
    {% if pagos %}
    <div class="overflow-x-auto rounded-lg shadow border border-gray-200 mb-2 bg-white">
      <table class="w-full text-sm align-middle">
        <thead class="bg-green-50">
          <tr>
            <th class="px-3 py-2 text-left font-semibold">Concepto</th>
            <th class="px-3 py-2 text-left font-semibold">Fecha vencimiento</th>
            <th class="px-3 py-2 text-left font-semibold">Monto</th>
            <th class="px-3 py-2 text-left font-semibold">Estatus</th>
          </tr>
        </thead>
        <tbody>
          {% for p in pagos %}
          <tr class="border-t border-gray-100 hover:bg-green-50 transition">
            <td class="px-3 py-2">{{ p.concepto or 'â€”' }}</td>
            <td class="px-3 py-2">{{ p.fecha_vencimiento or 'â€”' }}</td>
            <td class="px-3 py-2 font-mono text-green-700 font-semibold">${{ '%.2f'|format(p.monto|float) if p.monto else 'â€”' }}</td>
            <td class="px-3 py-2">
              {% if p.estatus == 'pagado' %}
                <span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-semibold">Pagado</span>
              {% elif p.estatus == 'pendiente' %}
                <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-semibold">Pendiente</span>
              {% elif p.estatus == 'vencido' %}
                <span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs font-semibold">Vencido</span>
              {% else %}
                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-xs font-semibold">{{ p.estatus or 'â€”' }}</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <p class="text-gray-500">No hay transacciones registradas para esta empresa.</p>
    {% endif %}
  </div>

  <!-- REUNIONES -->
  <div class="mb-4" id="seccion-reuniones">
    <div class="flex items-center justify-between mb-2">
        <h4 class="text-lg font-semibold text-purple-700">ğŸ“… Reuniones con el cliente</h4>
      </div>
    {% if reuniones %}
      <div class="overflow-x-auto rounded-lg shadow border border-gray-200 bg-white">
        <table class="w-full text-sm align-middle">
          <thead class="bg-purple-50">
            <tr>
              <th class="px-3 py-2 text-left font-semibold">Fecha y hora</th>
              <th class="px-3 py-2 text-left font-semibold">Participantes</th>
              <th class="px-3 py-2 text-left font-semibold">Minuta</th>
              <th class="px-3 py-2 text-left font-semibold">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for r in reuniones %}
            <tr class="border-t border-gray-100 hover:bg-purple-50 transition">
              <td class="px-3 py-2">{{ r.fecha_hora|default('-', true) }}</td>
              <td class="px-3 py-2">{{ r.participantes or '-' }}</td>
              <td class="px-3 py-2 truncate max-w-xs">
                <span class="text-gray-700 text-xs">{{ r.minuta[:60] }}{% if r.minuta and r.minuta|length > 60 %}...{% endif %}</span>
              </td>
              <td class="px-3 py-2">
                <button type="button" onclick="document.getElementById('minuta-{{ r.id }}').classList.remove('hidden')" class="text-purple-700 hover:underline text-xs font-semibold">Ver minuta</button>
                <form method="post" action="{{ url_for('panel_cliente_clientes_bp.eliminar_reunion', empresa_id=empresa.id, reunion_id=r.id) }}" style="display:inline" onsubmit="return confirm('Â¿Eliminar esta reuniÃ³n?');">
                  <button type="submit" class="ml-2 text-red-600 hover:text-red-800 text-xs font-semibold">Eliminar</button>
                </form>
              </td>
            </tr>
            <!-- Modal Minuta editable -->
            <div id="minuta-{{ r.id }}" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
              <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-5xl relative">
                <button type="button" onclick="document.getElementById('minuta-{{ r.id }}').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
                <h3 class="text-lg font-bold mb-4 text-purple-700 flex items-center gap-2">ğŸ“ Editar reuniÃ³n</h3>
                <form method="post" action="{{ url_for('panel_cliente_clientes_bp.editar_reunion', empresa_id=empresa.id, reunion_id=r.id) }}" class="space-y-3">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-xs font-semibold mb-1">Fecha y hora</label>
                      <input type="datetime-local" name="fecha_hora" value="{{ r.fecha_hora|replace(' ', 'T') }}" required class="w-full px-3 py-2 border rounded-lg text-sm">
                    </div>
                    <div>
                      <label class="block text-xs font-semibold mb-1">Participantes</label>
                      <input type="text" name="participantes" value="{{ r.participantes }}" class="w-full px-3 py-2 border rounded-lg text-sm">
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs font-semibold mb-1">Minuta / Notas</label>
                    <textarea name="minuta" rows="6" required class="w-full px-3 py-2 border rounded-lg text-sm" id="minuta-texto-{{ r.id }}">{{ r.minuta }}</textarea>
                  </div>
                  <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="document.getElementById('minuta-{{ r.id }}').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700">Guardar cambios</button>
                  </div>
                </form>
              </div>
            </div>
            <!-- Fin modal editable -->
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-gray-500">No hay reuniones registradas para esta empresa.</p>
    {% endif %}
  </div>

  <!-- Modal para registrar reuniÃ³n -->
  <div id="modal-reunion" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg relative">
      <button type="button" onclick="document.getElementById('modal-reunion').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
      <h3 class="text-lg font-bold mb-4 text-purple-700 flex items-center gap-2">
        {% if empresa.cliente %}
          ğŸ“… Registrar reuniÃ³n con {{ empresa.cliente.nombre_cliente }}
        {% else %}
          ğŸ“… Registrar reuniÃ³n (sin cliente ligado)
        {% endif %}
      </h3>
      <form method="post" action="{{ url_for('panel_cliente_clientes_bp.registrar_reunion', empresa_id=empresa.id) }}">
        <div class="mb-3">
          <label class="block text-xs font-semibold mb-1">Fecha y hora</label>
          <input type="datetime-local" name="fecha_hora" required class="w-full px-3 py-2 border rounded-lg text-sm">
        </div>
        <div class="mb-3">
          <label class="block text-xs font-semibold mb-1">Participantes</label>
          <input type="text" name="participantes" placeholder="Ej: Juan, Ana, Cliente..." class="w-full px-3 py-2 border rounded-lg text-sm">
        </div>
        <div class="mb-3">
          <label class="block text-xs font-semibold mb-1">Minuta / Notas</label>
          <textarea name="minuta" rows="4" required class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Describe los temas tratados, acuerdos, tareas, etc."></textarea>
        </div>
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" onclick="document.getElementById('modal-reunion').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
          <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700">Guardar reuniÃ³n</button>
        </div>
      </form>
    </div>
  </div>

  <!-- DOCUMENTOS IMPORTANTES -->
  <div class="mb-4" id="seccion-documentos">
    <div class="flex items-center justify-between mb-2">
      <h4 class="text-lg font-semibold text-indigo-700 mb-2">ğŸ“„ Documentos importantes</h4>
      <div class="flex gap-2">
        <button type="button" onclick="document.getElementById('form-doc-nuevo').classList.toggle('hidden')" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm">Agregar documento</button>
      </div>
    </div>
    <form id="form-doc-nuevo" method="post" action="{{ url_for('panel_cliente_clientes_bp.agregar_documento', empresa_id=empresa.id) }}" class="flex flex-wrap gap-2 mb-3 bg-indigo-50 p-3 rounded-lg hidden">
      <input type="text" name="nombre" placeholder="Nombre del documento" class="border rounded px-2 py-1 text-sm flex-1 min-w-[180px]" required>
      <input type="url" name="url" placeholder="URL del documento" class="border rounded px-2 py-1 text-sm flex-1 min-w-[180px]" required>
      <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm">Guardar</button>
    </form>
    {% if documentos %}
    <ul class="divide-y divide-gray-100 bg-white rounded-lg shadow">
      {% for doc in documentos %}
      <li class="flex items-center justify-between px-4 py-2">
        <div>
          <a href="{{ doc.url }}" target="_blank" class="text-indigo-700 hover:underline font-medium">{{ doc.nombre }}</a>
          <span class="text-xs text-gray-400 ml-2">{{ doc.creado_en[:10] }}</span>
        </div>
        <form method="post" action="{{ url_for('panel_cliente_clientes_bp.eliminar_documento', empresa_id=empresa.id, doc_id=doc.id) }}" onsubmit="return confirm('Â¿Eliminar este documento?');">
          <button type="submit" class="text-red-600 hover:text-red-800 text-xs font-medium">Eliminar</button>
        </form>
      </li>
      {% endfor %}
    </ul>
    {% else %}
      <p class="text-gray-500">No hay documentos importantes registrados para esta empresa.</p>
    {% endif %}
  </div>

  <!-- CUENTAS PUBLICITARIAS (Meta y Google Ads) -->
  <div class="mb-4" id="seccion-cuentas-publicitarias">
    <h4 class="text-lg font-semibold text-blue-800 mb-2 flex items-center gap-2">ğŸ’¼ Cuentas Publicitarias</h4>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Meta Ads -->
      <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
        <h5 class="text-base font-bold text-blue-700 mb-2 flex items-center gap-2">Meta Ads</h5>
        {% set cuentas_meta = cuentas_ads | selectattr('tipo_plataforma', 'equalto', 'meta_ads') | selectattr('empresa_id', 'equalto', empresa.id) | list %}
        {% if cuentas_meta %}
          <ul class="divide-y divide-blue-100">
            {% for c in cuentas_meta %}
            <li class="py-2 flex flex-col">
              <span class="font-semibold text-blue-900">{{ c.nombre_cliente or 'Sin nombre' }}</span>
              <span class="text-xs text-gray-500">ID: {{ c.id_cuenta_publicitaria }}</span>
              <span class="text-xs {% if c.account_status == 1 %}text-green-700{% else %}text-gray-400{% endif %}">{% if c.account_status == 1 %}ğŸŸ¢ Activa{% else %}â›” Inactiva{% endif %}</span>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <span class="text-gray-400 text-sm">No hay cuentas Meta Ads vinculadas.</span>
        {% endif %}
      </div>
      <!-- Google Ads -->
      <div class="bg-green-50 rounded-lg p-4 border border-green-200">
        <div class="flex items-center justify-between mb-2">
          <h5 class="text-base font-bold text-green-700 mb-2 flex items-center gap-2">Google Ads</h5>
          <button type="button" onclick="document.getElementById('modal-google-ads').classList.remove('hidden')" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-semibold shadow-sm hover:bg-green-700 transition">+ Agregar</button>
        </div>
        {% set cuentas_google = cuentas_ads | selectattr('tipo_plataforma', 'equalto', 'google_ads') | selectattr('empresa_id', 'equalto', empresa.id) | list %}
        {% if cuentas_google %}
          <ul class="divide-y divide-green-100">
            {% for c in cuentas_google %}
            <li class="py-2 flex flex-col">
              <span class="font-semibold text-green-900">{{ c.nombre_cliente or 'Sin nombre' }}</span>
              <span class="text-xs text-gray-500">ID: {{ c.id_cuenta_publicitaria }}</span>
              <span class="text-xs text-gray-500">Correo: {{ c.correo or '-' }}</span>
              <span class="text-xs {% if c.account_status == 1 %}text-green-700{% else %}text-gray-400{% endif %}">{% if c.account_status == 1 %}ğŸŸ¢ Activa{% else %}â›” Inactiva{% endif %}</span>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <span class="text-gray-400 text-sm">No hay cuentas Google Ads vinculadas.</span>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Modal para agregar cuenta Google Ads -->
  <div id="modal-google-ads" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg relative">
      <button type="button" onclick="document.getElementById('modal-google-ads').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
      <h3 class="text-lg font-bold mb-4 text-green-700 flex items-center gap-2">Agregar cuenta Google Ads</h3>
      <form method="post" action="{{ url_for('panel_cliente_clientes_bp.agregar_cuenta_google_ads_empresa', empresa_id=empresa.id) }}">
        <div class="mb-3">
          <label class="block text-xs font-semibold mb-1">Correo asociado</label>
          <input type="email" name="correo" required class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="correo@ejemplo.com">
        </div>
        <div class="mb-3">
          <label class="block text-xs font-semibold mb-1">ID de cuenta publicitaria</label>
          <input type="text" name="id_cuenta_publicitaria" required class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Ej: 123-456-7890">
        </div>
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" onclick="document.getElementById('modal-google-ads').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">Agregar cuenta</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Fin modal Google Ads -->
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
  function exportarFichaEmpresaPDF() {
    const ficha = document.querySelector('.container.mx-auto.max-w-5xl');
    if (!ficha) return;
    // Obtener mes y aÃ±o actuales
    const now = new Date();
    const mes = (now.getMonth() + 1).toString().padStart(2, '0');
    const anio = now.getFullYear();
    // Construir nombre de archivo personalizado
    const nombreArchivo = `Ficha_${'{{ nombre_nora }}'}_${'{{ empresa.id }}'}_${mes}_${anio}.pdf`;
    const opt = {
      margin:       0.2,
      filename:     nombreArchivo,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(ficha).save();
  }
  </script>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.show-password-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const span = btn.parentElement.querySelector('.password-mask');
        if (btn.dataset.revealed === '1') {
          span.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
          btn.textContent = 'ver';
          btn.dataset.revealed = '0';
        } else {
          span.textContent = btn.dataset.password || '-';
          btn.textContent = 'ocultar';
          btn.dataset.revealed = '1';
        }
      });
    });
  });
  </script>
</div>
{% endblock %}
