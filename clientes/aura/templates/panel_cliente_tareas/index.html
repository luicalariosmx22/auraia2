{% extends "base_cliente.html" %}
{% block title %}ğŸ“‹ Tareas{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/panel_cliente_tareas.css') }}">
{% endblock %}

{% block contenido %}
<div class="panel-tareas">
  <h1 style="display: flex; align-items: center; gap: 0.5em;">
    ğŸ“‹ Tareas
    <button style="margin-left:auto; font-size:15px;" class="btn btn-refrescar">+ Nueva tarea</button>
  </h1>

  <div class="barra-superior">
    {% if usuarios and permisos and permisos.ver_todas %}
      <a href="#" class="btn btn-secondary float-end">ğŸ‘¥ Ver equipo</a>
    {% endif %}
    <a href="#" class="btn btn-primary float-end">
      + Nueva tarea
    </a>
  </div>

  <form method="get" style="display: flex; gap: 1em; margin-bottom: 1.5em; align-items: flex-end;">
    <div>
      <label for="filtro_estado">Estado:</label>
      <select id="filtro_estado" name="estado">
        <option value="">Todas</option>
        <option value="pendiente">Pendientes</option>
        <option value="completada">Completadas</option>
        <option value="vencida">Vencidas</option>
      </select>
    </div>
    {% if usuarios and permisos and permisos.ver_todas %}
    <div>
      <label for="filtro_usuario">Usuario:</label>
      <select id="filtro_usuario" name="usuario">
        <option value="">Todos</option>
        {% for usuario in usuarios %}
          <option value="{{ usuario.id }}">{{ usuario.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
    <div>
      <label for="filtro_fecha">Fecha:</label>
      <select id="filtro_fecha" name="fecha">
        <option value="">Cualquier fecha</option>
        <option value="hoy">Hoy</option>
        <option value="semana">Esta semana</option>
        <option value="intervalo">Intervalo</option>
      </select>
    </div>
    <div>
      <input type="date" name="desde" placeholder="Desde">
      <input type="date" name="hasta" placeholder="Hasta">
    </div>
    <button type="submit" class="btn">Filtrar</button>
  </form>

  {% if tareas %}
    <ul style="list-style: none; padding: 0;">
      {% for tarea in tareas %}
        <li style="display: flex; align-items: center; gap: 1em; border-bottom: 1px solid #eee; padding: 0.7em 0;">
          <span style="font-weight: bold; color: #0369a1;">{{ tarea.codigo_tarea }}</span>
          <span style="flex:1;">{{ tarea.titulo }}</span>
          <span style="color: #888; font-size: 13px;">{{ tarea.fecha_limite or tarea.fecha_plazo }}</span>
          {% if tarea.prioridad == 'alta' %}
            <span title="Alta prioridad" style="color: #e11d48;">â—</span>
          {% elif tarea.prioridad == 'media' %}
            <span title="Prioridad media" style="color: #f59e42;">â³</span>
          {% else %}
            <span title="Prioridad baja" style="color: #22c55e;">â—</span>
          {% endif %}
          {% if tarea.estatus == 'completada' %}
            <span title="Completada" style="color: #22c55e; font-size: 18px;">âœ…</span>
          {% else %}
            <button class="btn btn-refrescar" style="font-size:13px;">Marcar completada</button>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="alert alert-info" style="text-align:center; color:#888; margin-top:3em;">
      No hay tareas asignadas aÃºn ğŸ‰
    </div>
  {% endif %}
</div>

<!-- ğŸ‘‰ Modal para crear o editar una tarea -->
<div class="modal" id="modal-tarea" style="display: none;">
  <div class="modal-contenido">
    <h2>{{ 'Editar Tarea' if tarea else 'Nueva Tarea' }}</h2>
    <form method="POST" action="{{ url_for('panel_cliente_tareas.index_tareas', nombre_nora=nombre_nora) }}">
      <input type="hidden" name="tarea_id" value="{{ tarea.id if tarea }}">
      <input type="hidden" name="empresa_id" value="{{ empresa_id }}">
      <input type="hidden" name="cliente_id" value="{{ cliente_id }}">

      <!-- TÃ­tulo -->
      <label for="titulo">TÃ­tulo</label>
      <input type="text" name="titulo" id="titulo" value="{{ tarea.titulo if tarea }}" required>

      <!-- DescripciÃ³n -->
      <label for="descripcion">DescripciÃ³n</label>
      <textarea name="descripcion" id="descripcion">{{ tarea.descripcion if tarea }}</textarea>

      <!-- Fecha lÃ­mite -->
      <label for="fecha_limite">Fecha lÃ­mite</label>
      <input type="date" name="fecha_limite" id="fecha_limite" value="{{ tarea.fecha_limite if tarea }}">

      <!-- Prioridad -->
      <label for="prioridad">Prioridad</label>
      <select name="prioridad" id="prioridad">
        <option value="baja" {% if tarea and tarea.prioridad == 'baja' %}selected{% endif %}>Baja</option>
        <option value="media" {% if tarea and tarea.prioridad == 'media' %}selected{% endif %}>Media</option>
        <option value="alta" {% if tarea and tarea.prioridad == 'alta' %}selected{% endif %}>Alta</option>
      </select>

      <!-- Usuario asignado -->
      <label for="usuario_empresa_id">Asignado a</label>
      <select name="usuario_empresa_id" id="usuario_empresa_id" required>
        <option value="">Selecciona un usuario</option>
        {% for usuario in usuarios %}
          <option value="{{ usuario.id }}" {% if tarea and tarea.usuario_empresa_id == usuario.id %}selected{% endif %}>
            {{ usuario.nombre }}
          </option>
        {% endfor %}
      </select>

      <!-- Botones -->
      <div class="botones-modal">
        <button type="submit">Guardar</button>
        <button type="button" onclick="cerrarModal()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- ğŸ‘‰ Modal de confirmaciÃ³n para marcar tarea como completada -->
<div class="modal" id="modal-confirmar-completada" style="display: none;">
  <div class="modal-contenido">
    <h2>Â¿Marcar esta tarea como completada?</h2>

    <p><strong>CÃ³digo:</strong> {{ tarea.codigo_tarea }}</p>
    <p><strong>TÃ­tulo:</strong> {{ tarea.titulo }}</p>

    <form method="POST" action="{{ url_for('panel_cliente_tareas.index_tareas', nombre_nora=nombre_nora) }}">
      <input type="hidden" name="tarea_id" value="{{ tarea.id }}">
      <input type="hidden" name="accion" value="completar">

      <div class="botones-modal">
        <button type="submit">SÃ­, completar tarea</button>
        <button type="button" onclick="cerrarModal()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- ğŸ‘‰ SecciÃ³n de estadÃ­sticas y rankings del mÃ³dulo TAREAS -->
<section id="estadisticas" class="seccion-dashboard">
  <h2>EstadÃ­sticas de Tareas</h2>

  <!-- Bloques de mÃ©tricas -->
  <div class="contenedor-estadisticas">
    <div class="stat-card">
      <div class="stat-icon">ğŸ“…</div>
      <div class="stat-info">
        <h3>{{ datos.tareas_semana }}</h3>
        <p>Tareas creadas esta semana</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">âœ…</div>
      <div class="stat-info">
        <h3>{{ datos.tareas_completadas }}</h3>
        <p>Tareas completadas</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">ğŸ•’</div>
      <div class="stat-info">
        <h3>{{ datos.tareas_activas }}</h3>
        <p>Tareas activas</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">âš ï¸</div>
      <div class="stat-info">
        <h3>{{ datos.tareas_vencidas }}</h3>
        <p>Tareas vencidas</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">ğŸ“ˆ</div>
      <div class="stat-info">
        <h3>{{ datos.porcentaje_cumplimiento }}%</h3>
        <p>Cumplimiento general</p>
      </div>
    </div>
  </div>

  <!-- Tabla de rankings -->
  <div class="ranking-tareas">
    <h3>ğŸ† Rankings</h3>
    <table>
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Completadas</th>
          <th>Vencidas</th>
          <th>Activas</th>
        </tr>
      </thead>
      <tbody>
        {% for usuario in datos.ranking_usuarios %}
        <tr>
          <td>{{ usuario.nombre }}</td>
          <td>{{ usuario.completadas }}</td>
          <td>{{ usuario.vencidas }}</td>
          <td>{{ usuario.activas }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- ğŸ‘‰ SecciÃ³n de estadÃ­sticas rÃ¡pidas -->
<section id="estadisticas-rapidas" class="seccion-estadisticas">
  <h2>âš™ï¸ EstadÃ­sticas rÃ¡pidas</h2>
  <div class="estadisticas-grid">
    <div class="stat-box">
      <p class="stat-label">Tareas activas</p>
      <p class="stat-valor">{{ resumen.tareas_activas or 0 }}</p>
    </div>
    <div class="stat-box">
      <p class="stat-label">Completadas</p>
      <p class="stat-valor">{{ resumen.tareas_completadas or 0 }}</p>
    </div>
    <div class="stat-box">
      <p class="stat-label">Vencidas</p>
      <p class="stat-valor">{{ resumen.tareas_vencidas or 0 }}</p>
    </div>
    <div class="stat-box">
      <p class="stat-label">Cumplimiento</p>
      <p class="stat-valor">{{ resumen.porcentaje_cumplimiento or 0 }}%</p>
    </div>
  </div>
</section>

<!-- ğŸ‘‰ SecciÃ³n de configuraciÃ³n de automatizaciones inteligentes -->
<section id="automatizaciones" class="seccion-configuracion">
  <h2>âš™ï¸ Automatizaciones</h2>
  <form method="POST" action="{{ url_for('panel_cliente_tareas.index_tareas', nombre_nora=nombre_nora) }}">
    <input type="hidden" name="accion" value="guardar_automatizaciones">

    <!-- ğŸ” Tareas recurrentes -->
    <div class="automate-item">
      <div class="automate-icon">ğŸ”</div>
      <div class="automate-info">
        <h3>Activar tareas recurrentes</h3>
        <p>Genera tareas automÃ¡ticamente en intervalos definidos (diarias, semanales, etc.).</p>
      </div>
      <div class="automate-switch">
        <input type="checkbox" name="tareas_recurrentes" id="tareas_recurrentes"
               {% if config.tareas_recurrentes %}checked{% endif %}>
      </div>
    </div>

    <!-- ğŸ”” Recordatorios por WhatsApp -->
    <div class="automate-item">
      <div class="automate-icon">ğŸ””</div>
      <div class="automate-info">
        <h3>Activar recordatorios por WhatsApp</h3>
        <p>EnvÃ­a notificaciones automÃ¡ticas a los usuarios sobre sus tareas pendientes.</p>
      </div>
      <div class="automate-switch">
        <input type="checkbox" name="alertas_whatsapp" id="alertas_whatsapp"
               {% if config.alertas_whatsapp %}checked{% endif %}>
      </div>
    </div>

    <!-- ğŸ“¬ Reporte PDF semanal -->
    <div class="automate-item">
      <div class="automate-icon">ğŸ“¬</div>
      <div class="automate-info">
        <h3>Activar reporte PDF semanal</h3>
        <p>EnvÃ­a cada semana un resumen PDF de tareas a los supervisores.</p>
      </div>
      <div class="automate-switch">
        <input type="checkbox" name="reporte_semanal" id="reporte_semanal"
               {% if config.reporte_semanal %}checked{% endif %}>
      </div>
    </div>

    <!-- ğŸ§© Tareas sugeridas al activar otro mÃ³dulo -->
    <div class="automate-item">
      <div class="automate-icon">ğŸ§©</div>
      <div class="automate-info">
        <h3>Activar tareas sugeridas por mÃ³dulos</h3>
        <p>Crea tareas automÃ¡ticamente al activar funciones como campaÃ±as, clientes o cursos.</p>
      </div>
      <div class="automate-switch">
        <input type="checkbox" name="tareas_sugeridas_modulos" id="tareas_sugeridas_modulos"
               {% if config.tareas_sugeridas_modulos %}checked{% endif %}>
      </div>
    </div>

    <!-- BotÃ³n de guardar -->
    <div class="guardar-config">
      <button type="submit">Guardar configuraciÃ³n</button>
    </div>
  </form>
</section>

<!-- ğŸ‘‰ SecciÃ³n de alertas importantes y rankings en tiempo real -->
<section id="alertas-y-ranking" class="seccion-alertas">
  <h2>ğŸ”” Alertas y desempeÃ±o</h2>
  <div class="contenedor-alertas">
    {% if alertas.empresa_mas_activas %}
    <div class="alert-card">
      <div class="alert-icon">ğŸ¢</div>
      <div class="alert-info">
        <strong>Empresa con mÃ¡s tareas activas:</strong><br>
        {{ alertas.empresa_mas_activas.nombre }} ({{ alertas.empresa_mas_activas.total }} tareas)
      </div>
    </div>
    {% endif %}
    {% if alertas.usuario_mas_atrasado %}
    <div class="alert-card">
      <div class="alert-icon">ğŸ§</div>
      <div class="alert-info">
        <strong>Usuario con mÃ¡s tareas vencidas:</strong><br>
        {{ alertas.usuario_mas_atrasado.nombre }} ({{ alertas.usuario_mas_atrasado.total }} vencidas)
      </div>
    </div>
    {% endif %}
    <div class="alert-card">
      <div class="alert-icon">âš ï¸</div>
      <div class="alert-info">
        <strong>Usuarios sin actividad en 3+ dÃ­as:</strong><br>
        {% if alertas.usuarios_inactivos %}
          {% for usuario in alertas.usuarios_inactivos %}
            â€¢ {{ usuario.nombre }}<br>
          {% endfor %}
        {% else %}
          <em>Sin alertas por inactividad</em>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Rankings semanales -->
  <div class="ranking-tareas">
    <h3>ğŸ† Rankings semanales</h3>
    <table>
      <thead>
        <tr>
          <th>Usuario</th>
          <th>âœ… Completadas</th>
          <th>âŒ Vencidas</th>
          <th>ğŸ“ˆ Eficiencia (%)</th>
        </tr>
      </thead>
      <tbody>
        {% for usuario in alertas.ranking_semanal %}
        <tr>
          <td>{{ usuario.nombre }}</td>
          <td>{{ usuario.completadas }}</td>
          <td>{{ usuario.vencidas }}</td>
          <td>{{ usuario.eficiencia }}%</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- ğŸ‘‰ SecciÃ³n para ver, editar y asignar permisos especiales a usuarios empresa -->
<section id="permisos-equipo" class="seccion-permisos">
  <h2>ğŸ‘¥ Permisos del equipo</h2>

  <p><strong>Supervisores actuales:</strong> {{ supervisores_activos or 0 }}/3</p>

  <form method="POST" action="{{ url_for('panel_cliente_tareas.index_tareas', nombre_nora=nombre_nora) }}">
    <input type="hidden" name="accion" value="guardar_permisos_equipo">

    <table>
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Contacto</th>
          <th>Rol</th>
          <th>ğŸ” Ver todas</th>
          <th>âœï¸ Crear para otros</th>
          <th>ğŸ” Reasignar</th>
        </tr>
      </thead>
      <tbody>
        {% for usuario in usuarios %}
        <tr>
          <td>{{ usuario.nombre }}</td>
          <td>{{ usuario.correo or usuario.telefono }}</td>
          <td>
            {% if usuario.es_supervisor_tareas %}
              Supervisor
            {% else %}
              EstÃ¡ndar
            {% endif %}
          </td>
          <td>
            <input type="checkbox" name="permisos[{{ usuario.id }}][ver_todas_tareas]"
                   {% if usuario.ver_todas_tareas %}checked{% endif %}
                   {% if not usuario.es_supervisor_tareas %}disabled{% endif %}>
          </td>
          <td>
            <input type="checkbox" name="permisos[{{ usuario.id }}][crear_tareas_otros]"
                   {% if usuario.crear_tareas_otros %}checked{% endif %}
                   {% if not usuario.es_supervisor_tareas %}disabled{% endif %}>
          </td>
          <td>
            <input type="checkbox" name="permisos[{{ usuario.id }}][reasignar_tareas]"
                   {% if usuario.reasignar_tareas %}checked{% endif %}
                   {% if not usuario.es_supervisor_tareas %}disabled{% endif %}>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="guardar-config">
      <button type="submit">Guardar permisos</button>
    </div>
  </form>
</section>

<!-- ğŸ‘‰ SecciÃ³n para controlar el estado de los envÃ­os automÃ¡ticos diarios por WhatsApp -->
<section id="seguimiento-whatsapp" class="seccion-seguimiento">
  <h2>ğŸ“² Seguimiento automÃ¡tico por WhatsApp</h2>
  <p>Nora envÃ­a las tareas del dÃ­a a las 8 AM y revisa el estado a las 6 PM.</p>

  <table>
    <thead>
      <tr>
        <th>Usuario</th>
        <th>WhatsApp</th>
        <th>ğŸ“¤ EnvÃ­o 8 AM</th>
        <th>ğŸ” Seguimiento 6 PM</th>
        <th>ğŸ“‹ Tareas enviadas</th>
        <th>âœ… Completadas</th>
      </tr>
    </thead>
    <tbody>
      {% for reporte in reportes_whatsapp %}
      <tr>
        <td>{{ reporte.nombre }}</td>
        <td>{{ reporte.telefono or 'No disponible' }}</td>
        <td>
          {% if reporte.estado_8am == 'enviado' %}
            âœ… Enviado
          {% elif reporte.estado_8am == 'error' %}
            âš ï¸ Error
          {% else %}
            â³ Pendiente
          {% endif %}
        </td>
        <td>
          {% if reporte.estado_6pm == 'completado' %}
            âœ… Seguimiento
          {% elif reporte.estado_6pm == 'error' %}
            âš ï¸ Error
          {% else %}
            â³ Pendiente
          {% endif %}
        </td>
        <td>{{ reporte.tareas_enviadas }}</td>
        <td>{{ reporte.tareas_completadas }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<!-- ğŸ‘‰ SecciÃ³n de verificaciÃ³n del mÃ³dulo de TAREAS -->
<section id="verificacion-modulo" class="seccion-verificacion">
  <h2>âœ… VerificaciÃ³n del mÃ³dulo</h2>

  <table>
    <thead>
      <tr>
        <th>VerificaciÃ³n</th>
        <th>Estado</th>
        <th>Comentario</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Tareas creadas</td>
        <td>{{ verificaciones.tareas_creadas.estado }}</td>
        <td>{{ verificaciones.tareas_creadas.comentario }}</td>
      </tr>
      <tr>
        <td>Tareas asignadas correctamente</td>
        <td>{{ verificaciones.tareas_asignadas.estado }}</td>
        <td>{{ verificaciones.tareas_asignadas.comentario }}</td>
      </tr>
      <tr>
        <td>AutomatizaciÃ³n de tareas recurrentes</td>
        <td>{{ verificaciones.recurrentes.estado }}</td>
        <td>{{ verificaciones.recurrentes.comentario }}</td>
      </tr>
      <tr>
        <td>Recordatorios por WhatsApp</td>
        <td>{{ verificaciones.recordatorios.estado }}</td>
        <td>{{ verificaciones.recordatorios.comentario }}</td>
      </tr>
      <tr>
        <td>EnvÃ­os 8 AM y 6 PM funcionando</td>
        <td>{{ verificaciones.envios_whatsapp.estado }}</td>
        <td>{{ verificaciones.envios_whatsapp.comentario }}</td>
      </tr>
      <tr>
        <td>Plantillas de tareas disponibles</td>
        <td>{{ verificaciones.plantillas.estado }}</td>
        <td>{{ verificaciones.plantillas.comentario }}</td>
      </tr>
      <tr>
        <td>Supervisores activos (mÃ¡x. 3)</td>
        <td>{{ verificaciones.supervisores.estado }}</td>
        <td>{{ verificaciones.supervisores.comentario }}</td>
      </tr>
      <tr>
        <td>Usuarios clientes registrados</td>
        <td>{{ verificaciones.usuarios_clientes.estado }}</td>
        <td>{{ verificaciones.usuarios_clientes.comentario }}</td>
      </tr>
    </tbody>
  </table>
</section>

<section id="lista-tareas" class="seccion-tareas">
  <h2>ğŸ“‹ Tareas activas</h2>

  {% if tareas_activas %}
    <ul class="lista-tareas">
      {% for tarea in tareas_activas %}
      <li class="tarea-item">
        <!-- Icono de estado -->
        {% if tarea.estatus == "completada" %}
          âœ…
        {% elif tarea.estatus in ["vencida", "atrasada"] %}
          â—
        {% else %}
          â³
        {% endif %}

        <!-- CÃ³digo + TÃ­tulo -->
        <strong>{{ tarea.codigo_tarea }}</strong>: {{ tarea.titulo }}

        <!-- Etiquetas de origen -->
        {% if tarea.origen == "plantilla" %}
          <span class="etiqueta">ğŸ§  Plantilla</span>
        {% elif tarea.origen == "recurrente" %}
          <span class="etiqueta">ğŸ” Recurrente</span>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>âœ¨ No hay tareas activas por el momento.</p>
  {% endif %}
</section>
{% endblock contenido %}
