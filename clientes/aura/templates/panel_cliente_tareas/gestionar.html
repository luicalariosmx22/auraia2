<!-- ‚úÖ Archivo: clientes/aura/templates/panel_cliente_tareas/gestionar.html -->
<!-- üëâ Subm√≥dulo CRUD: vista de gesti√≥n de tareas con tabla y botones -->

{% extends "base_cliente.html" %}
{% block contenido %}

<h2 class="text-xl font-semibold mb-4 text-blue-700">üìã Gestor de Tareas</h2>
{% include "panel_cliente_tareas/_filtros.html" %}

<div class="text-right mb-4">
  <button onclick="abrirModalTarea()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
    ‚ûï Nueva tarea
  </button>
</div>

<table class="w-full text-sm border border-gray-300 rounded-lg overflow-hidden">
  <thead class="bg-gray-100">
    <tr>
      <th class="w-8"></th> <!-- checkbox -->
      <th class="px-4 py-2 text-left">T√≠tulo</th>
      <th class="px-4 py-2 text-left">Prioridad</th>
      <th class="px-4 py-2 text-left">Fecha l√≠mite</th>
      <th class="px-4 py-2 text-left">Estatus</th>
      <th class="px-4 py-2 text-left">Asignado a</th>
      <th class="px-4 py-2 text-left">Empresa</th>
      <th class="px-4 py-2 text-left">Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for tarea in tareas %}
    {% set editable = permisos.es_supervisor or tarea.usuario_empresa_id == user.id %}
    <tr class="border-t border-gray-200" data-id="{{ tarea.id }}">
      <!-- checkbox estatus -->
      <td class="text-center">
        <input type="checkbox"
               {% if tarea.estatus == 'completada' %}checked{% endif %}
               {% if not editable %}disabled{% endif %}
               onchange="toggleEstatus(this)">
      </td>

      <!-- t√≠tulo editable -->
      <td class="px-4 py-2">
        {% if editable %}
          <input type="text"
                 class="w-full bg-transparent focus:bg-white border border-transparent focus:border-gray-300 rounded px-1"
                 value="{{ tarea.titulo }}"
                 onblur="updateCampo(this,'titulo')">
        {% else %}
          {{ tarea.titulo }}
        {% endif %}
      </td>

      <!-- prioridad con icono -->
      <td class="px-4 py-2 capitalize">
        {% if editable %}
          <select onchange="updateCampo(this,'prioridad')" class="bg-transparent">
            <option value="alta" {% if tarea.prioridad=='alta' %}selected{% endif %}>üî¥ Alta</option>
            <option value="media" {% if tarea.prioridad=='media' %}selected{% endif %}>üü† Media</option>
            <option value="baja" {% if tarea.prioridad=='baja' %}selected{% endif %}>üü¢ Baja</option>
          </select>
        {% else %}
          {% if tarea.prioridad=='alta' %}üî¥{% elif tarea.prioridad=='media' %}üü†{% else %}üü¢{% endif %}
          {{ tarea.prioridad }}
        {% endif %}
      </td>

      <!-- fecha l√≠mite -->
      <td class="px-4 py-2">
        {% if editable %}
          <input type="date" value="{{ tarea.fecha_limite }}" onchange="updateCampo(this,'fecha_limite')">
        {% else %}
          {{ tarea.fecha_limite }}
        {% endif %}
      </td>

      <!-- estatus badge / dropdown -->
      <td class="px-4 py-2 capitalize">
        {% if editable %}
          <select onchange="updateCampo(this,'estatus')" class="bg-transparent">
            <option value="pendiente"   {% if tarea.estatus=='pendiente' %}selected{% endif %}>‚è≥ Pendiente</option>
            <option value="en progreso" {% if tarea.estatus=='en progreso' %}selected{% endif %}>üöß En&nbsp;progreso</option>
            <option value="retrasada"   {% if tarea.estatus=='retrasada' %}selected{% endif %}>‚ùó Retrasada</option>
            <option value="completada"  {% if tarea.estatus=='completada' %}selected{% endif %}>‚úÖ Completada</option>
          </select>
        {% else %}
          {% if tarea.estatus=='pendiente' %}‚è≥{% elif tarea.estatus=='en progreso' %}üöß{% elif tarea.estatus=='retrasada' %}‚ùó{% elif tarea.estatus=='completada' %}‚úÖ{% endif %}
          {{ tarea.estatus }}
        {% endif %}
      </td>

      <!-- asignado a -->
      <td class="px-4 py-2">
        {% if editable %}
          <select
            class="bg-transparent"
            onchange="updateCampoSelect('{{ tarea.id }}','asignado_a', this.value)"
          >
            {% for u in usuarios %}
              <option value="{{ u.id }}" {% if u.id == tarea.asignado_a %}selected{% endif %}>{{ u.nombre }}</option>
            {% endfor %}
          </select>
        {% else %}
          {{ usuarios | selectattr('id', 'equalto', tarea.asignado_a) | map(attribute='nombre') | first }}
        {% endif %}
      </td>
      <!-- empresa -->
      <td class="px-4 py-2">
        {% if editable %}
          <select
            class="bg-transparent"
            onchange="updateCampoSelect('{{ tarea.id }}','empresa_id', this.value)"
          >
            {% for e in empresas %}
              <option value="{{ e.id }}" {% if e.id == tarea.empresa_id %}selected{% endif %}>{{ e.nombre_empresa }}</option>
            {% endfor %}
          </select>
        {% else %}
          {{ empresas | selectattr('id', 'equalto', tarea.empresa_id) | map(attribute='nombre_empresa') | first }}
        {% endif %}
      </td>
      <!-- acciones -->
      <td class="px-4 py-2">
        <button onclick="editarTarea('{{ tarea.id }}')" class="text-blue-600 hover:underline text-xs mr-2">Editar</button>
        <button onclick="eliminarTarea('{{ tarea.id }}')" class="text-red-600 hover:underline text-xs">Eliminar</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Modal de tarea -->
<div id="modalTarea" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white w-full max-w-md rounded-xl shadow-lg p-6 relative">
    <h3 class="text-lg font-semibold mb-4 text-blue-700" id="modalTitulo">Nueva tarea</h3>
    <!-- Usamos JS para enviar la data -->
    <form id="formTarea">
      <input type="hidden" name="id" id="tarea_id">
      <input type="hidden" id="nombre_nora" value="{{ nombre_nora }}">
      <input type="hidden" id="usuario_sesion" value="{{ user.id }}">

      <div class="mb-4">
        <label for="titulo" class="block text-sm font-medium text-gray-700">T√≠tulo</label>
        <input type="text" id="titulo" class="w-full border border-gray-300 rounded px-3 py-2 mt-1" required>
      </div>

      <div class="mb-4">
        <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
        <textarea id="descripcion" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 mt-1"></textarea>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label for="fecha_limite" class="block text-sm font-medium text-gray-700">Fecha l√≠mite</label>
          <input type="date" id="fecha_limite" class="w-full border border-gray-300 rounded px-3 py-2 mt-1">
        </div>
        <div>
          <label for="prioridad" class="block text-sm font-medium text-gray-700">Prioridad</label>
          <select id="prioridad" class="w-full border border-gray-300 rounded px-3 py-2 mt-1">
            <option value="baja">Baja</option>
            <option value="media" selected>Media</option>
            <option value="alta">Alta</option>
          </select>
        </div>
      </div>

      <div class="mb-4">
        <label for="usuario_empresa_id" class="block text-sm font-medium text-gray-700">Asignado a</label>
        <select id="usuario_empresa_id" class="w-full border border-gray-300 rounded px-3 py-2 mt-1">
          {% for u in usuarios %}
            <option value="{{ u.id }}" {% if u.id == user.id %}selected{% endif %}>{{ u.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-4">
        <label for="empresa_id" class="block text-sm font-medium text-gray-700">Empresa</label>
        <select id="empresa_id" class="w-full border border-gray-300 rounded px-3 py-2 mt-1" required>
          <option value="" disabled selected>Selecciona una empresa</option>
          {% for e in empresas %}
            <option value="{{ e.id }}">{{ e.nombre_empresa }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="text-right">
        <button type="button" onclick="cerrarModalTarea()" class="text-gray-500 text-sm mr-4">Cancelar</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
  function abrirModalTarea() {
    document.getElementById("modalTarea").classList.remove("hidden");
    document.getElementById("formTarea").reset();
    document.getElementById("tarea_id").value = "";
    document.getElementById("modalTitulo").textContent = "Nueva tarea";
  }

  function cerrarModalTarea() {
    document.getElementById("modalTarea").classList.add("hidden");
  }

  function editarTarea(id) {
    const fila = [...document.querySelectorAll("tr")].find(row => row.innerHTML.includes(id));
    if (!fila) return;
    document.getElementById("modalTarea").classList.remove("hidden");
    document.getElementById("tarea_id").value = id;
    document.getElementById("modalTitulo").textContent = "Editar tarea";
    /* √≠ndices super despu√©s del checkbox: 1-T√≠tulo | 2-Prioridad | 3-Fecha */
    document.getElementById("titulo").value = fila.children[1].innerText.trim();
    /* prioridades pueden venir con emoji, quitamos el primer char si es emoji */
    const prioridadTxt = fila.children[2].innerText.trim().replace(/^[^\w]+/, "");
    document.getElementById("prioridad").value = prioridadTxt.toLowerCase();
    document.getElementById("fecha_limite").value = fila.children[3].innerText.trim();
    document.getElementById("descripcion").value = ""; // No cargamos por seguridad
  }

  function updateCampo(element, campo) {
    const fila = element.closest("tr");
    const id = fila.getAttribute("data-id");
    const valor = element.value;
    fetch(`/panel_cliente/{{ nombre_nora }}/tareas/gestionar/actualizar/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ campo, valor })
    });
  }

  function toggleEstatus(checkbox) {
    const fila = checkbox.closest("tr");
    const id = fila.getAttribute("data-id");
    const estatus = checkbox.checked ? "completada" : "pendiente";
    fetch(`/panel_cliente/{{ nombre_nora }}/tareas/gestionar/actualizar/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ campo: "estatus", valor: estatus })
    });
  }

  // üëâ Para <select> de Asignado a y Empresa (sin recargar)
  function updateCampoSelect(id, campo, valor) {
    fetch(`/panel_cliente/{{ nombre_nora }}/tareas/gestionar/actualizar/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ campo: campo, valor: valor })
    });
  }

  function eliminarTarea(id) {
    if (confirm("¬øSeguro que deseas eliminar esta tarea?")) {
      fetch(`/panel_cliente/{{ nombre_nora }}/tareas/eliminar/${id}`, {
        method: "POST"
      }).then(() => location.reload());
    }
  }
</script>

{% endblock %}
