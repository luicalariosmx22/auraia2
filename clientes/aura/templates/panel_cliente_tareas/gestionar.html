<!-- ✅ Archivo: clientes/aura/templates/panel_cliente_tareas/gestionar.html -->
<!-- 👉 Submódulo CRUD: vista de gestión de tareas con tabla y botones -->

{% extends "base_cliente.html" %}
{% block contenido %}

<div id="contenedorGestorTareas" data-nora="{{ nombre_nora }}">

<h2 class="text-xl font-semibold mb-4 text-blue-700">📋 Gestor de Tareas</h2>
{% if mensaje_bienvenida %}
  <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded mb-4 shadow-sm text-sm">
    {{ mensaje_bienvenida }}
  </div>
{% endif %}

{% include "panel_cliente_tareas/_estadisticas.html" %}
{% include "panel_cliente_tareas/_filtros.html" %}

<div class="flex flex-wrap gap-2 justify-end items-center mb-4">
  {% if permisos.es_supervisor or permisos.es_admin or permisos.es_super_admin %}
    <a href="/panel_cliente/{{ nombre_nora }}/tareas/recurrentes"
       class="inline-flex items-center gap-1 bg-blue-50 text-blue-700 border border-blue-200 px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-100 transition">
      <span class="text-lg">🔁</span> Tareas recurrentes
    </a>
  {% endif %}
  <button id="btnNuevaTarea"
          onclick="document.getElementById('modalNuevaTarea').classList.remove('hidden')"
          class="inline-flex items-center gap-1 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition">
    <span class="text-lg">➕</span> Nueva tarea
  </button>
</div>
{# --- módulo JS para manejar envío vía fetch --- #}
<script src="{{ url_for('static', filename='js/tareas_inline.js') }}"></script>
<script src="{{ url_for('static', filename='js/tareas_modal_nueva.js') }}"></script>
<script src="{{ url_for('static', filename='js/tareas_botones.js') }}"></script>
<script src="{{ url_for('static', filename='js/updateCampo.js') }}"></script>
<script src="{{ url_for('static', filename='js/tareas_modal_ver.js') }}"></script>
<script src="{{ url_for('static', filename='js/tareas_eliminar.js') }}"></script>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    if (typeof initModalVerTareaListeners === "function") {
      initModalVerTareaListeners();
    } else {
      console.warn("⚠️ No se cargó initModalVerTareaListeners");
    }
  });
</script>

<!-- =======================  LISTA ACTIVAS  ======================= -->
<h3 class="text-sm font-semibold text-gray-700 mb-2">⏳ Activas / En progreso</h3>
<table id="tablaTareas" class="w-full text-sm border border-gray-300 rounded-lg overflow-hidden mb-10">
  <thead class="bg-gray-100">
    <tr>
      <th class="w-8"></th> <!-- checkbox -->
      <th class="px-4 py-2 text-left">Título</th>
      <th class="px-4 py-2 text-left">Prioridad</th>
      <th class="px-4 py-2 text-left">Días Restantes</th>
      <th class="px-4 py-2 text-left">Estatus</th>
      <th class="px-4 py-2 text-left">Asignado a</th>
      <th class="px-4 py-2 text-left">Empresa</th>
      <th class="px-4 py-2 text-left">Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for tarea in tareas_activas %}
    <tr class="border-t border-gray-200" data-id="{{ tarea.id }}">
      <td class="text-center">
        <input type="checkbox"
               {% if tarea.estatus == 'completada' %}checked{% endif %}
               {% if not editable %}disabled{% endif %}
               onchange="toggleEstatus(this)">
      </td>
      <td class="px-4 py-2">
        {% if editable %}
          <input type="text"
                 class="w-full bg-transparent focus:bg-white border border-transparent focus:border-gray-300 rounded px-1"
                 value="{{ tarea.titulo }}"
                 onblur="updateCampo(this,'titulo')">
          {% if tarea.recurrente %}
            <span title="Tarea recurrente">🔁</span>
          {% endif %}
        {% else %}
          {{ tarea.titulo }}
          {% if tarea.recurrente %}
            <span title="Tarea recurrente">🔁</span>
          {% endif %}
        {% endif %}
      </td>
      <td class="px-4 py-2 capitalize">
        <select onchange="updateCampo(this,'prioridad')" class="bg-transparent">
          <option value="alta" {% if tarea.prioridad=='alta' %}selected{% endif %}>🔴 Alta</option>
          <option value="media" {% if tarea.prioridad=='media' %}selected{% endif %}>🟠 Media</option>
          <option value="baja" {% if tarea.prioridad=='baja' %}selected{% endif %}>🟢 Baja</option>
        </select>
      </td>
      <td class="px-4 py-2">
        {% if editable %}
          <input type="date" value="{{ tarea.fecha_limite }}" onchange="updateCampo(this,'fecha_limite')">
        {% else %}
          {% if tarea.dias_restantes is not none %}
            {% if tarea.dias_restantes > 0 %}
              <span class="text-green-700 font-medium">{{ tarea.dias_restantes }} días </span>
            {% elif tarea.dias_restantes == 0 %}
              <span class="text-yellow-600 font-medium">Hoy</span>
            {% else %}
              <span class="text-red-600 font-medium">Hace {{ tarea.dias_restantes | abs }} días</span>
            {% endif %}
          {% else %}
            <span class="text-gray-500">Sin fecha</span>
          {% endif %}
        {% endif %}
      </td>
      <td class="px-4 py-2 capitalize">
        <select onchange="updateCampo(this,'estatus')" class="bg-transparent">
          <option value="pendiente"   {% if tarea.estatus=='pendiente' %}selected{% endif %}>⏳ Pendiente</option>
          <option value="en progreso" {% if tarea.estatus=='en progreso' %}selected{% endif %}>🚧 En progreso</option>
          <option value="retrasada"   {% if tarea.estatus=='retrasada' %}selected{% endif %}>❗ Retrasada</option>
          <option value="completada"  {% if tarea.estatus=='completada' %}selected{% endif %}>✅ Completada</option>
        </select>
      </td>
      <td class="px-4 py-2">
        {{ usuarios | selectattr('id', 'equalto', tarea.usuario_empresa_id) | map(attribute='nombre') | first }}
      </td>
      <td class="px-4 py-2">
        {{ empresas | selectattr('id', 'equalto', tarea.empresa_id) | map(attribute='nombre_empresa') | first }}
      </td>
      <td class="px-4 py-2">
        <button class="btn-ver-tarea text-blue-600 hover:underline text-xs mr-2"
                data-id="{{ tarea.id }}"
                data-nora="{{ nombre_nora }}"
                onclick="cargarTareaEnModal(this)">
          Ver
        </button>
        <button data-id="{{ tarea.id }}" class="btn-eliminar-tarea text-red-600 hover:underline text-xs">
          Eliminar
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- =====================  LISTA COMPLETADAS  ===================== -->
{% if tareas_completadas %}
<h3 class="text-sm font-semibold text-gray-600 mb-2">✅ Completadas</h3>
<table class="w-full text-sm border border-gray-300 rounded-lg overflow-hidden">
  <thead class="bg-gray-50">
    <tr>
      <th class="w-8"></th>
      <th class="px-4 py-2 text-left">Título</th>
      <th class="px-4 py-2 text-left">Prioridad</th>
      <th class="px-4 py-2 text-left">Días Restantes</th>
      <th class="px-4 py-2 text-left">Estatus</th>
      <th class="px-4 py-2 text-left">Asignado a</th>
      <th class="px-4 py-2 text-left">Empresa</th>
      <th class="px-4 py-2 text-left">Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for tarea in tareas_completadas %}
      <tr class="border-t border-gray-200 opacity-70" data-id="{{ tarea.id }}">
        <!-- checkbox estatus -->
        <td class="text-center">
          <input type="checkbox"
                 {% if tarea.estatus == 'completada' %}checked{% endif %}
                 {% if not editable %}disabled{% endif %}
                 onchange="toggleEstatus(this)">
        </td>
        <!-- título editable -->
        <td class="px-4 py-2">
          {% if editable %}
            <input type="text"
                   class="w-full bg-transparent focus:bg-white border border-transparent focus:border-gray-300 rounded px-1"
                   value="{{ tarea.titulo }}"
                   onblur="updateCampo(this,'titulo')">
            {% if tarea.recurrente %}
              <span title="Tarea recurrente">🔁</span>
            {% endif %}
          {% else %}
            {{ tarea.titulo }}
            {% if tarea.recurrente %}
              <span title="Tarea recurrente">🔁</span>
            {% endif %}
          {% endif %}
        </td>
        <!-- prioridad con icono -->
        <td class="px-4 py-2 capitalize">
          {% if editable %}
            <select onchange="updateCampo(this,'prioridad')" class="bg-transparent">
              <option value="alta" {% if tarea.prioridad=='alta' %}selected{% endif %}>🔴 Alta</option>
              <option value="media" {% if tarea.prioridad=='media' %}selected{% endif %}>🟠 Media</option>
              <option value="baja" {% if tarea.prioridad=='baja' %}selected{% endif %}>🟢 Baja</option>
            </select>
          {% else %}
            {% if tarea.prioridad=='alta' %}🔴{% elif tarea.prioridad=='media' %}🟠{% else %}🟢{% endif %}
            {{ tarea.prioridad }}
          {% endif %}
        </td>
        <!-- fecha límite -->
        <td class="px-4 py-2">
          {% if editable %}
            <input type="date" value="{{ tarea.fecha_limite }}" onchange="updateCampo(this,'fecha_limite')">
          {% else %}
            {% if tarea.dias_restantes is not none %}
              {% if tarea.dias_restantes > 0 %}
                <span class="text-green-700 font-medium">{{ tarea.dias_restantes }} días</span>
              {% elif tarea.dias_restantes == 0 %}
                <span class="text-yellow-600 font-medium">Hoy</span>
              {% else %}
                <span class="text-red-600 font-medium">Hace {{ tarea.dias_restantes | abs }} días</span>
              {% endif %}
            {% else %}
              <span class="text-gray-500">Sin fecha</span>
            {% endif %}
          {% endif %}
        </td>
        <!-- estatus badge / dropdown -->
        <td class="px-4 py-2 capitalize">
          {% if editable %}
            <select onchange="updateCampo(this,'estatus')" class="bg-transparent">
              <option value="pendiente"   {% if tarea.estatus=='pendiente' %}selected{% endif %}>⏳ Pendiente</option>
              <option value="en progreso" {% if tarea.estatus=='en progreso' %}selected{% endif %}>🚧 En progreso</option>
              <option value="retrasada"   {% if tarea.estatus=='retrasada' %}selected{% endif %}>❗ Retrasada</option>
              <option value="completada"  {% if tarea.estatus=='completada' %}selected{% endif %}>✅ Completada</option>
            </select>
          {% else %}
            {% if tarea.estatus=='pendiente' %}⏳{% elif tarea.estatus=='en progreso' %}🚧{% elif tarea.estatus=='retrasada' %}❗{% elif tarea.estatus=='completada' %}✅{% endif %}
            {{ tarea.estatus }}
          {% endif %}
        </td>
        <!-- asignado a (usa usuario_empresa_id) -->
        <td class="px-4 py-2">
          {{ usuarios | selectattr('id', 'equalto', tarea.usuario_empresa_id) | map(attribute='nombre') | first }}
        </td>
        <!-- empresa -->
        <td class="px-4 py-2">
          {{ empresas | selectattr('id', 'equalto', tarea.empresa_id) | map(attribute='nombre_empresa') | first }}
        </td>
        <!-- acciones -->
        <td class="px-4 py-2">
          <button class="btn-ver-tarea text-blue-600 hover:underline text-xs mr-2"
                  data-id="{{ tarea.id }}"
                  data-nora="{{ nombre_nora }}"
                  onclick="cargarTareaEnModal(this)">
            Ver
          </button>
          <button data-id="{{ tarea.id }}" class="btn-eliminar-tarea text-red-600 hover:underline text-xs">
            Eliminar
          </button>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

{% include "panel_cliente_tareas/_modal_tarea.html" %}
{% include "panel_cliente_tareas/_modal_nueva_tarea.html" %}

</div> <!-- Cierra contenedorGestorTareas -->

{% endblock %}

