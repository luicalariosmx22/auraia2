<!-- âœ… Archivo: clientes/aura/templates/panel_cliente_tareas/gestionar.html -->
<!-- ğŸ‘‰ SubmÃ³dulo CRUD: vista de gestiÃ³n de tareas con tabla y botones -->

{% extends "base_cliente.html" %}
{% block contenido %}

<div id="contenedorGestorTareas" data-nora="{{ nombre_nora }}">

{# Saludo con nombre y rol del usuario #}
{% set rol = 'Usuario normal' %}
{% if permisos.es_super_admin %}
  {% set rol = 'Superadmin' %}
{% elif permisos.es_admin %}
  {% set rol = 'Admin' %}
{% elif permisos.es_supervisor %}
  {% set rol = 'Supervisor' %}
{% endif %}
<div class="bg-green-50 text-green-900 px-4 py-2 rounded mb-4 shadow-sm text-sm flex items-center gap-2">
  <span>ğŸ‘‹ Hola, <strong>{{ user.name }}</strong> &mdash; <span class="font-semibold">{{ rol }}</span></span>
</div>

<h2 class="text-xl font-semibold mb-4 text-blue-700">ğŸ“‹ Gestor de Tareas</h2>
{% if mensaje_bienvenida %}
  <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded mb-4 shadow-sm text-sm">
    {{ mensaje_bienvenida }}
  </div>
{% endif %}

{% include "panel_cliente_tareas/_estadisticas.html" %}
{% include "panel_cliente_tareas/_filtros.html" %}

<div class="flex flex-wrap gap-2 justify-between items-center mb-4">
  <div>
    <form method="get" id="formOrdenTareas" class="inline-block">
      <label for="ordenTareas" class="text-sm text-gray-700 mr-1">Ordenar por:</label>
      <select name="orden" id="ordenTareas" class="border rounded px-2 py-1 text-sm" onchange="this.form.submit()">
        <option value="desc" {% if orden == 'desc' or not orden %}selected{% endif %}>MÃ¡s recientes primero</option>
        <option value="asc" {% if orden == 'asc' %}selected{% endif %}>MÃ¡s antiguas primero</option>
      </select>
      <input type="hidden" name="page" value="{{ page }}">
      <input type="hidden" name="per_page" value="{{ per_page }}">
    </form>
  </div>
  <div class="flex gap-2">
    <a href="/panel_cliente/{{ nombre_nora }}/tareas/completadas"
       class="inline-flex items-center gap-1 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition">
      <span class="text-lg">âœ…</span> Completadas
    </a>
    {% if permisos.es_supervisor or permisos.es_admin or permisos.es_super_admin %}
      <a href="/panel_cliente/{{ nombre_nora }}/tareas/recurrentes"
         class="inline-flex items-center gap-1 bg-blue-50 text-blue-700 border border-blue-200 px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-100 transition">
        <span class="text-lg">ğŸ”</span> Tareas recurrentes
      </a>
    {% endif %}
    <button id="btnNuevaTarea"
            onclick="document.getElementById('modalNuevaTarea').classList.remove('hidden')"
            class="inline-flex items-center gap-1 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition">
      <span class="text-lg">â•</span> Nueva tarea
    </button>
  </div>
</div>
{# --- mÃ³dulo JS para manejar envÃ­o vÃ­a fetch --- #}


<script>
  document.addEventListener("DOMContentLoaded", () => {
    if (typeof initModalVerTareaListeners === "function") {
      initModalVerTareaListeners();
    } else {
      console.warn("âš ï¸ No se cargÃ³ initModalVerTareaListeners");
    }
  });
</script>

<!-- =======================  LISTA ACTIVAS  ======================= -->
<h3 class="text-sm font-semibold text-gray-700 mb-2">â³ Activas / En progreso</h3>
<table id="tablaTareas" class="w-full text-sm border border-gray-300 rounded-lg overflow-hidden mb-10">
  <thead class="bg-gray-100">
    <tr>
      <th class="w-8"></th> <!-- checkbox -->
      <th class="px-4 py-2 text-left">TÃ­tulo</th>
      <th class="px-4 py-2 text-left">Prioridad</th>
      <th class="px-4 py-2 text-left">DÃ­as Restantes</th>
      <th class="px-4 py-2 text-left">Estatus</th>
      <th class="px-4 py-2 text-left">Asignado a</th>
      <th class="px-4 py-2 text-left">Empresa</th>
      <th class="px-4 py-2 text-left">Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for tarea in tareas_activas %}
    <tr class="border-t border-gray-200" data-id="{{ tarea.id }}">
      <td class="text-center">
        {% if tarea.subtareas and tarea.subtareas|length > 0 %}
        <button type="button" onclick="toggleSubtareas('{{ tarea.id }}')" class="focus:outline-none group">
          <svg id="flecha-{{ tarea.id }}" class="inline w-4 h-4 text-gray-500 group-hover:text-blue-600 transition-transform rotate-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        {% endif %}
        <input type="checkbox"
               {% if tarea.estatus == 'completada' %}checked{% endif %}
               onchange="toggleEstatus(this)">
      </td>
      <td class="px-4 py-2">
        <input type="text"
               class="w-full bg-transparent focus:bg-white border border-transparent focus:border-gray-300 rounded px-1"
               value="{{ tarea.titulo }}"
               onblur="updateCampo(this,'titulo')"
               data-id="{{ tarea.id }}">
      </td>
      <td class="px-4 py-2 text-center">
        {% if tarea.prioridad == 'alta' %}
          <span title="Prioridad alta" class="text-lg align-middle">ğŸ”´</span>
        {% elif tarea.prioridad == 'media' %}
          <span title="Prioridad media" class="text-lg align-middle">ğŸŸ </span>
        {% else %}
          <span title="Prioridad baja" class="text-lg align-middle">ğŸŸ¢</span>
        {% endif %}
        {% if tarea.recurrente or tarea.is_recurrente %}
          <span title="Tarea recurrente" class="ml-1 align-middle">ğŸ”</span>
        {% endif %}
        {% if tarea.comentarios_count and tarea.comentarios_count > 0 %}
          <span title="Tiene comentarios/actualizaciones" class="ml-1 align-middle">ğŸ’¬</span>
        {% endif %}
      </td>
      <td class="px-4 py-2">
        <input type="date" value="{{ tarea.fecha_limite }}" onchange="updateCampo(this,'fecha_limite')" data-id="{{ tarea.id }}">
      </td>
      <td class="px-4 py-2 capitalize">
        <select onchange="updateCampo(this,'estatus')" class="bg-transparent" data-id="{{ tarea.id }}">
          <option value="pendiente"   {% if tarea.estatus=='pendiente' %}selected{% endif %}>â³ Pendiente</option>
          <option value="en progreso" {% if tarea.estatus=='en progreso' %}selected{% endif %}>ğŸš§ En progreso</option>
          <option value="retrasada"   {% if tarea.estatus=='retrasada' %}selected{% endif %}>â— Retrasada</option>
          <option value="completada"  {% if tarea.estatus=='completada' %}selected{% endif %}>âœ… Completada</option>
        </select>
      </td>
      <td class="px-4 py-2">
        <select onchange="updateCampo(this,'usuario_empresa_id')" class="bg-transparent w-full" data-id="{{ tarea.id }}">
          {% for usuario in usuarios %}
            {% if usuario.nombre != 'Luica Larios Admin' %}
              <option value="{{ usuario.id }}" {% if usuario.id == tarea.usuario_empresa_id %}selected{% endif %}>{{ usuario.nombre }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </td>
      <td class="px-4 py-2">
        <select onchange="updateCampo(this,'empresa_id')" class="bg-transparent w-full" data-id="{{ tarea.id }}">
          {% for empresa in empresas|sort(attribute='nombre_empresa') %}
            <option value="{{ empresa.id }}" {% if empresa.id == tarea.empresa_id %}selected{% endif %}>{{ empresa.nombre_empresa }}</option>
          {% endfor %}
        </select>
      </td>
      <td class="px-4 py-2">
        <button class="btn-ver-tarea text-blue-600 hover:underline text-xs mr-2"
                data-id="{{ tarea.id }}"
                data-nora="{{ nombre_nora }}">
          Ver
        </button>
        <button data-id="{{ tarea.id }}" class="btn-eliminar-tarea text-red-600 hover:underline text-xs">
          Eliminar
        </button>
      </td>
    </tr>
    <tr id="subtareas-{{ tarea.id }}" class="hidden">
      <td colspan="8" class="p-0 border-0">
        {% if tarea.subtareas and tarea.subtareas|length > 0 %}
        <table class="w-full text-sm">
          <tbody>
            {% for s in tarea.subtareas %}
            <tr data-subtarea-id="{{ s.id }}" class="bg-blue-50 border-t border-blue-100">
              <td class="text-center pl-8">
                <span title="Subtarea" class="inline-block mr-1 text-blue-400">â†³</span>
                <input type="checkbox" {% if s.estatus == 'completada' %}checked{% endif %} onchange="updateCampoSubtarea(this, 'estatus')">
              </td>
              <td class="px-4 py-2">
                <input type="text" value="{{ s.titulo }}" class="w-full bg-transparent border border-transparent focus:border-gray-300 rounded px-1" onblur="updateCampoSubtarea(this, 'titulo')">
              </td>
              <td class="px-4 py-2 capitalize">
                <select onchange="updateCampoSubtarea(this, 'prioridad')" class="bg-transparent d-none" data-id="{{ s.id }}" style="display:none">
                  <option value="alta" {% if s.prioridad=='alta' %}selected{% endif %}>ğŸ”´ Alta</option>
                  <option value="media" {% if s.prioridad=='media' %}selected{% endif %}>ğŸŸ  Media</option>
                  <option value="baja" {% if s.prioridad=='baja' %}selected{% endif %}>ğŸŸ¢ Baja</option>
                </select>
              </td>
              <td class="px-4 py-2">
                <input type="date" value="{{ s.fecha_limite or '' }}" onchange="updateCampoSubtarea(this, 'fecha_limite')">
              </td>
              <td class="px-4 py-2 capitalize">
                <select onchange="updateCampoSubtarea(this, 'estatus')" class="bg-transparent">
                  <option value="pendiente"   {% if s.estatus=='pendiente' %}selected{% endif %}>â³ Pendiente</option>
                  <option value="en progreso" {% if s.estatus=='en progreso' %}selected{% endif %}>ğŸš§ En progreso</option>
                  <option value="retrasada"   {% if s.estatus=='retrasada' %}selected{% endif %}>â— Retrasada</option>
                  <option value="completada"  {% if s.estatus=='completada' %}selected{% endif %}>âœ… Completada</option>
                </select>
              </td>
              <td class="px-4 py-2">
                <select onchange="updateCampoSubtarea(this, 'usuario_empresa_id')" class="bg-transparent w-full" data-id="{{ s.id }}">
                  {% for usuario in usuarios %}
                    {% if usuario.nombre != 'Luica Larios Admin' %}
                      <option value="{{ usuario.id }}" {% if usuario.id == s.usuario_empresa_id %}selected{% endif %}>{{ usuario.nombre }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </td>
              <td class="px-4 py-2">
                <select onchange="updateCampoSubtarea(this, 'empresa_id')" class="bg-transparent w-full" data-id="{{ s.id }}">
                  {% for empresa in empresas|sort(attribute='nombre_empresa') %}
                    <option value="{{ empresa.id }}" {% if empresa.id == s.empresa_id %}selected{% endif %}>{{ empresa.nombre_empresa }}</option>
                  {% endfor %}
                </select>
              </td>
              <td class="px-4 py-2">
                <button class="btn-ver-tarea text-blue-600 hover:underline text-xs mr-2" data-id="{{ s.id }}" data-nora="{{ nombre_nora }}">Ver</button>
                <button data-id="{{ s.id }}" class="btn-eliminar-tarea text-red-600 hover:underline text-xs">Eliminar</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<!-- PaginaciÃ³n -->
<div class="flex justify-center items-center gap-2 my-4">
  {% if page > 1 %}
    <a href="?page={{ page - 1 }}&per_page={{ per_page }}" class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 text-blue-700">Anterior</a>
  {% endif %}
  <span class="text-sm text-gray-700">PÃ¡gina {{ page }} de {{ total_pages }}</span>
  {% if page < total_pages %}
    <a href="?page={{ page + 1 }}&per_page={{ per_page }}" class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 text-blue-700">Siguiente</a>
  {% endif %}
</div>

{% include "panel_cliente_tareas/_modal_tarea.html" %}
{% include "panel_cliente_tareas/_modal_nueva_tarea.html" %}

</div> <!-- Cierra contenedorGestorTareas -->

<script>
// --- Lazy-load tareas completadas ---
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('btnMostrarCompletadas');
  const loading = document.getElementById('completadasLoading');
  const error = document.getElementById('completadasError');
  const vacio = document.getElementById('completadasVacias');
  const tablaContainer = document.getElementById('contenedorCompletadasTabla');
  let loaded = false;
  if (btn) {
    btn.addEventListener('click', function() {
      if (loaded) return; // Solo cargar una vez
      btn.disabled = true;
      loading.classList.remove('hidden');
      error.classList.add('hidden');
      vacio.classList.add('hidden');
      fetch(`/panel_cliente/{{ nombre_nora }}/tareas/completadas_json`)
        .then(response => {
          if (!response.ok) throw new Error('Network');
          return response.json();
        })
        .then((data) => {
          loading.classList.add('hidden');
          if (!data || !data.tareas || data.tareas.length === 0) {
            vacio.classList.remove('hidden');
            return;
          }
          tablaContainer.innerHTML = renderCompletadasTable(data.tareas);
          loaded = true;
        })
        .catch(e => {
          loading.classList.add('hidden');
          error.classList.remove('hidden');
          console.error('Error cargando tareas completadas', e);
        });
    });
  }
});

function renderCompletadasTable(tareas) {
  let html = `<table class="w-full text-sm border border-gray-300 rounded-lg overflow-hidden">
    <thead class="bg-gray-50">
      <tr>
        <th class="w-8"></th>
        <th class="px-4 py-2 text-left">TÃ­tulo</th>
        <th class="px-4 py-2 text-left">Prioridad</th>
        <th class="px-4 py-2 text-left">DÃ­as Restantes</th>
        <th class="px-4 py-2 text-left">Estatus</th>
        <th class="px-4 py-2 text-left">Asignado a</th>
        <th class="px-4 py-2 text-left">Empresa</th>
        <th class="px-4 py-2 text-left">Acciones</th>
      </tr>
    </thead>
    <tbody>`;

  tareas.forEach(tarea => {
    html += `<tr class="border-t border-gray-200 opacity-70" data-id="${tarea.id}">
      <td class="text-center"><input type="checkbox" ${tarea.estatus === 'completada' ? 'checked' : ''} disabled></td>
      <td class="px-4 py-2">
        ${tarea.titulo}
        ${tarea.recurrente || tarea.is_recurrente ? '<span title="Tarea recurrente">ğŸ”</span>' : ''}
        ${tarea.comentarios_count && tarea.comentarios_count > 0 ? '<span title="Tiene comentarios">ğŸ’¬</span>' : ''}
      </td>
      <td class="px-4 py-2 capitalize">
        ${tarea.prioridad === 'alta' ? 'ğŸ”´' : tarea.prioridad === 'media' ? 'ğŸŸ ' : 'ğŸŸ¢'} ${tarea.prioridad}
      </td>
      <td class="px-4 py-2">
        ${
          tarea.dias_restantes !== null
            ? tarea.dias_restantes > 0
              ? `<span class="text-green-700 font-medium">${tarea.dias_restantes} dÃ­as</span>`
              : tarea.dias_restantes === 0
                ? `<span class="text-yellow-600 font-medium">Hoy</span>`
                : `<span class="text-red-600 font-medium">Hace ${Math.abs(tarea.dias_restantes)} dÃ­as</span>`
            : '<span class="text-gray-500">Sin fecha</span>'
        }
      </td>
      <td class="px-4 py-2 capitalize">${tarea.estatus}</td>
      <td class="px-4 py-2">${tarea.asignado_a || ''}</td>
      <td class="px-4 py-2">${tarea.empresa || ''}</td>
      <td class="px-4 py-2">
        <button class="btn-ver-tarea text-blue-600 hover:underline text-xs mr-2" data-id="${tarea.id}" data-nora="{{ nombre_nora }}">Ver</button>
        <button data-id="${tarea.id}" class="btn-eliminar-tarea text-red-600 hover:underline text-xs">Eliminar</button>
      </td>
    </tr>`;
  });

  html += '</tbody></table>';
  return html;
}
</script>
<script src="{{ url_for('static', filename='js/tareas_inline.js') }}"></script>
<script src="{{ url_for('static', filename='js/tareas_botones.js') }}"></script>
<script src="{{ url_for('static', filename='js/updateCampo.js') }}"></script>
<script src="{{ url_for('static', filename='js/tareas_modal_ver.js') }}"></script>
<script src="{{ url_for('static', filename='js/tareas_eliminar.js') }}"></script>
<script src="{{ url_for('static', filename='js/tareas_modal_nueva.js') }}"></script>
<script>
window.updateCampoSubtarea = async function(elemento, campo) {
  const fila = elemento.closest('tr');
  const subtareaId = fila.getAttribute('data-subtarea-id');
  const tareaId = fila.closest('tr[data-id]')?.getAttribute('data-id') || null;
  const nombreNora = document.body.dataset.nora || document.body.dataset.noraname || document.body.dataset.noranombre || document.body.dataset.noranora;
  let valor;
  if (campo === 'estatus' && elemento.type === 'checkbox') {
    valor = elemento.checked ? 'completada' : 'pendiente';
  } else {
    valor = elemento.value;
  }
  try {
    const res = await fetch(`/panel_cliente/${nombreNora}/subtareas/actualizar/${subtareaId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ campo, valor })
    });
    const data = await res.json();
    if (data.ok) {
      mostrarNotificacion('âœ… Subtarea actualizada');
      // Si se completÃ³, recargar el bloque de subtareas
      if (campo === 'estatus' && valor === 'completada' && tareaId) {
        // Forzar recarga del bloque de subtareas
        const filaSub = document.getElementById('subtareas-' + tareaId);
        const contenedor = document.getElementById('contenedor-subtareas-' + tareaId);
        if (filaSub && contenedor) {
          contenedor.innerHTML = '<span class="text-gray-400">Cargando subtareas...</span>';
          filaSub.dataset.cargado = '';
          toggleSubtareas(tareaId); // Oculta
          toggleSubtareas(tareaId); // Vuelve a mostrar y recarga
        } else {
          window.location.reload();
        }
      }
    } else {
      alert(data.error || 'Error al actualizar subtarea');
    }
  } catch (err) {
    alert('Error de red al actualizar subtarea');
  }
};
</script>
<script>
function toggleSubtareas(tareaId) {
  const fila = document.getElementById('subtareas-' + tareaId);
  const flecha = document.getElementById('flecha-' + tareaId);
  if (!fila) return;
  const visible = !fila.classList.contains('hidden');
  if (visible) {
    fila.classList.add('hidden');
    if (flecha) flecha.classList.remove('rotate-180');
  } else {
    fila.classList.remove('hidden');
    if (flecha) flecha.classList.add('rotate-180');
  }
}
</script>

{% endblock %}

