<!-- Aseg√∫rate de tener esto en el layout/base: -->
<body data-nora="{{ nombre_nora }}">

<!-- Modal VER TAREA (nuevo dise√±o tipo tailwind, limpio) -->
<div id="modalVerTarea" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" aria-modal="true" role="dialog">
  <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-0 relative animate-fade-in">
    <form id="formVerTarea" class="divide-y divide-gray-200">
      <!-- Header -->
      <div class="flex items-center justify-between px-6 py-4 rounded-t-2xl bg-gradient-to-r from-blue-600 to-blue-400">
        <h2 class="text-xl font-bold text-white">Ver / Editar tarea</h2>
        <button type="button" onclick="cerrarModalVerTarea()" aria-label="Cerrar" class="text-white hover:text-blue-100 text-2xl leading-none focus:outline-none">&times;</button>
      </div>

      <!-- Body -->
      <div class="px-6 py-6 space-y-6 max-h-[70vh] overflow-y-auto">
        <input type="hidden" id="verIdTarea" name="id">
        <div>
          <label for="verTitulo" class="block text-sm font-semibold text-gray-700 mb-1">T√≠tulo</label>
          <input type="text" id="verTitulo" name="titulo"
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="verFechaLimite" class="block text-sm font-semibold text-gray-700 mb-1">Fecha l√≠mite</label>
            <input type="date" id="verFechaLimite" name="fecha_limite"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
          </div>
          <div>
            <label for="verPrioridad" class="block text-sm font-semibold text-gray-700 mb-1">Prioridad</label>
            <select id="verPrioridad" name="prioridad"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
              <option value="baja">Baja</option>
              <option value="media">Media</option>
              <option value="alta">Alta</option>
            </select>
          </div>
        </div>

        <div>
          <label for="verDescripcion" class="block text-sm font-semibold text-gray-700 mb-1">Descripci√≥n</label>
          <textarea id="verDescripcion" name="descripcion" rows="3"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 text-base"></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="verEstatus" class="block text-sm font-semibold text-gray-700 mb-1">Estatus</label>
            <select id="verEstatus" name="estatus"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
              <option value="pendiente">Pendiente</option>
              <option value="en progreso">En progreso</option>
              <option value="retrasada">Retrasada</option>
              <option value="completada">Completada</option>
            </select>
          </div>
          <!-- ‚úÖ Campo EMPRESA (solo visible como texto o input readonly) -->
          <div class="col-md-12">
            <label>Empresa</label>
            <input type="text" class="form-control" id="verEmpresaTexto" name="empresa_nombre" readonly disabled>
            <input type="hidden" id="verEmpresa" name="empresa_id">
          </div>
          <!-- ‚úÖ Campo ASIGNADO A (solo si tiene permisos) -->
          <div class="col-md-4">
            <label>Asignado a</label>
            <select class="form-select" id="verAsignado" name="usuario_empresa_id">
              {% for u in usuarios %}
                <option value="{{ u.id }}" {% if (usuario_empresa_id and u.id == usuario_empresa_id) or (not usuario_empresa_id and u.id == user.id) %}selected{% endif %}>{{ u.nombre }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="flex justify-end gap-3 px-6 py-4 bg-gray-50 rounded-b-2xl">
        <button type="button" onclick="cerrarModalVerTarea()" class="text-gray-600 hover:text-blue-600 font-medium px-4 py-2 rounded transition">Cancelar</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded shadow transition">Guardar cambios</button>
      </div>
    </form>
  </div>
</div>
<script>
  function cerrarModalVerTarea() {
    document.getElementById("modalVerTarea")?.classList.add("hidden");
  }
</script>

<!-- Modal para crear tarea (nuevo dise√±o, √∫nico y limpio) -->
<!-- SOLO PARA PRUEBA -->
<div id="modalNuevaTarea" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-0 relative animate-fade-in">
    <form id="formTareaNueva" class="divide-y divide-gray-200" onsubmit="return false;">
      <!-- Header -->
      <div class="flex items-center justify-between px-6 py-4 rounded-t-2xl bg-gradient-to-r from-blue-600 to-blue-400">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
          <span class="inline-block bg-white bg-opacity-20 rounded-full p-2">
            <svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-white' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
              <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 4v16m8-8H4'/>
            </svg>
          </span>
          Crear nueva tarea
        </h2>
        <button type="button" onclick="cerrarModalTarea()" aria-label="Cerrar" class="text-white hover:text-blue-100 text-2xl leading-none focus:outline-none">&times;</button>
      </div>

      <!-- Body -->
      <div class="px-6 py-6 space-y-6 max-h-[90vh] overflow-y-auto">
        <!-- T√≠tulo -->
        <div>
          <label for="titulo" class="block text-sm font-semibold text-gray-700 mb-1">T√≠tulo <span class="text-red-500">*</span></label>
          <input type="text" name="titulo" id="titulo" required autofocus
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
        </div>

        <!-- Fecha y Prioridad -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="fecha_limite" class="block text-sm font-semibold text-gray-700 mb-1">Fecha l√≠mite</label>
            <input type="date" name="fecha_limite" id="fecha_limite"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
          </div>
          <div>
            <label for="prioridad" class="block text-sm font-semibold text-gray-700 mb-1">Prioridad</label>
            <select name="prioridad" id="prioridad"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
              <option value="baja">Baja</option>
              <option value="media" selected>Media</option>
              <option value="alta">Alta</option>
            </select>
          </div>
        </div>

        <!-- Descripci√≥n -->
        <div>
          <label for="descripcion" class="block text-sm font-semibold text-gray-700 mb-1">Descripci√≥n</label>
          <textarea id="descripcion" name="descripcion" rows="3"
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 mt-1 focus:outline-none focus:ring-2 focus:ring-blue-400 text-base"></textarea>
        </div>

        <!-- Estatus, Empresa, Asignado -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="estatus" class="block text-sm font-semibold text-gray-700 mb-1">Estatus</label>
            <select name="estatus" id="estatus"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
              <option value="pendiente" selected>‚è≥ Pendiente</option>
              <option value="en progreso">üöß En progreso</option>
              <option value="retrasada">‚ùó Retrasada</option>
              <option value="completada">‚úÖ Completada</option>
            </select>
          </div>

          <div>
            <label for="empresa_id_modal" class="block text-sm font-semibold text-gray-700 mb-1">Empresa</label>
            <select name="empresa_id" id="empresa_id_modal"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
              <option value="">‚Äî Sin empresa ‚Äî</option>
              {% for e in empresas %}
                <option value="{{ e.id }}" {% if empresa_id and e.id == empresa_id %}selected{% endif %}>{{ e.nombre_empresa }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- üõ†Ô∏è CAMBIO: Campo "Asignado a" muestra todos los usuarios, pero est√° readonly si no tienes permisos -->
          <div>
            <label for="usuario_empresa_id_modal" class="block text-sm font-semibold text-gray-700 mb-1">Asignado a</label>
            <select name="usuario_empresa_id" id="usuario_empresa_id_modal"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
              {% for u in usuarios %}
                {% if u.nombre != 'Luica Larios Admin' %}
                  <option value="{{ u.id }}" {% if (usuario_empresa_id and u.id == usuario_empresa_id) or (not usuario_empresa_id and u.id == user.id) %}selected{% endif %}>{{ u.nombre }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Recurrencia -->
        <div class="pt-2">
          <input type="hidden" name="is_recurrente" value="false">
          <label class="inline-flex items-center cursor-pointer">
            <input type="checkbox" id="recurrente_checkbox" name="is_recurrente"
                   value="true"
                   class="form-checkbox h-5 w-5 text-blue-600 rounded">
            <span class="ml-2 text-sm text-gray-700">¬øEs una tarea recurrente?</span>
          </label>
        </div>

        <div id="recurrente_fields" class="hidden space-y-3 bg-blue-50 rounded-lg p-4 border border-blue-100">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="dtstart" class="block text-sm font-semibold text-gray-700 mb-1">Fecha de inicio</label>
              <input type="date" id="dtstart" name="dtstart" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
            </div>
            <div>
              <label for="rrule" class="block text-sm font-semibold text-gray-700 mb-1">Recurrencia</label>
              <select id="rrule" name="rrule" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
                <option value="FREQ=DAILY">Diaria</option>
                <option value="FREQ=WEEKLY">Semanal</option>
                <option value="FREQ=MONTHLY">Mensual</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="until" class="block text-sm font-semibold text-gray-700 mb-1">Fecha fin (opcional)</label>
              <input type="date" id="until" name="until" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
            </div>
            <div>
              <label for="count" class="block text-sm font-semibold text-gray-700 mb-1">Repeticiones (opcional)</label>
              <input type="number" id="count" name="count" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
            </div>
          </div>
        </div>

        <!-- Tarea padre (opcional, para subtareas) -->
        <div>
          <label for="tarea_padre_id" class="block text-sm font-semibold text-gray-700 mb-1">¬øSubtarea de?</label>
          <select name="tarea_padre_id" id="tarea_padre_id" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
            <option value="">‚Äî Ninguna (tarea principal) ‚Äî</option>
            {% for t in tareas_activas %}
              <option value="{{ t.id }}">{{ t.titulo }}</option>
            {% endfor %}
          </select>
          <p class="text-xs text-gray-500 mt-1">Si seleccionas una tarea, esta ser√° una subtarea ligada a la principal.</p>
        </div>
      </div>

      <!-- Footer -->
      <div class="flex justify-end gap-3 px-6 py-4 bg-gray-50 rounded-b-2xl">
        <button type="button" onclick="cerrarModalTarea()" class="text-gray-600 hover:text-blue-600 font-medium px-4 py-2 rounded transition">Cancelar</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded shadow transition">Guardar tarea</button>
      </div>

      <!-- Ocultos requeridos -->
      <input type="hidden" name="cliente_id" value="{{ cliente_id }}">
      <input type="hidden" name="creado_por" value="{{ user.id }}">
      <input type="hidden" name="nombre_nora" value="{{ nombre_nora }}">
      <input type="hidden" name="iniciales_usuario" value="{{ user.nombre[:2]|upper if user.nombre is defined else 'NN' }}">
    </form>
  </div>
</div>
<script>
  // ...existing code...
  // Reemplaza el submit para crear tarea o subtarea seg√∫n el campo tarea_padre_id
  const formNuevaTarea = document.getElementById('formTareaNueva');
  if (formNuevaTarea) {
    formNuevaTarea.onsubmit = function(e) {
      e.preventDefault();
      const data = new FormData(formNuevaTarea);
      const tareaPadreId = data.get('tarea_padre_id');
      let url = `/panel_cliente/${document.body.dataset.nora}/tareas/gestionar/crear`;
      fetch(url, {
        method: 'POST',
        body: data
      })
      .then(r => r.json())
      .then(resp => {
        if (resp.ok) {
          cerrarModalTarea();
          if (tareaPadreId) {
            // Si es subtarea, recarga solo el bloque de subtareas si est√° abierto
            const contenedor = document.getElementById('contenedor-subtareas-' + tareaPadreId);
            const fila = document.getElementById('subtareas-' + tareaPadreId);
            if (contenedor && fila && !fila.classList.contains('hidden')) {
              // Forzar recarga de subtareas
              fila.dataset.cargado = '';
              contenedor.innerHTML = '<span class="text-gray-400">Cargando subtareas...</span>';
              toggleSubtareas(tareaPadreId); // Oculta
              toggleSubtareas(tareaPadreId); // Vuelve a mostrar y recarga
              return;
            }
          }
          // Si es tarea normal o el bloque no est√° abierto, recarga toda la p√°gina
          window.location.reload();
        } else {
          alert(resp.error || 'Error al crear tarea');
        }
      })
      .catch(() => alert('Error de red al crear tarea'));
      return false;
    };
  }
</script>

</body>
