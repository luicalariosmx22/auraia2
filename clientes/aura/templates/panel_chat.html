<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat de Nora ‚Äì {{ nombre_nora }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/panel_chat.css') }}">
  <script>
    const nombreNora = "{{ nombre_nora }}";
  </script>
</head>
<body>
  <div class="chat-wrapper">
    
    <!-- Columna izquierda -->
    <div class="sidebar">
      <div class="search-bar">
        <input type="text" placeholder="üîç Buscar contacto..." oninput="filtrarContactosPorNombre(this.value)">
      </div>
      <div class="filter-bar">
        <select onchange="filtrarContactosPorEtiqueta(this.value)">
          <option value="">Todos</option>
          <option value="Clientes">Clientes</option>
          <option value="VIP">VIP</option>
        </select>
      </div>
      <div class="contact-list" id="lista-contactos">
        <!-- Los contactos se renderizan din√°micamente -->
      </div>
    </div>

    <!-- Chat principal -->
    <div class="chat-main">
      <div class="chat-header">
        <h3 id="contacto-nombre">Selecciona un contacto</h3>
        <span id="contacto-etiquetas"></span>
      </div>
      <div class="chat-body" id="chat-mensajes">
        <p class="placeholder">Selecciona un contacto</p>
      </div>
      <div class="chat-input">
        <input type="text" placeholder="Escribe un mensaje..." id="input-mensaje">
        <button id="btn-enviar">Enviar</button>
      </div>
    </div>

    <!-- Informaci√≥n del contacto -->
    <div class="contact-info">
      <h4>Atributos</h4>
      <p><strong>Tel√©fono:</strong> <span id="contacto-telefono"></span></p>
      <p><strong>Etiquetas:</strong> <span id="contacto-tags"></span></p>
      <div class="toggle-ia">
        <label>IA Activada:</label>
        <input type="checkbox" id="toggle-ia">
      </div>

      <!-- Formulario de env√≠o de mensajes -->
      <h4>Enviar mensaje</h4>
      <form class="form-envio">
        <input type="text" name="mensaje" placeholder="Escribe un mensaje..." />
        <button type="submit">Enviar</button>
      </form>
    </div>

  </div>

  <script>
    // Lista de contactos desde el backend
    const contactos = {{ contactos | tojson }};

    // Renderiza la lista de contactos
    function renderizarContactos() {
      const contenedor = document.getElementById('lista-contactos');
      contenedor.innerHTML = "";

      contactos.forEach(c => {
        const ultimoMensaje = (c.mensajes && c.mensajes.length > 0)
          ? c.mensajes[c.mensajes.length - 1].mensaje.slice(0, 30) + "..."
          : "Sin mensajes a√∫n";

        const item = document.createElement('div');
        item.className = "contacto-item";
        item.innerHTML = `
          <div onclick="seleccionarContacto('${c.telefono}')">
            <strong>${c.nombre || c.telefono}</strong><br>
            <span class="ultimo-mensaje">${ultimoMensaje}</span>
          </div>
        `;
        contenedor.appendChild(item);
      });
    }

    // Funci√≥n para manejar clic en contacto
    function seleccionarContacto(telefono) {
      fetch(`/api/chat/${telefono}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            renderizarChat(data.mensajes);
            document.getElementById('contacto-nombre').innerText = data.contacto.nombre || telefono;
            document.getElementById('contacto-telefono').innerText = data.contacto.telefono;
            document.getElementById('contacto-tags').innerText = (data.contacto.etiquetas || []).join(', ');
            document.getElementById('toggle-ia').checked = !!data.contacto.ia_activada;
          } else {
            document.getElementById('chat-mensajes').innerHTML = "<p class='placeholder'>Error al cargar el historial.</p>";
          }
        });
    }

    // Renderizar mensajes
    function renderizarChat(mensajes) {
      const contenedor = document.getElementById('chat-mensajes');
      contenedor.innerHTML = "";
      mensajes.forEach(m => {
        const msg = document.createElement('div');
        msg.className = m.emisor === "usuario" ? "mensaje usuario" : "mensaje bot";
        msg.innerText = m.mensaje;
        contenedor.appendChild(msg);
      });
    }

    // Inicializar
    renderizarContactos();
  </script>
</body>
</html>
