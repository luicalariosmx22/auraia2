<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Chat - Nora</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/panel_chat.css') }}" />
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script> <!-- Agregado para Socket.IO -->
</head>
<body>
  <div class="chat-container">
    <!-- Sidebar de contactos -->
    <div class="sidebar">
      <h2>Contactos</h2>
      <ul id="lista-contactos">
        {% for contacto in contactos %}
        <li>
          <div class="contacto" id="contacto-{{ contacto.telefono }}" onclick="abrirChat('{{ contacto.telefono }}')">
            <span class="nombre">{{ contacto.nombre or contacto.telefono }}</span>
            <span class="badge" id="badge-{{ contacto.telefono }}" style="display: none;">游댯</span>
          </div>
        </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Panel de conversaci칩n -->
    <div class="chat-box">
      <div class="chat-header">
        <h2 id="nombre-contacto">Selecciona un contacto</h2>
      </div>

      <div id="chat-contenido" class="chat-mensajes">
        <!-- Los mensajes se insertan aqu칤 din치micamente -->
      </div>

      <div class="chat-input">
        <input type="text" id="mensajeInput" placeholder="Escribe un mensaje..." />
        <button onclick="enviarMensaje()">Enviar</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io(); // Inicializar Socket.IO

    let telefonoChatAbierto = null;

    function abrirChat(telefono) {
      telefonoChatAbierto = telefono;

      // Ocultar la notificaci칩n azul si estaba activa
      const badge = document.getElementById(`badge-${telefono}`);
      if (badge) badge.style.display = "none";

      // Aqu칤 puedes cargar el historial o mensajes si no lo est치s haciendo a칰n
      fetch(`/api/chat/${telefono}`)
        .then(res => res.json())
        .then(data => {
          const contenedor = document.getElementById("chat-contenido");
          const nombre = document.getElementById("nombre-contacto");
          nombre.innerText = data.contacto.nombre || data.contacto.telefono;

          contenedor.innerHTML = "";
          data.mensajes.forEach(m => {
            const burbuja = document.createElement("div");
            burbuja.className = m.emisor === "nora" ? "mensaje nora" : "mensaje usuario";
            burbuja.innerHTML = `<span>${m.mensaje}</span><span class="hora">${m.hora || ""}</span>`;
            contenedor.appendChild(burbuja);
          });

          scrollAlFinal();
        });
    }

    socket.on("nuevo_mensaje", function(data) {
      const numero = data.telefono;

      // Si el chat no est치 abierto actualmente
      if (numero !== telefonoChatAbierto) {
        const badge = document.getElementById(`badge-${numero}`);
        if (badge) badge.style.display = "inline-block";
      }

      // Aqu칤 puedes agregar l칩gica para insertar el mensaje en la conversaci칩n activa
      if (numero === telefonoChatAbierto) {
        const contenedor = document.getElementById("chat-contenido");
        const burbuja = document.createElement("div");
        burbuja.className = data.emisor === "nora" ? "mensaje nora" : "mensaje usuario";
        burbuja.innerHTML = `<span>${data.mensaje}</span><span class="hora">${data.hora}</span>`;
        contenedor.appendChild(burbuja);

        scrollAlFinal();
      }
    });

    function scrollAlFinal() {
      const contenedor = document.getElementById("chat-contenido");
      contenedor.scrollTop = contenedor.scrollHeight;
    }

    function enviarMensaje() {
      const input = document.getElementById("mensajeInput");
      const texto = input.value.trim();
      if (!texto || !telefonoChatAbierto) return;

      fetch("/api/enviar-mensaje", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ numero: telefonoChatAbierto, mensaje: texto })
      }).then(() => {
        input.value = "";
        abrirChat(telefonoChatAbierto);
      });
    }
  </script>
</body>
</html>
