<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Chat - Nora</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/panel_chat.css') }}" />
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script> <!-- Agregado para Socket.IO -->
  <style>
    /* Efecto de vibración */
    .vibrar {
      animation: vibrar 0.3s ease-in-out;
    }

    @keyframes vibrar {
      0% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      50% { transform: translateX(2px); }
      75% { transform: translateX(-2px); }
      100% { transform: translateX(0); }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- Sidebar de contactos -->
    <div class="sidebar">
      <h2>Contactos</h2>
      <ul id="lista-contactos">
        {% for contacto in contactos %}
        <li>
          <div class="contacto" id="contacto-{{ contacto.telefono }}" onclick="abrirChat('{{ contacto.telefono }}')">
            <span class="nombre">{{ contacto.nombre or contacto.telefono }}</span>
            <span class="badge" id="badge-{{ contacto.telefono }}" style="display: none;">🔵</span>
          </div>
        </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Panel de conversación -->
    <div class="chat-box">
      <div class="chat-header">
        <h2 id="nombre-contacto">Selecciona un contacto</h2>
      </div>

      <div id="chat-contenido" class="chat-mensajes">
        <!-- Los mensajes se insertan aquí dinámicamente -->
      </div>

      <div class="chat-input">
        <input type="text" id="mensajeInput" placeholder="Escribe un mensaje..." />
        <button onclick="enviarMensaje()">Enviar</button>
      </div>
    </div>
  </div>

  <!-- Detalle del contacto -->
  <div class="contacto-detalle">
    <div class="detalle-header">
      <h3>Detalles del Contacto</h3>
      <button onclick="cerrarDetalle()">✖</button>
    </div>

    <div class="detalle-seccion">
      <label for="etiquetas-container">Etiquetas</label>
      <div id="etiquetas-container" class="etiquetas">
        <!-- Las etiquetas existentes se insertarán aquí dinámicamente -->
      </div>
      <input type="text" id="nueva-etiqueta" placeholder="Agregar nueva etiqueta" />
      <button onclick="agregarEtiqueta()">Agregar</button>
    </div>
  </div>

  <!-- Sonido de notificación -->
  <audio id="notifSound" src="{{ url_for('static', filename='sounds/notificacion.mp3') }}" preload="auto"></audio>

  <script>
    const socket = io(); // Inicializar Socket.IO

    let telefonoChatAbierto = null;

    function abrirChat(telefono) {
      telefonoChatAbierto = telefono;

      // Ocultar la notificación azul si estaba activa
      const badge = document.getElementById(`badge-${telefono}`);
      if (badge) badge.style.display = "none";

      // Cargar historial de mensajes
      fetch(`/api/chat/${telefono}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            contactoActivo = data.contacto; // Guardar el contacto activo
            cargarEtiquetas(data.contacto); // ⬅️ Pasar el contacto a cargarEtiquetas
            // …y cargar mensajes, etc.
            const contenedor = document.getElementById("chat-contenido");
            const nombre = document.getElementById("nombre-contacto");
            nombre.innerText = data.contacto.nombre || data.contacto.telefono;

            contenedor.innerHTML = "";
            data.mensajes.forEach(m => {
              const burbuja = document.createElement("div");
              burbuja.className = m.emisor === "nora" ? "mensaje nora" : "mensaje usuario";
              burbuja.innerHTML = `<span>${m.mensaje}</span><span class="hora">${m.hora || ""}</span>`;
              contenedor.appendChild(burbuja);
            });

            scrollAlFinal();
          }
        });
    }

    socket.on("nuevo_mensaje", function(data) {
      const numero = data.telefono;

      if (numero !== telefonoChatAbierto) {
        const badge = document.getElementById(`badge-${numero}`);
        const contactoDiv = document.getElementById(`contacto-${numero}`);
        const audio = document.getElementById("notifSound");

        if (badge) badge.style.display = "inline-block";
        if (audio) audio.play().catch(e => console.log("🔇 No se pudo reproducir audio:", e));

        if (contactoDiv) {
          contactoDiv.classList.add("vibrar");
          setTimeout(() => contactoDiv.classList.remove("vibrar"), 600);
        }
      }
    });

    function scrollAlFinal() {
      const contenedor = document.getElementById("chat-contenido");
      contenedor.scrollTop = contenedor.scrollHeight;
    }

    function enviarMensaje() {
      const input = document.getElementById("mensajeInput");
      const texto = input.value.trim();
      if (!texto || !telefonoChatAbierto) return;

      fetch("/api/enviar-mensaje", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ numero: telefonoChatAbierto, mensaje: texto })
      }).then(() => {
        input.value = "";
        abrirChat(telefonoChatAbierto);
      });
    }

    let contactoActivo = null;

    function cargarEtiquetas(contacto) {
      contactoActivo = contacto;
      const etiquetas = contacto.etiquetas || [];
      const container = document.getElementById("etiquetas-container");
      container.innerHTML = ""; // Limpiar

      etiquetas.forEach(etiqueta => {
        const span = document.createElement("span");
        span.className = "etiqueta";
        span.textContent = etiqueta;

        // Agregar evento de doble clic para editar la etiqueta
        span.ondblclick = () => editarEtiqueta(span, etiqueta);

        const x = document.createElement("button");
        x.textContent = "❌";
        x.className = "eliminar-etiqueta";
        x.onclick = () => eliminarEtiqueta(etiqueta);

        span.appendChild(x);
        container.appendChild(span);
      });
    }

    function agregarEtiqueta() {
      const nueva = document.getElementById("nueva-etiqueta").value.trim().toLowerCase();
      if (!nueva || !contactoActivo) return;

      fetch(`/api/etiqueta/${contactoActivo.telefono}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ etiqueta: nueva })
      }).then(res => res.json()).then(data => {
        if (data.success) {
          contactoActivo.etiquetas.push(nueva);
          cargarEtiquetas(contactoActivo);
          document.getElementById("nueva-etiqueta").value = "";
        }
      });
    }

    function eliminarEtiqueta(etiqueta) {
      if (!contactoActivo) return;

      fetch(`/api/etiqueta/${contactoActivo.telefono}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ etiqueta })
      }).then(res => res.json()).then(data => {
        if (data.success) {
          contactoActivo.etiquetas = contactoActivo.etiquetas.filter(e => e !== etiqueta);
          cargarEtiquetas(contactoActivo);
        }
      });
    }

    function editarEtiqueta(span, etiquetaActual) {
      const input = document.createElement("input");
      input.type = "text";
      input.value = etiquetaActual;
      input.className = "editar-etiqueta";

      // Reemplazar el contenido del span con el input
      span.innerHTML = "";
      span.appendChild(input);

      // Guardar cambios al perder el foco o presionar Enter
      input.onblur = () => guardarEtiquetaEditada(span, etiquetaActual, input.value.trim());
      input.onkeydown = (e) => {
        if (e.key === "Enter") {
          guardarEtiquetaEditada(span, etiquetaActual, input.value.trim());
        }
      };

      input.focus();
    }

    function guardarEtiquetaEditada(span, etiquetaActual, nuevaEtiqueta) {
      if (!nuevaEtiqueta || nuevaEtiqueta === etiquetaActual) {
        cargarEtiquetas(contactoActivo); // Restaurar etiquetas si no hay cambios
        return;
      }

      // Actualizar etiqueta en el servidor
      fetch(`/api/etiqueta/${contactoActivo.telefono}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ etiqueta: etiquetaActual })
      }).then(() => {
        return fetch(`/api/etiqueta/${contactoActivo.telefono}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ etiqueta: nuevaEtiqueta })
        });
      }).then(res => res.json()).then(data => {
        if (data.success) {
          // Actualizar etiquetas localmente y recargar
          contactoActivo.etiquetas = contactoActivo.etiquetas.filter(e => e !== etiquetaActual);
          contactoActivo.etiquetas.push(nuevaEtiqueta);
          cargarEtiquetas(contactoActivo);
        }
      });
    }
  </script>
</body>
</html>
