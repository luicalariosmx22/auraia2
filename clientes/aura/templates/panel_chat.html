<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat de Nora – {{ nombre_nora }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/panel_chat.css') }}">
  <script>
    const nombreNora = "{{ nombre_nora }}";
  </script>
</head>
<body>
  <div class="chat-wrapper">
    
    <!-- Columna izquierda: Lista de contactos -->
    <aside class="col-izquierda">
      <div class="buscador">
        <input type="text" placeholder="🔍 Buscar contacto..." oninput="filtrarContactosPorNombre(this.value)">
        <select onchange="filtrarContactosPorEtiqueta(this.value)">
          <option value="">🎯 Filtrar por etiqueta</option>
          {% for et in etiquetas %}
          <option value="{{ et }}">{{ et }}</option>
          {% endfor %}
        </select>
      </div>
      <ul class="lista-contactos" id="lista-contactos">
        {% for c in contactos %}
        <li onclick="cargarChat('{{ c.telefono }}')" data-etiquetas="{{ c.etiquetas|join(',') }}">
          <div class="nombre">{{ c.nombre }}</div>
          <div class="numero">{{ c.telefono }}</div>
          <div class="preview">{{ c.mensajes[-1].texto if c.mensajes|length > 0 else '...' }}</div>
        </li>
        {% endfor %}
      </ul>
    </aside>

    <!-- Columna central: Conversación -->
    <section class="col-central">
      <!-- Encabezado del chat -->
      <div class="chat-header">
        <h2 id="nombre-contacto">Selecciona un contacto</h2>
        <p id="numero-contacto"></p>
      </div>

      <!-- Área de chat -->
      <div id="chat-area">
        <p class="placeholder">Selecciona un contacto para comenzar a chatear.</p>
      </div>

      <!-- Botón para cargar más mensajes -->
      <button id="cargar-mas" style="display:none; margin: 10px auto;">🔁 Cargar más mensajes</button>

      <!-- Pie del chat -->
      <div class="chat-footer">
        <p id="resumen-contacto" class="resumen-contacto"></p>
      </div>

      <!-- Formulario de envío -->
      <form class="form-envio" onsubmit="enviarMensaje(event)">
        <input type="text" id="mensaje" placeholder="Escribe un mensaje...">
        <button type="submit">Enviar</button>
      </form>
    </section>

    <!-- Columna derecha: Información del contacto -->
    <aside class="col-derecha" id="col-derecha">
      <div class="info-contacto" id="info-contacto">
        <p>Selecciona un contacto para ver detalles.</p>
      </div>
      <div id="detalles-contacto" style="display: none; padding: 10px;">
        <h3 id="nombre-contacto">Nombre</h3>
        <p id="numero-contacto" class="subinfo"></p>

        <h4>🏷️ Etiquetas:</h4>
        <div id="etiquetas-contacto"></div>
        <form onsubmit="agregarEtiqueta(event)">
          <input type="text" id="nueva-etiqueta" placeholder="Agregar etiqueta...">
          <button type="submit">➕</button>
        </form>

        <h4>📝 Notas:</h4>
        <textarea id="notas-contacto" placeholder="Agregar nota..."></textarea>
        <button onclick="guardarNota()" class="btn-outline" style="margin-top: 6px;">💾 Guardar nota</button>

        <h4>🧠 Resumen:</h4>
        <p id="resumen-contacto" class="resumen-box">Cargando resumen...</p>

        <div style="margin-top: 10px;">
          <button onclick="toggleIAContacto()" id="btn-toggle-ia" class="btn-neutral">Desactivar IA</button>
        </div>
      </div>
    </aside>

  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const contactos = document.querySelectorAll(".contacto");
      const chatArea = document.getElementById("chat-area");

      contactos.forEach((item) => {
        item.addEventListener("click", async () => {
          const numero = item.getAttribute("data-numero");
          console.log(`📞 Intentando cargar historial para el número: ${numero}`);
          try {
            const res = await fetch(`/api/chat/${numero}`);
            const data = await res.json();

            if (!data.success) {
              console.error("❌ Error al cargar historial:", data.error || "Error desconocido");
              chatArea.innerHTML = "<p class='error'>❌ No se pudo cargar el historial.</p>";
              return;
            }

            console.log("✅ Historial cargado con éxito:", data.mensajes);
            chatArea.innerHTML = ""; // Limpiar el área de chat
            data.mensajes.forEach((msg) => {
              const burbuja = document.createElement("div");
              burbuja.classList.add("burbuja", msg.emisor === "bot" ? "nora" : "usuario");
              burbuja.innerText = msg.mensaje;
              chatArea.appendChild(burbuja);
            });
          } catch (error) {
            console.error("❌ Error al intentar cargar el historial:", error);
            chatArea.innerHTML = "<p class='error'>❌ Error al cargar el historial.</p>";
          }
        });
      });
    });
  </script>
</body>
</html>
