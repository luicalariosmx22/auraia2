<!-- Modal para lanzar sincronización manual de Meta Ads -->
<div class="modal fade" id="modalSyncMetaAds" tabindex="-1" aria-labelledby="modalSyncMetaAdsLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formSyncMetaAds" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="modalSyncMetaAdsLabel">Sincronizar Meta Ads Manualmente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="sync_fecha_inicio" class="form-label">Fecha de inicio</label>
            <input type="date" class="form-control" id="sync_fecha_inicio" name="fecha_inicio" required>
          </div>
          <div class="mb-3">
            <label for="sync_fecha_fin" class="form-label">Fecha de fin</label>
            <input type="date" class="form-control" id="sync_fecha_fin" name="fecha_fin" required>
          </div>
          <div class="mb-3">
            <label for="sync_cuentas" class="form-label">Cuentas publicitarias</label>
            <div id="cuentas-list" class="border rounded p-2 bg-gray-50 mb-2" style="max-height:180px;overflow-y:auto;font-size:0.97em"></div>
            <input type="hidden" id="sync_cuentas" name="cuentas">
          </div>
          <div class="mb-3">
            <label for="sync_variables" class="form-label">Variables adicionales (JSON opcional)</label>
            <textarea class="form-control" id="sync_variables" name="variables" rows="2" placeholder='{"campo": "valor"}'></textarea>
            <div class="mt-2">
              <span class="text-xs text-gray-500">Variables disponibles en anuncios_detalle:</span>
              <div id="variables-list" class="border rounded p-2 bg-gray-50 mt-1" style="max-height:120px;overflow-y:auto;font-size:0.97em"></div>
            </div>
          </div>
          <div id="syncMetaAdsStatus" class="text-center text-secondary small"></div>
        </div>
        <div class="modal-footer d-flex flex-wrap gap-2 justify-content-between">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnSyncMetaAds" type="button" class="btn btn-primary">Sincronizar</button>
          <button id="btnPararSyncMetaAds" type="button" class="btn btn-danger">Parar Sincronización</button>
          <button id="btnEliminarAnunciosDetalle" type="button" class="btn btn-warning text-white">Eliminar Anuncios Detalle</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
// Sincronizar
const btnSync = document.getElementById('btnSyncMetaAds');
const btnParar = document.getElementById('btnPararSyncMetaAds');
const btnEliminar = document.getElementById('btnEliminarAnunciosDetalle');
const status = document.getElementById('syncMetaAdsStatus');

function setStatusFeedback({msg, type = 'info', loading = false}) {
  status.innerHTML =
    (loading ? '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>' : '') +
    (type === 'success' ? '<span class="text-success fw-bold">✅ ' :
     type === 'error' ? '<span class="text-danger fw-bold">❌ ' :
     type === 'warning' ? '<span class="text-warning fw-bold">⚠️ ' : '<span>') +
    msg + '</span>';
}

function setButtonsDisabled(disabled) {
  btnSync.disabled = btnParar.disabled = btnEliminar.disabled = disabled;
}

btnSync.onclick = async function() {
  setButtonsDisabled(true);
  setStatusFeedback({msg: 'Sincronizando...', loading: true});
  const form = document.getElementById('formSyncMetaAds');
  const data = new FormData(form);
  try {
    const resp = await fetch('/sincronizar-meta-ads', {
      method: 'POST',
      body: data
    });
    if (resp.ok) {
      setStatusFeedback({msg: 'Sincronización lanzada correctamente.', type: 'success'});
      setTimeout(() => location.reload(), 1200);
    } else {
      const res = await resp.text();
      setStatusFeedback({msg: 'Error: ' + res, type: 'error'});
    }
  } catch (err) {
    setStatusFeedback({msg: 'Error de red: ' + err, type: 'error'});
  }
  setButtonsDisabled(false);
};
// Parar sincronización
btnParar.onclick = async function() {
  setButtonsDisabled(true);
  setStatusFeedback({msg: 'Deteniendo sincronización...', loading: true});
  try {
    const resp = await fetch(`/panel_cliente/${document.body.dataset.nora}/meta_ads/estadisticas/parar_sincronizacion`, {method: 'POST'});
    const data = await resp.json();
    if(data.ok) {
      setStatusFeedback({msg: 'Sincronización detenida.', type: 'success'});
    } else {
      setStatusFeedback({msg: 'Error al detener sincronización: ' + (data.error || 'Error desconocido'), type: 'error'});
    }
  } catch(e) {
    setStatusFeedback({msg: 'Error al detener sincronización: ' + e, type: 'error'});
  }
  setButtonsDisabled(false);
};
// Eliminar anuncios detalle
btnEliminar.onclick = async function() {
  if(!confirm('¿Estás seguro de que deseas eliminar TODOS los registros de anuncios_detalle? Esta acción no se puede deshacer.')) return;
  setButtonsDisabled(true);
  setStatusFeedback({msg: 'Eliminando todos los anuncios detalle...', loading: true});
  try {
    const resp = await fetch(`/panel_cliente/${document.body.dataset.nora}/meta_ads/estadisticas/eliminar_anuncios_detalle`, {method: 'POST'});
    const data = await resp.json();
    if(data.ok) {
      setStatusFeedback({msg: `Anuncios detalle eliminados: ${data.eliminados}`, type: 'success'});
    } else {
      setStatusFeedback({msg: 'Error al eliminar anuncios detalle: ' + (data.error || 'Error desconocido'), type: 'error'});
    }
  } catch(e) {
    setStatusFeedback({msg: 'Error al eliminar anuncios detalle: ' + e, type: 'error'});
  }
  setButtonsDisabled(false);
};
// Evita submit automático del formulario
const formSync = document.getElementById('formSyncMetaAds');
formSync.onsubmit = function(e) { e.preventDefault(); };
// --- Cargar cuentas y variables dinámicamente al abrir el modal ---
const modal = document.getElementById('modalSyncMetaAds');
modal.addEventListener('show.bs.modal', async function() {
  // Cargar cuentas
  const cuentasDiv = document.getElementById('cuentas-list');
  cuentasDiv.innerHTML = '<span class="text-secondary">Cargando cuentas...</span>';
  try {
    const resp = await fetch(`/panel_cliente/${document.body.dataset.nora}/meta_ads/estadisticas/cuentas_json`);
    const data = await resp.json();
    if(data.ok && Array.isArray(data.cuentas)) {
      cuentasDiv.innerHTML = data.cuentas.length ? data.cuentas.map(c =>
        `<label class='d-block'><input type='checkbox' class='cuenta-checkbox' value='${c.id_cuenta_publicitaria}'> ${c.nombre_cliente || c.id_cuenta_publicitaria}</label>`
      ).join('') : '<span class="text-danger">No hay cuentas configuradas.</span>';
    } else {
      cuentasDiv.innerHTML = '<span class="text-danger">Error al cargar cuentas.</span>';
    }
  } catch(e) {
    cuentasDiv.innerHTML = '<span class="text-danger">Error de red.</span>';
  }
  // Cargar variables
  const varsDiv = document.getElementById('variables-list');
  varsDiv.innerHTML = '<span class="text-secondary">Cargando variables...</span>';
  try {
    const resp = await fetch(`/panel_cliente/${document.body.dataset.nora}/meta_ads/estadisticas/variables_json`);
    const data = await resp.json();
    if(data.ok && Array.isArray(data.variables)) {
      varsDiv.innerHTML = data.variables.length ? data.variables.map(v => `<span class='badge bg-light text-dark border me-1 mb-1'>${v}</span>`).join('') : '<span class="text-danger">No hay variables.</span>';
    } else {
      varsDiv.innerHTML = '<span class="text-danger">Error al cargar variables.</span>';
    }
  } catch(e) {
    varsDiv.innerHTML = '<span class="text-danger">Error de red.</span>';
  }
});
// Guardar selección de cuentas en el input oculto
const cuentasDiv = document.getElementById('cuentas-list');
if (cuentasDiv) {
  cuentasDiv.addEventListener('change', function() {
    const seleccionadas = Array.from(document.querySelectorAll('.cuenta-checkbox:checked')).map(cb => cb.value);
    document.getElementById('sync_cuentas').value = seleccionadas.join(',');
  });
}
</script>
