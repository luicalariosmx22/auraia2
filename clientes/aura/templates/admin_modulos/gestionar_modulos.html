{% extends "base_admin_horizontal.html" %}
{% block titulo %}Gestionar m√≥dulos{% endblock %}

{% block contenido %}
<div class="container mx-auto px-6 py-8 max-w-5xl">
  <h1 class="text-2xl font-bold mb-6">üì¶ Gesti√≥n avanzada de m√≥dulos Nora</h1>

  <p class="text-gray-600 mb-4 text-sm">
    Aqu√≠ puedes ver todos los m√≥dulos disponibles, editar su configuraci√≥n, revisar en qu√© Noras est√°n activados y agregar subm√≥dulos, botones u otros recursos relacionados.
  </p>

  <div class="bg-white rounded shadow overflow-hidden border border-gray-200">
    <table class="min-w-full divide-y divide-gray-200 text-sm">
      <thead class="bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
        <tr>
          <th class="px-4 py-3">üß© M√≥dulo</th>
          <th class="px-4 py-3">Descripci√≥n</th>
          <th class="px-4 py-3">Ruta</th>
          <th class="px-4 py-3">Noras activadas</th>
          <th class="px-4 py-3">Acciones</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-100">
        {% for modulo in modulos %}
        <tr>
          <td class="px-4 py-3 font-medium text-gray-800">
            {{ modulo.icono or 'üß©' }} {{ modulo.nombre }}
          </td>
          <td class="px-4 py-3 text-gray-700">{{ modulo.descripcion or '‚Äî' }}</td>
          <td class="px-4 py-3 font-mono text-xs text-gray-500">{{ modulo.ruta }}</td>
          <td class="px-4 py-3">
            {% set conteo = 0 %}
            {% for cfg in configuraciones %}
              {% if cfg.modulos is defined and modulo.nombre in cfg.modulos %}
                {% set conteo = conteo + 1 %}
              {% endif %}
            {% endfor %}
            {{ conteo }}
          </td>
          <td class="px-4 py-3 space-x-2">
            <button class="text-blue-600 hover:underline text-xs">‚ûï Subm√≥dulo</button>
            <button class="text-green-600 hover:underline text-xs">üé® Botones</button>
            <button class="text-gray-500 hover:underline text-xs" onclick="abrirModalEditar('{{ modulo.id }}', '{{ modulo.nombre }}', '{{ modulo.descripcion|default('') }}', '{{ modulo.icono|default('üß©') }}')">‚úèÔ∏è Editar</button>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="px-4 py-6 text-center text-gray-500">No hay m√≥dulos registrados.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Modal de edici√≥n de m√≥dulo -->
  <div id="modal-editar" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
      <button onclick="cerrarModalEditar()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
      <h2 class="text-lg font-bold mb-4">Editar m√≥dulo</h2>
      <form id="form-editar-modulo" method="post" action="#" onsubmit="return enviarEdicionModulo();">
        <input type="hidden" id="editar-id" name="id">
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
          <input type="text" id="editar-nombre" name="nombre" class="w-full border rounded px-3 py-2" required>
        </div>
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
          <textarea id="editar-descripcion" name="descripcion" class="w-full border rounded px-3 py-2"></textarea>
        </div>
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Icono</label>
          <input type="text" id="editar-icono" name="icono" class="w-full border rounded px-3 py-2" maxlength="2">
        </div>
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" onclick="cerrarModalEditar()" class="px-4 py-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300">Cancelar</button>
          <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>

  <div class="mt-6 text-right">
    <a href="/admin/creador_modulos/crear" class="inline-flex items-center gap-1 px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded hover:bg-indigo-700">
      ‚ûï Crear nuevo m√≥dulo
    </a>
  </div>
</div>
</div>
<script>
function abrirModalEditar(id, nombre, descripcion, icono) {
  document.getElementById('modal-editar').classList.remove('hidden');
  document.getElementById('editar-id').value = id;
  document.getElementById('editar-nombre').value = nombre;
  document.getElementById('editar-descripcion').value = descripcion;
  document.getElementById('editar-icono').value = icono;
}
function cerrarModalEditar() {
  document.getElementById('modal-editar').classList.add('hidden');
}

async function enviarEdicionModulo() {
  const id = document.getElementById('editar-id').value;
  const nombre = document.getElementById('editar-nombre').value;
  const descripcion = document.getElementById('editar-descripcion').value;
  const icono = document.getElementById('editar-icono').value;

  const btn = document.querySelector('#form-editar-modulo button[type="submit"]');
  btn.disabled = true;
  btn.textContent = 'Guardando...';

  try {
    const resp = await fetch(window.location.origin + '/admin/creador_modulos/editar_modulo', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, nombre, descripcion, icono })
    });
    const data = await resp.json();
    if (data.success) {
      btn.textContent = '¬°Guardado!';
      setTimeout(() => { location.reload(); }, 800);
    } else {
      btn.textContent = 'Guardar cambios';
      alert(data.error || 'Error al guardar');
    }
  } catch (e) {
    btn.textContent = 'Guardar cambios';
    alert('Error de red o servidor');
  }
  btn.disabled = false;
  return false;
}
</script>
{% endblock %}
