{% extends "base_admin_horizontal.html" %}

{% block titulo %}üß© Gestionar M√≥dulos{% endblock %}

{% block contenido %}
<div class="container mx-auto px-4 py-8">
  <!-- Navegaci√≥n -->
  <nav class="flex items-center space-x-2 text-sm text-gray-600 mb-6">
    <a href="{{ url_for('verificador_modulos.index') }}" class="hover:text-blue-600">üì¶ M√≥dulos</a>
    <span>‚Üí</span>
    <span class="text-gray-900 font-medium">üß© Gestionar</span>
  </nav>

  <div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold text-gray-900">üß© Gesti√≥n de M√≥dulos</h1>
    <a href="{{ url_for('admin_creador_modulos.crear_modulo') }}" 
       class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">
      ‚ûï Crear Nuevo M√≥dulo
    </a>
  </div>

  <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            üß© M√≥dulo
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Descripci√≥n
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Ruta
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Noras Activadas
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Acciones
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for modulo in modulos %}
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <span class="text-2xl mr-3">{{ modulo.icono or 'üß©' }}</span>
              <div>
                <div class="text-sm font-medium text-gray-900">{{ modulo.nombre }}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-gray-900">{{ modulo.descripcion or '‚Äî' }}</div>
          </td>
          <td class="px-6 py-4">
            <div class="text-xs font-mono text-gray-500 bg-gray-100 px-2 py-1 rounded">
              {{ modulo.ruta }}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            {% set conteo = 0 %}
            {% for cfg in configuraciones %}
              {% if cfg.modulos and cfg.modulos is mapping and modulo.nombre in cfg.modulos and cfg.modulos[modulo.nombre] %}
                {% set conteo = conteo + 1 %}
              {% endif %}
            {% endfor %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                  {% if conteo > 0 %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-600{% endif %}">
              {{ conteo }} Nora{{ 's' if conteo != 1 else '' }}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
            <button class="text-blue-600 hover:text-blue-900 btn-editar"
                    data-id="{{ modulo.id }}"
                    data-nombre="{{ modulo.nombre }}"
                    data-descripcion="{{ modulo.descripcion|default('', true) }}"
                    data-icono="{{ modulo.icono|default('üß©', true) }}">
              ‚úèÔ∏è Editar
            </button>
            <button class="text-red-600 hover:text-red-900 btn-eliminar"
                    data-id="{{ modulo.id }}"
                    data-nombre="{{ modulo.nombre }}">
              üóëÔ∏è Eliminar
            </button>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="px-6 py-12 text-center text-gray-500">
            <div class="text-center">
              <span class="text-6xl mb-4 block">üì¶</span>
              <h3 class="text-lg font-medium text-gray-900 mb-2">No hay m√≥dulos registrados</h3>
              <p class="text-gray-500 mb-4">Crea tu primer m√≥dulo para comenzar</p>
              <a href="{{ url_for('admin_creador_modulos.crear_modulo') }}" 
                 class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                ‚ûï Crear M√≥dulo
              </a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal de Edici√≥n -->
<div id="modalEditar" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-gray-900 mb-4">‚úèÔ∏è Editar M√≥dulo</h3>
      <form id="formEditar">
        <input type="hidden" id="editarId" name="id">
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Nombre:</label>
          <input type="text" id="editarNombre" name="nombre" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n:</label>
          <textarea id="editarDescripcion" name="descripcion" rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Icono:</label>
          <input type="text" id="editarIcono" name="icono" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                 placeholder="üß©">
        </div>
        
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="cerrarModalEditar()" 
                  class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
            Cancelar
          </button>
          <button type="submit" 
                  class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function abrirModalEditar(id, nombre, descripcion, icono) {
  document.getElementById('editarId').value = id;
  document.getElementById('editarNombre').value = nombre;
  document.getElementById('editarDescripcion').value = descripcion || '';
  document.getElementById('editarIcono').value = icono || 'üß©';
  document.getElementById('modalEditar').classList.remove('hidden');
}

function cerrarModalEditar() {
  document.getElementById('modalEditar').classList.add('hidden');
}

document.getElementById('formEditar').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  
  try {
    const response = await fetch('{{ url_for("admin_creador_modulos.editar_modulo") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('‚úÖ M√≥dulo actualizado correctamente');
      location.reload();
    } else {
      alert('‚ùå Error: ' + (result.error || 'No se pudo actualizar el m√≥dulo'));
    }
  } catch (e) {
    alert('‚ùå Error de conexi√≥n: ' + e.message);
  }
});

async function confirmarEliminarModulo(id, nombre) {
  const confirmacion = confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar el m√≥dulo "${nombre}"?\n\nEsta acci√≥n:\n‚Ä¢ Eliminar√° el m√≥dulo de la base de datos\n‚Ä¢ Lo desactivar√° de todas las Noras\n‚Ä¢ Borrar√° los archivos del backend\n‚Ä¢ No se puede deshacer\n\n¬øContinuar?`);
  
  if (!confirmacion) return;
  
  // Deshabilitar bot√≥n
  const btn = event.target;
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'üîÑ Eliminando...';
  btn.classList.add('opacity-50');
  
  try {
    const resp = await fetch('{{ url_for("admin_creador_modulos.eliminar_modulo") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, nombre })
    });
    
    const data = await resp.json();
    
    if (data.success) {
      alert('‚úÖ ' + (data.message || `M√≥dulo "${nombre}" eliminado correctamente`));
      location.reload();
    } else {
      alert('‚ùå Error: ' + (data.error || 'No se pudo eliminar el m√≥dulo'));
      btn.disabled = false;
      btn.textContent = originalText;
      btn.classList.remove('opacity-50');
    }
  } catch (e) {
    alert('‚ùå Error de conexi√≥n: ' + e.message);
    btn.disabled = false;
    btn.textContent = originalText;
    btn.classList.remove('opacity-50');
  }
}

// Event listeners para botones con atributos data
document.addEventListener('DOMContentLoaded', function() {
  // Botones editar
  document.querySelectorAll('.btn-editar').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      const nombre = this.dataset.nombre;
      const descripcion = this.dataset.descripcion;
      const icono = this.dataset.icono;
      abrirModalEditar(id, nombre, descripcion, icono);
    });
  });
  
  // Botones eliminar
  document.querySelectorAll('.btn-eliminar').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      const nombre = this.dataset.nombre;
      confirmarEliminarModulo(id, nombre);
    });
  });
});

// Cerrar modal al hacer clic fuera
document.getElementById('modalEditar').addEventListener('click', function(e) {
  if (e.target === this) {
    cerrarModalEditar();
  }
});
</script>
{% endblock %}
