<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat - Nora AI</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/panel_chat.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/flash_messages.css') }}">
</head>
<body>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="sidebar">
    <div class="panel-botones-top">
      <a href="{{ url_for('main.index') }}">‚¨ÖÔ∏è Volver</a>
      <button class="campanita" title="Sonido">üîî</button>
    </div>

    <form action="{{ url_for('panel_chat.filter_etiquetas') }}" method="get" class="form-filtro">
      <label for="etiqueta">Filtrar por etiqueta:</label>
      <select name="etiqueta" id="etiqueta">
        <option value="">Todas las conversaciones</option>
        {% for etiqueta in etiquetas_disponibles %}
          <option value="{{ etiqueta }}" {% if etiqueta == etiqueta_filtrada %}selected{% endif %}>{{ etiqueta }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="btn-filtrar">Filtrar</button>
      {% if etiqueta_filtrada %}
        <a href="{{ url_for('panel_chat.panel_chat') }}" class="btn-limpiar">Limpiar</a>
      {% endif %}
    </form>

    {% for numero in contactos %}
      <div class="contacto {% if numero == seleccionado %}activo{% endif %}" data-numero="{{ numero }}">
        <div class="contacto-content">
          <a href="{{ url_for('panel_chat.panel_chat', numero=numero) }}" class="contacto-link">
            <div class="avatar">
              {% if numero in nombres %}
                {{ nombres[numero][0]|upper }}{% if nombres[numero].split(' ')|length > 1 %}{{ nombres[numero].split(' ')[1][0]|upper }}{% endif %}
              {% else %}
                SN
              {% endif %}
            </div>
            <div class="contacto-info">
              <strong>{{ nombres[numero] if numero in nombres else 'Sin nombre' }}</strong>
              <small class="numero-telefono">{{ numero }}</small>
              <div class="etiquetas-container">
                {% for etiqueta in etiquetas.get(numero, []) %}
                  <span class="etiqueta">{{ etiqueta }}</span>
                {% endfor %}
              </div>
            </div>
          </a>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="chat">
    <div class="encabezado">
      <img src="{{ url_for('static', filename='nora_logo.png') }}" alt="Nora AI" class="logo">
      <h2>Nora AI Bot</h2>
    </div>

    <div class="mensajes" id="mensajes">
      {% for m in mensajes %}
        <div class="mensaje {{ m.tipo }}">
          <div class="texto-mensaje">
            <strong>{{ m.nombre if m.nombre else m.remitente }}:</strong> {{ m.mensaje }}
          </div>
          <div class="hora">{{ m.timestamp.replace("T", " ")[:16] }}</div>
        </div>
      {% endfor %}
    </div>

    {% if seleccionado %}
      <form class="formulario" id="formularioRespuesta" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" id="numero" value="{{ seleccionado }}">
        <input type="text" id="respuesta" placeholder="Escribe un mensaje..." required>
        <button type="submit">Enviar</button>
      </form>
    {% endif %}
  </div>

  {% if seleccionado %}
  <div class="contacto-detalle">
    <h3>{{ nombres[seleccionado] if seleccionado in nombres else 'Sin nombre' }}</h3>
    <div class="campo"><strong>N√∫mero:</strong> {{ seleccionado }}</div>

    <div class="campo">
      <form action="{{ url_for('panel_chat.toggle_ia', numero=seleccionado) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn-toggle-ia {% if not ia_estado_contactos[seleccionado] %}desactivado{% endif %}">
          {% if ia_estado_contactos[seleccionado] %}Desactivar IA{% else %}Activar IA{% endif %}
        </button>
      </form>
    </div>

    <div class="campo">
      <strong>Etiquetas:</strong>
      <div class="etiquetas-container">
        {% for etiqueta in etiquetas.get(seleccionado, []) %}
          <form action="{{ url_for('panel_chat.eliminar_etiqueta', numero=seleccionado, etiqueta=etiqueta) }}" method="post" class="form-etiqueta-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <span class="etiqueta">
              {{ etiqueta }}
              <button type="submit" class="btn-etiqueta-delete" title="Eliminar etiqueta">‚úñ</button>
            </span>
          </form>
        {% endfor %}
      </div>
    </div>

    <form action="{{ url_for('panel_chat.add_etiqueta', numero=seleccionado) }}" method="post" class="etiqueta-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <select name="nueva_etiqueta" required>
        <option value="" disabled selected>+ Etiqueta</option>
        {% for etiqueta in etiquetas_disponibles %}
          <option value="{{ etiqueta }}">{{ etiqueta }}</option>
        {% endfor %}
      </select>
      <button type="submit">‚ûï</button>
    </form>

    <div class="campo notas">
      <form action="{{ url_for('panel_chat.guardar_nota', numero=seleccionado) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label for="nota"><strong>Notas:</strong></label>
        <textarea name="nota" id="nota" placeholder="Escribe una nota...">{{ notas.get(seleccionado, '') }}</textarea>
        {% if notas_modificadas.get(seleccionado) %}
          <small>üïí √öltima modificaci√≥n: {{ notas_modificadas[seleccionado] }}</small>
        {% endif %}
        <button type="submit">üíæ Guardar Nota</button>
      </form>
    </div>
  </div>
  {% endif %}

  <script>
    const socket = io();

    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('formularioRespuesta');
      if (!form) return;

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        const input = document.getElementById('respuesta');
        const numero = document.getElementById('numero').value;
        const mensaje = input.value.trim();
        if (mensaje === '') return;

        socket.emit('enviar_mensaje', {
          mensaje: mensaje,
          numero: numero
        });

        agregarMensaje("T√∫", mensaje, 'enviado');
        input.value = '';
      });
    });

    socket.on('nuevo_mensaje', function (data) {
      if (data) {
        const nombre = data.remitente === 'bot' ? 'Nora AI' : (data.nombre || data.remitente);
        agregarMensaje(nombre, data.mensaje, 'recibido');
      }
    });

    function agregarMensaje(nombre, texto, tipo) {
      const contenedor = document.getElementById('mensajes');
      const mensaje = document.createElement('div');
      mensaje.className = `mensaje ${tipo}`;
      mensaje.innerHTML = `
        <div class="texto-mensaje"><strong>${nombre}:</strong> ${texto}</div>
        <div class="hora">${nuevaHora()}</div>
      `;
      contenedor.appendChild(mensaje);
      contenedor.scrollTop = contenedor.scrollHeight;
    }

    function nuevaHora() {
      const ahora = new Date();
      return ahora.toISOString().replace("T", " ").substring(0, 16);
    }
  </script>
</body>
</html>
