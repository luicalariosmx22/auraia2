<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat - Nora AI</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/panel_chat.css') }}">
</head>
<body>
  <div class="chat-container">
    <div class="sidebar">
      <div class="sidebar-header">
        <img src="{{ url_for('static', filename='nora_logo.png') }}" alt="Logo" class="logo">
        <h3>Nora AI</h3>
        <a href="{{ url_for('main.index') }}" class="btn-volver">← Panel</a>
      </div>

      <form action="{{ url_for('panel_chat.filter_etiquetas') }}" method="get" class="filtro-form">
        <select name="etiqueta" onchange="this.form.submit()">
          <option value="">Todas las conversaciones</option>
          {% for etiqueta in etiquetas_disponibles %}
            <option value="{{ etiqueta }}" {% if etiqueta == etiqueta_filtrada %}selected{% endif %}>{{ etiqueta }}</option>
          {% endfor %}
        </select>
      </form>

      <div class="contactos-lista">
        {% for numero in contactos %}
          <a href="{{ url_for('panel_chat.panel_chat', numero=numero) }}" class="contacto {% if numero == seleccionado %}activo{% endif %}">
            <div class="avatar">
              {% if numero in nombres %}
                {{ nombres[numero][0]|upper }}{% if nombres[numero].split(' ')|length > 1 %}{{ nombres[numero].split(' ')[1][0]|upper }}{% endif %}
              {% else %}NA{% endif %}
            </div>
            <div class="info">
              <strong>{{ nombres[numero] if numero in nombres else 'Sin nombre' }}</strong>
              <small>{{ numero }}</small>
              <div class="etiquetas">
                {% for etiqueta in etiquetas.get(numero, []) %}
                  <span class="etiqueta">{{ etiqueta }}</span>
                {% endfor %}
              </div>
            </div>
          </a>
        {% endfor %}
      </div>
    </div>

    <div class="chat-area">
      {% if seleccionado %}
        <div class="chat-header">
          <div class="nombre-contacto">
            <h3>{{ nombres[seleccionado] if seleccionado in nombres else seleccionado }}</h3>
            <span class="estado-ia {% if not ia_estado_contactos[seleccionado] %}desactivado{% endif %}">
              {% if ia_estado_contactos[seleccionado] %}IA activada{% else %}IA desactivada{% endif %}
            </span>
          </div>

          <form method="post" action="{{ url_for('panel_chat.toggle_ia', numero=seleccionado) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn-toggle-ia">
              {% if ia_estado_contactos[seleccionado] %}Desactivar IA{% else %}Activar IA{% endif %}
            </button>
          </form>

          <form method="post" action="{{ url_for('panel_chat.add_etiqueta', numero=seleccionado) }}" class="form-etiqueta">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <select name="nueva_etiqueta" required>
              {% for etiqueta in etiquetas_disponibles %}
                <option value="{{ etiqueta }}">{{ etiqueta }}</option>
              {% endfor %}
            </select>
            <button type="submit">Agregar</button>
          </form>
        </div>

        <div class="mensajes" id="mensajes">
          {% for m in mensajes %}
            <div class="mensaje {{ m.tipo }}">
              <div class="contenido">
                <strong>{{ m.nombre if m.nombre else m.remitente }}:</strong> {{ m.mensaje }}
              </div>
              <div class="hora">{{ m.timestamp.replace("T", " ")[:16] }}</div>
            </div>
          {% endfor %}
        </div>

        <form class="formulario" id="formularioRespuesta" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" id="numero" value="{{ seleccionado }}">
          <input type="text" id="respuesta" placeholder="Escribe un mensaje..." required>
          <button type="submit">Enviar</button>
        </form>
      {% else %}
        <div class="no-chat">
          <p>Selecciona un contacto para comenzar</p>
        </div>
      {% endif %}
    </div>
  </div>

  <script>
    const socket = io();

    document.getElementById('formularioRespuesta')?.addEventListener('submit', e => {
      e.preventDefault();
      const input = document.getElementById('respuesta');
      const numero = document.getElementById('numero').value;
      const mensaje = input.value.trim();
      if (mensaje === '') return;

      socket.emit('enviar_mensaje', { mensaje, numero });
      agregarMensaje("Tú", mensaje, 'enviado');
      input.value = '';
    });

    socket.on('nuevo_mensaje', data => {
      if (data) {
        const nombre = data.remitente === 'bot' ? 'Nora AI' : (data.nombre || data.remitente);
        agregarMensaje(nombre, data.mensaje, 'recibido');
      }
    });

    function agregarMensaje(nombre, texto, tipo) {
      const contenedor = document.getElementById('mensajes');
      const mensaje = document.createElement('div');
      mensaje.className = `mensaje ${tipo}`;
      mensaje.innerHTML = `<div class="contenido"><strong>${nombre}:</strong> ${texto}</div><div class="hora">${nuevaHora()}</div>`;
      contenedor.appendChild(mensaje);
      contenedor.scrollTop = contenedor.scrollHeight;
    }

    function nuevaHora() {
      const ahora = new Date();
      return ahora.toISOString().replace("T", " ").substring(0, 16);
    }
  </script>
</body>
</html>
