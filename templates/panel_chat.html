<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat - Nora AI</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/panel_chat.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/flash_messages.css') }}">
  <style>
    .btn {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 8px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .btn-filtrar {
      background-color: #4a90e2;
      color: white;
    }
    .btn-limpiar {
      background-color: #e0e0e0;
      color: #333;
      text-decoration: none;
    }
    .btn-toggle-ia {
      background-color: #e0e0e0;
      color: #333;
      padding: 8px 20px;
    }
    .btn-toggle-ia.desactivado {
      background-color: #ff4f4f;
      color: white;
    }
    .btn-toggle-ia {
      background-color: #4e9c7f;
      color: white;
    }
  </style>
</head>
<body>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="sidebar">
    <div class="panel-botones-top">
      <a href="{{ url_for('main.index') }}" class="btn">‚¨ÖÔ∏è Volver</a>
      <button class="campanita" id="notificaciones-toggle" title="Sonido">üîî</button>
    </div>

    <form action="{{ url_for('panel_chat.filter_etiquetas') }}" method="get" class="form-filtro">
      <label for="etiqueta">Filtrar por etiqueta:</label>
      <select name="etiqueta" id="etiqueta">
        <option value="">Todas las conversaciones</option>
        {% for etiqueta in etiquetas_disponibles %}
          <option value="{{ etiqueta }}" {% if etiqueta == etiqueta_filtrada %}selected{% endif %}>{{ etiqueta }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="btn-filtrar">Filtrar</button>
      {% if etiqueta_filtrada %}
        <a href="{{ url_for('panel_chat.panel_chat') }}" class="btn-limpiar">Limpiar</a>
      {% endif %}
    </form>

    {% for numero in contactos %}
      <div class="contacto {% if numero == seleccionado %}activo{% endif %}" data-numero="{{ numero }}">
        <div class="contacto-content">
          <a href="{{ url_for('panel_chat.panel_chat', numero=numero) }}" class="contacto-link">
            <div class="avatar">
              {% set nombre_contacto = nombres[numero] if numero in nombres and nombres[numero] else 'Sin nombre' %}
              {% set partes = nombre_contacto.split(' ') %}
              {{ partes[0][0]|upper }}{% if partes|length > 1 %}{{ partes[1][0]|upper }}{% endif %}
            </div>
            <div class="contacto-info">
              <strong>{{ nombres[numero] if numero in nombres else 'Sin nombre' }}</strong>
              <small class="numero-telefono">{{ numero }}</small>
              <div class="etiquetas-container">
                {% for etiqueta in etiquetas.get(numero, []) %}
                  <span class="etiqueta">{{ etiqueta }}</span>
                {% endfor %}
              </div>
            </div>
          </a>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="chat">
    <div class="encabezado">
      <img src="{{ url_for('static', filename='nora_logo.png') }}" alt="Nora AI" class="logo">
      <h2>Nora AI Bot</h2>
    </div>

    <div class="mensajes" id="mensajes">
      {% for m in mensajes %}
        <div class="mensaje {{ m.tipo }}">
          <div class="texto-mensaje">
            <strong>{{ m.nombre if m.nombre else m.remitente }}:</strong> {{ m.mensaje }}
          </div>
          <div class="hora">{{ m.timestamp.replace("T", " ")[:16] }}</div>
        </div>
      {% endfor %}
    </div>

    {% if seleccionado %}
      <form class="formulario" id="formularioRespuesta" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" id="numero" name="numero" value="{{ seleccionado }}">
        <input type="text" id="respuesta" name="respuesta" placeholder="Escribe un mensaje..." required>
        <input type="file" id="archivo" name="archivo">
        <button type="submit">Enviar</button>
      </form>
    {% endif %}
  </div>

  {% if seleccionado %}
  <div class="contacto-detalle">
    <form action="{{ url_for('panel_chat.actualizar_nombre', numero=seleccionado) }}" method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <label><strong>Nombre:</strong></label>
      <input type="text" name="nuevo_nombre" value="{{ nombres[seleccionado] if seleccionado in nombres else '' }}">
      <button type="submit">‚úèÔ∏è Actualizar</button>
    </form>
    <div class="campo"><strong>N√∫mero:</strong> {{ seleccionado }}</div>
    <div class="campo">
      <form action="{{ url_for('panel_chat.toggle_ia', numero=seleccionado) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn-toggle-ia {% if not ia_estado_contactos[seleccionado] %}desactivado{% endif %}">
          {% if ia_estado_contactos[seleccionado] %}Desactivar IA{% else %}Activar IA{% endif %}
        </button>
      </form>
    </div>
    <div class="campo">
      <strong>Etiquetas:</strong>
      <div class="etiquetas-container">
        {% for etiqueta in etiquetas.get(seleccionado, []) %}
          <form action="{{ url_for('panel_chat.eliminar_etiqueta', numero=seleccionado, etiqueta=etiqueta) }}" method="post" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <span class="etiqueta">
              {{ etiqueta }}
              <button type="submit" class="btn-etiqueta-delete" title="Eliminar etiqueta">‚ùå</button>
            </span>
          </form>
        {% endfor %}
      </div>
    </div>
    <form action="{{ url_for('panel_chat.add_etiqueta', numero=seleccionado) }}" method="post" class="etiqueta-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <select name="nueva_etiqueta" required>
        <option value="" disabled selected>+ Etiqueta</option>
        {% for etiqueta in etiquetas_disponibles %}
          <option value="{{ etiqueta }}">{{ etiqueta }}</option>
        {% endfor %}
      </select>
      <button type="submit">‚ûï</button>
    </form>
    <div class="campo notas">
      <form action="{{ url_for('panel_chat.guardar_nota', numero=seleccionado) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label for="nota"><strong>Notas:</strong></label>
        <textarea name="nota" id="nota" placeholder="Escribe una nota...">{{ notas.get(seleccionado, '') }}</textarea>
        {% if notas_modificadas.get(seleccionado) %}
          <small>üïí √öltima modificaci√≥n: {{ notas_modificadas[seleccionado] }}</small>
        {% endif %}
        <button type="submit">üíæ Guardar Nota</button>
      </form>
    </div>
  </div>
  {% endif %}

  <script>
    const socket = io();
    let sonidoHabilitado = true;

    document.getElementById('notificaciones-toggle').addEventListener('click', function () {
      sonidoHabilitado = !sonidoHabilitado;
      this.textContent = sonidoHabilitado ? 'üîî' : 'üîï';
    });

    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('formularioRespuesta');
      if (!form) return;

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        const input = document.getElementById('respuesta');
        const fileInput = document.getElementById('archivo');
        const numero = document.getElementById('numero').value;
        const mensaje = input.value.trim();
        const archivo = fileInput.files[0];
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;

        if (!mensaje && !archivo) return;

        const formData = new FormData();
        formData.append('numero', numero);
        formData.append('respuesta', mensaje);
        formData.append('csrf_token', csrfToken);
        if (archivo) {
          formData.append('archivo', archivo);
        }

        fetch('/api/enviar_mensaje', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            if (mensaje) {
              agregarMensaje("T√∫", mensaje, 'enviado');
              input.value = '';
            }
            fileInput.value = '';
          } else {
            alert('‚ùå Error al enviar el mensaje');
          }
        })
        .catch(err => {
          console.error(err);
          alert('‚ùå Error de red al enviar el mensaje');
        });
      });
    });

    socket.on('nuevo_mensaje', function (data) {
      if (data) {
        const nombre = data.remitente === 'bot' ? 'Nora AI' : (data.nombre || data.remitente);
        agregarMensaje(nombre, data.mensaje, 'recibido');
        if (sonidoHabilitado) {
          const audio = new Audio("/static/sonidos/notificacion.mp3");
          audio.play();
        }
      }
    });

    function agregarMensaje(nombre, texto, tipo) {
      const contenedor = document.getElementById('mensajes');
      const mensaje = document.createElement('div');
      mensaje.className = `mensaje ${tipo}`;
      mensaje.innerHTML = `
        <div class="texto-mensaje"><strong>${nombre}:</strong> ${texto}</div>
        <div class="hora">${nuevaHora()}</div>
      `;
      contenedor.appendChild(mensaje);
      contenedor.scrollTop = contenedor.scrollHeight;
    }

    function nuevaHora() {
      const ahora = new Date();
      return ahora.toISOString().replace("T", " ").substring(0, 16);
    }
  </script>
</body>
</html>
